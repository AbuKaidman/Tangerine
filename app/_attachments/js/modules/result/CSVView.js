// Generated by CoffeeScript 1.3.3
var CSVView,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

CSVView = (function(_super) {

  __extends(CSVView, _super);

  function CSVView() {
    return CSVView.__super__.constructor.apply(this, arguments);
  }

  CSVView.prototype.initialize = function(options) {
    var allResults,
      _this = this;
    this.assessmentId = Utils.cleanURL(options.assessmentId);
    allResults = new Results;
    allResults.fetch({
      key: this.assessmentId,
      success: function(collection) {
        _this.results = collection.models;
        return _this.render();
      }
    });
    this.disallowedKeys = ["mark_record"];
    return this.metaKeys = ["enumerator", "starttime", "timestamp"];
  };

  CSVView.prototype.render = function() {
    var count, csvFile, d, exportValue, i, index, item, keys, label, maxIndex, maxLength, metaKey, monthData, months, observationData, observations, optionKey, optionValue, prototype, result, resultDataArray, row, subtest, subtestName, surveyValue, surveyVariable, tableHTML, values, variableName, _i, _j, _k, _l, _len, _len1, _len10, _len11, _len12, _len2, _len3, _len4, _len5, _len6, _len7, _len8, _len9, _m, _n, _o, _p, _q, _r, _ref, _ref1, _ref10, _ref11, _ref12, _ref13, _ref14, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9, _s, _t, _u, _v,
      _this = this;
    if ((this.results != null) && (this.results[0] != null)) {
      tableHTML = "";
      resultDataArray = [];
      keys = [];
      _ref = this.metaKeys;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        metaKey = _ref[_i];
        keys.push(metaKey);
      }
      maxIndex = 0;
      maxLength = 0;
      _ref1 = this.results;
      for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
        subtest = _ref1[i];
        if (subtest.attributes.subtestData.length > maxLength) {
          maxIndex = i;
          maxLength = subtest.attributes.subtestData.length;
        }
      }
      _ref2 = this.results[maxIndex].attributes.subtestData;
      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
        subtest = _ref2[_k];
        subtestName = subtest.name.toLowerCase().dasherize();
        prototype = subtest.prototype;
        if (prototype === "id") {
          keys.push("id");
        } else if (prototype === "datetime") {
          keys.push("year", "month", "date", "assess_time");
        } else if (prototype === "location") {
          _ref3 = subtest.data.labels;
          for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {
            label = _ref3[_l];
            keys.push(label);
          }
        } else if (prototype === "consent") {
          keys.push("consent");
        } else if (prototype === "grid") {
          variableName = subtest.data.variable_name;
          keys.push("" + variableName + "_auto_stop", "" + variableName + "_time_remain", "" + variableName + "_attempted", "" + variableName + "_item_at_time", "" + variableName + "_time_intermediate_captured", "" + variableName + "_correct_per_minute");
          _ref4 = subtest.data.items;
          for (i = _m = 0, _len4 = _ref4.length; _m < _len4; i = ++_m) {
            item = _ref4[i];
            keys.push("" + variableName + (i + 1));
          }
        } else if (prototype === "survey") {
          _ref5 = subtest.data;
          for (surveyVariable in _ref5) {
            surveyValue = _ref5[surveyVariable];
            if (_.isObject(surveyValue)) {
              for (optionKey in surveyValue) {
                optionValue = surveyValue[optionKey];
                keys.push("" + surveyVariable + "_" + optionKey);
              }
            } else {
              keys.push(surveyVariable);
            }
          }
        } else if (prototype === "observation") {
          _ref6 = subtest.data.surveys;
          for (i = _n = 0, _len5 = _ref6.length; _n < _len5; i = ++_n) {
            observations = _ref6[i];
            observationData = observations.data;
            for (surveyVariable in observationData) {
              surveyValue = observationData[surveyVariable];
              keys.push("" + surveyVariable + "_" + i);
            }
          }
        } else if (prototype === "complete") {
          keys.push("additional_comments", "end_time", "gps_latitude", "gps_longitude", "gps_accuracy");
        }
      }
      resultDataArray.push(keys);
      _ref7 = this.results;
      for (d = _o = 0, _len6 = _ref7.length; _o < _len6; d = ++_o) {
        result = _ref7[d];
        values = [];
        _ref8 = this.metaKeys;
        for (_p = 0, _len7 = _ref8.length; _p < _len7; _p++) {
          metaKey = _ref8[_p];
          values.push(result.attributes[metaKey]);
        }
        _ref9 = result.attributes.subtestData;
        for (_q = 0, _len8 = _ref9.length; _q < _len8; _q++) {
          subtest = _ref9[_q];
          prototype = subtest.prototype;
          if (prototype === "id") {
            values[keys.indexOf("id")] = subtest.data.participant_id;
          } else if (prototype === "location") {
            _ref10 = subtest.data.labels;
            for (i = _r = 0, _len9 = _ref10.length; _r < _len9; i = ++_r) {
              label = _ref10[i];
              values[keys.indexOf(label)] = subtest.data.location[i];
            }
          } else if (prototype === "datetime") {
            months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
            if (~months.indexOf(subtest.data.month.toLowerCase())) {
              monthData = months.indexOf(subtest.data.month.toLowerCase()) + 1;
            } else {
              monthData = subtest.data.month;
            }
            values[keys.indexOf("year")] = subtest.data.year;
            values[keys.indexOf("month")] = monthData;
            values[keys.indexOf("date")] = subtest.data.day;
            values[keys.indexOf("assess_time")] = subtest.data.time;
          } else if (prototype === "consent") {
            values[keys.indexOf("consent")] = subtest.data.consent;
          } else if (prototype === "grid") {
            variableName = subtest.data.variable_name;
            values[keys.indexOf("" + variableName + "_auto_stop")] = subtest.data.auto_stop;
            values[keys.indexOf("" + variableName + "_time_remain")] = subtest.data.time_remain;
            values[keys.indexOf("" + variableName + "_attempted")] = subtest.data.attempted;
            values[keys.indexOf("" + variableName + "_item_at_time")] = subtest.data.item_at_time;
            values[keys.indexOf("" + variableName + "_time_intermediate_captured")] = subtest.data.time_intermediate_captured;
            values[keys.indexOf("" + variableName + "_correct_per_minute")] = subtest.sum.correct_per_minute;
            _ref11 = subtest.data.items;
            for (i = _s = 0, _len10 = _ref11.length; _s < _len10; i = ++_s) {
              item = _ref11[i];
              if (item.itemResult === "correct") {
                exportValue = 1;
              } else if (item.itemResult === "incorrect") {
                exportValue = 0;
              } else if (item.itemResult === "missing") {
                exportValue = ".";
              }
              values[keys.indexOf("" + variableName + (i + 1))] = exportValue;
            }
          } else if (prototype === "survey") {
            _ref12 = subtest.data;
            for (surveyVariable in _ref12) {
              surveyValue = _ref12[surveyVariable];
              if (_.isObject(surveyValue)) {
                for (optionKey in surveyValue) {
                  optionValue = surveyValue[optionKey];
                  if (optionValue === "checked") {
                    exportValue = 1;
                  } else if (optionValue === "unchecked") {
                    exportValue = 0;
                  } else if (optionValue === "not_asked") {
                    exportValue = ".";
                  }
                  values[keys.indexOf("" + surveyVariable + "_" + optionKey)] = exportValue;
                }
              } else {
                exportValue = surveyValue === "not_asked" ? "." : surveyValue;
                values[keys.indexOf("" + surveyVariable)] = exportValue;
              }
            }
          } else if (prototype === "observation") {
            _ref13 = subtest.data.surveys;
            for (i = _t = 0, _len11 = _ref13.length; _t < _len11; i = ++_t) {
              observations = _ref13[i];
              observationData = observations.data;
              for (surveyVariable in observationData) {
                surveyValue = observationData[surveyVariable];
                values[keys.indexOf("" + surveyVariable + "_" + i)] = surveyValue;
              }
            }
          } else if (prototype === "complete") {
            values[keys.indexOf("additional_comments")] = subtest.data.comment;
            values[keys.indexOf("gps_latitude")] = subtest.data.gps.latitude;
            values[keys.indexOf("gps_longitude")] = subtest.data.gps.longitude;
            values[keys.indexOf("gps_accuracy")] = subtest.data.gps.accuracy;
            values[keys.indexOf("end_time")] = subtest.data.end_time;
          }
        }
        resultDataArray.push(values);
      }
      for (i = _u = 0, _len12 = resultDataArray.length; _u < _len12; i = ++_u) {
        row = resultDataArray[i];
        tableHTML += "<tr>";
        count = 0;
        for (index = _v = 0, _ref14 = row.length - 1; 0 <= _ref14 ? _v <= _ref14 : _v >= _ref14; index = 0 <= _ref14 ? ++_v : --_v) {
          tableHTML += "<td>" + row[index] + "</td>";
          count++;
        }
        tableHTML += "</tr>";
      }
      this.csv = $("<table>" + tableHTML + "</table>").table2CSV({
        "delivery": "value"
      });
      csvFile = new Backbone.Model({
        "_id": "Tangerine-" + (this.assessmentId.substr(-5, 5)) + ".csv"
      });
      csvFile.url = "csv";
      csvFile.fetch({
        complete: function() {
          return csvFile.save({
            "csv": _this.csv
          }, {
            complete: function() {
              return window.open("/tangerine/_design/tangerine/_show/csv/Tangerine-" + (_this.assessmentId.substr(-5, 5)) + ".csv", "_blank");
            }
          });
        }
      });
    }
    return this.trigger("rendered");
  };

  return CSVView;

})(Backbone.View);
