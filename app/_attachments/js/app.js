// Generated by CoffeeScript 1.4.0
var Robbert,TangerineTree,Utils,i,km,sks;Backbone.View.prototype.close=function(){return this.remove(),this.unbind(),typeof this.onClose=="function"?this.onClose():void 0},Backbone.Collection.prototype.indexBy=function(e){var t,n,r,i,s,o;r={},o=this.models;for(i=0,s=o.length;i<s;i++)n=o[i],n.has(e)&&(t=n.get(e),r[t]==null&&(r[t]=[]),r[t].push(n));return r},Backbone.Collection.prototype.indexArrayBy=function(e){var t,n,r,i,s,o;r=[],o=this.models;for(i=0,s=o.length;i<s;i++)n=o[i],n.has(e)&&(t=n.get(e),r[t]==null&&(r[t]=[]),r[t].push(n));return r},Backbone.Model.prototype.toHash=function(){var e,t,n,r;t={},r=this.attributes;for(e in r)n=r[e],~["_rev","_id","hash","updated"].indexOf(e)||(t[e]=n);return b64_sha1(JSON.stringify(t))},Backbone.Model.prototype.beforeSave=function(){return this.set("updated",(new Date).toString()),this.set("hash",this.toHash())},Backbone.Model.prototype.getNumber=function(e){return this.has(e)?parseInt(this.get(e)):0},Backbone.Model.prototype.getArray=function(e){return this.has(e)?this.get(e):[]},Backbone.Model.prototype.getString=function(e){return this.has(e)?this.get(e):""},Backbone.Model.prototype.getEscapedString=function(e){return this.has(e)?this.escape(e):""},Backbone.Model.prototype.getBoolean=function(e){if(this.has(e))return this.get(e)===!0||this.get(e)==="true"},function(e){return e.fn.scrollTo=function(t,n){t==null&&(t=250);try{e("html, body").animate({scrollTop:e(this).offset().top+"px"},t,null,n)}catch(r){console.log(r),console.log("Scroll error with 'this'"),console.log(this)}return this},e.fn.topCenter=function(){return this.css("position","absolute"),this.css("top",e(window).scrollTop()+"px"),this.css("left",(e(window).width()-this.outerWidth())/2+e(window).scrollLeft()+"px")},e.fn.middleCenter=function(){return this.css("position","absolute"),this.css("top",(e(window).height()-this.outerHeight())/2+e(window).scrollTop()+"px"),this.css("left",(e(window).width()-this.outerWidth())/2+e(window).scrollLeft()+"px")},e.fn.widthPercentage=function(){return Math.round(100*this.outerWidth()/this.offsetParent().width())+"%"},e.fn.heightPercentage=function(){return Math.round(100*this.outerHeight()/this.offsetParent().height())+"%"},e.fn.getStyleObject=function(){var e,t,n,r,i,s,o,u,a,f,l;n=this.get(0),i={};if(window.getComputedStyle){t=function(e,t){return t.toUpperCase()},s=window.getComputedStyle(n,null);for(u=0,f=s.length;u<f;u++)r=s[u],e=r.replace(/\-([a-z])/g,t),o=s.getPropertyValue(r),i[e]=o;return i}if(n.currentStyle){s=n.currentStyle;for(a=0,l=s.length;a<l;a++)r=s[a],i[r]=s[r];return i}return this.css()}}(jQuery),$.ajaxSetup({statusCode:{404:function(e,t,n){var r,i,s;r=e.status,s=e.statusText,i=~e.responseText.indexOf("unauthorized");if(i)return Utils.midAlert("Session closed<br>Please log in and try again."),Tangerine.user.logout()}}}),km={0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90},sks=[{q:function(){var e,t;t=[];for(i=e=0;e<=6;i=++e)t.push(km["0100ser"[i]]);return t}(),i:0,c:function(){return Tangerine.settings.save({context:"server"},{success:function(){return Tangerine.router.navigate("",!0)}})}},{q:function(){var e,t;t=[];for(i=e=0;e<=6;i=++e)t.push(km["0100mob"[i]]);return t}(),i:0,c:function(){return Tangerine.settings.save({context:"mobile"},{success:function(){return Tangerine.router.navigate("",!0)}})}},{q:function(){var e,t;t=[];for(i=e=0;e<=6;i=++e)t.push(km["0100cla"[i]]);return t}(),i:0,c:function(){return Tangerine.settings.save({context:"class"},{success:function(){return Tangerine.router.navigate("",!0)}})}}],$(document).keydown(function(e){var t,n,r,i,s;s=[];for(t=r=0,i=sks.length;r<i;t=++r)n=sks[t],s.push(e.keyCode===sks[t].q[sks[t].i++]?sks[t].i===sks[t].q.length?sks[t].c():void 0:sks[t].i=0);return s}),String.prototype.safetyDance=function(){return this.replace(/\s/g,"_").replace(/[^a-zA-Z0-9_]/g,"")},String.prototype.databaseSafetyDance=function(){return this.replace(/\s/g,"_").toLowerCase().replace(/[^a-z0-9_-]/g,"")},Math.ave=function(){var e,t,n,r;e=0;for(n=0,r=arguments.length;n<r;n++)t=arguments[n],e+=t;return e/=arguments.length,e},Math.isInt=function(){return typeof n=="number"&&parseFloat(n)===parseInt(n,10)&&!isNaN(n)},Math.decimals=function(e,t){var n;return n=Math.pow(10,t),e*=n,e=e+(e<!0-{.5:.5})>>0,e/=n},Math.commas=function(e){return parseInt(e).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},Math.limit=function(e,t,n){return Math.max(e,Math.min(t,n))},Utils=function(){function e(){}return e.onUpdateSuccess=function(){return e.midAlert("Update successful<br>Restarting Tangerine"),_.delay(function(){return Tangerine.router.navigate("",!1),e.askToLogout(),document.location.reload()},2e3)},e.updateTangerine=function(t){if(Tangerine.settings.get("context")!=="server")return e.midAlert("Updating..."),e.working(!0),Tangerine.$db.compact({success:function(){return Tangerine.$db.openDoc("_design/tangerine",{success:function(t){return $.couch.replicate(Tangerine.settings.urlDB("update"),Tangerine.settings.location.update.target,{success:function(){return Tangerine.$db.openDoc("_design/tangerine",{conflicts:!0,success:function(n){return n._conflicts!=null?Tangerine.$db.removeDoc(t,{success:function(){return e.working(!1),e.onUpdateSuccess()},error:function(t){return e.working(!1),e.midAlert("Update failed resolving conflict<br>"+t)}}):e.onUpdateSuccess()}})},error:function(t){return e.working(!1),e.midAlert("Update failed replicating<br>"+t)}},{doc_ids:["_design/tangerine"]})},error:function(t){return e.working(!1),e.midAlert("Update failed openning database<br>"+t)}})},error:function(t){return e.working(!1),e.midAlert("Update failed compacting database<br>"+t)}})},e.log=function(e,t){var n;return n=e.constructor.toString().match(/function\s*(\w+)/)[1],console.log(""+n+": "+t)},e.working=function(t){if(!t)return Tangerine.loadingTimer!=null&&(clearTimeout(Tangerine.loadingTimer),Tangerine.loadingTimer=null),$(".loading_bar").remove();if(Tangerine.loadingTimer==null)return Tangerine.loadingTimer=setTimeout(e.showLoadingIndicator,3e3)},e.showLoadingIndicator=function(){return $("<div class='loading_bar'><img class='loading' src='images/loading.gif'></div>").appendTo("body").middleCenter()},e.confirm=function(e,t){var n;return((n=navigator.notification)!=null?n.confirm:void 0)==null?window.confirm(e)?(t.callback(!0),!0):(t.callback(!1),!1):(navigator.notification.confirm(e,function(e){return e===1?t.callback(!0):e===2?t.callback(!1):t.callback(e)},t.title,t.action+",Cancel"),0)},e.getValues=function(e){var t;return t={},$(e).find("input[type=text], input[type=password], textarea").each(function(e,n){return t[n.id]=n.value}),t},e.cleanURL=function(e){return(typeof e.indexOf=="function"?e.indexOf("%"):void 0)!==-1?e=decodeURIComponent(e):e},e.topAlert=function(e,t){return t==null&&(t=2e3),$("<div class='disposable_alert'>"+e+"</div>").appendTo("#content").topCenter().delay(t).fadeOut(250,function(){return $(this).remove()})},e.midAlert=function(e,t){return t==null&&(t=2e3),$("<div class='disposable_alert'>"+e+"</div>").appendTo("#content").middleCenter().delay(t).fadeOut(250,function(){return $(this).remove()})},e.sticky=function(e){return $("<div class='sticky_alert'>"+e+"<br><button class='command parent_remove'>Close</button></div>").appendTo("#content").middleCenter().on("keyup",function(e){if(e.which===27)return $(this).remove()})},e.modal=function(e){if(e===!1){$("#modal_back, #modal").remove();return}return $("body").prepend("<div id='modal_back'></div>"),$("<div id='modal'>"+e+"</div>").appendTo("#content").middleCenter().on("keyup",function(e){if(e.which===27)return $("#modal_back, #modal").remove()})},e.passwordPrompt=function(t){var n,r,i;return i="      <div id='pass_form' title='User verification'>        <label for='password'>Please re-enter your password</label>        <input id='pass_val' type='password' name='password' id='password' value=''>        <button class='command' data-verify='true'>Verify</button>        <button class='command'>Cancel</button>      </div>    ",e.modal(i),r=$("#pass_val"),n=$("#pass_form button"),r.on("keyup",function(i){return i.which!==13?!0:(n.off("click"),r.off("change"),t(r.val()),e.modal(!1))}),n.on("click",function(i){return n.off("click"),r.off("change"),$(i.target).attr("data-verify")==="true"&&t(r.val()),e.modal(!1)})},e.guid=function(){return this.S4()+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4()},e.S4=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},e.humanGUID=function(){return this.randomLetters(4)+"-"+this.randomLetters(4)+"-"+this.randomLetters(4)},e.safeLetters="abcdefghijlmnopqrstuvwxyz".split(""),e.randomLetters=function(t){var n;n="";while(t--)n+=e.safeLetters[Math.floor(Math.random()*e.safeLetters.length)];return n},e.flash=function(e){return e==null&&(e="red"),$("#content_wrapper").css({backgroundColor:e}),setTimeout(function(){return $("#content_wrapper").css({backgroundColor:""})},1e3)},e.$_GET=function(e,t){var n,r;return r={},n=window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,t,n){return n=~n.indexOf("#")?n.split("#")[0]:n,r[t]=n.split("#")[0]}),r},e.resizeScrollPane=function(){return $(".scroll_pane").height($(window).height()-($("#navigation").height()+$("#footer").height()+100))},e.askToLogout=function(){if(confirm("Would you like to logout now?"))return Tangerine.user.logout()},e.oldConsoleLog=null,e.enableConsoleLog=function(){if(typeof oldConsoleLog=="undefined"||oldConsoleLog===null)return;return window.console.log=oldConsoleLog},e.disableConsoleLog=function(){var e;return e=console.log,window.console.log=$.noop},e.oldConsoleAssert=null,e.enableConsoleAssert=function(){if(typeof oldConsoleAssert=="undefined"||oldConsoleAssert===null)return;return window.console.assert=oldConsoleAssert},e.disableConsoleAssert=function(){var e;return e=console.assert,window.console.assert=$.noop},e}(),Robbert=function(){function e(){}return e.request=function(e){var t,n,r=this;return n=e.success,t=e.error,delete e.success,delete e.error,$.ajax({type:"POST",crossDomain:!0,url:Tangerine.config.get("robbert"),dataType:"json",data:e,success:function(e){return n(e)},error:function(e){return t(e)}})},e}(),TangerineTree=function(){function e(){}return e.make=function(e){var t,n,r=this;return Utils.working(!0),n=e.success,t=e.error,delete e.success,delete e.error,e.user=Tangerine.user.name,$.ajax({type:"POST",crossDomain:!0,url:Tangerine.config.get("tree")+("make/"+Tangerine.settings.get("groupName")),dataType:"json",data:e,success:function(e){return n(e)},error:function(e){return t(e,JSON.parse(e.responseText))},complete:function(){return Utils.working(!1)}})},e}(),$(function(){return $("#content").on("click",".clear_message",null,function(e){return $(e.target).parent().fadeOut(250,function(){return $(this).empty().show()})}),$("#content").on("click",".parent_remove",null,function(e){return $(e.target).parent().fadeOut(250,function(){return $(this).remove()})}),$("#content").on("click",".alert_button",function(){var e;return e=$(this).attr("data-alert")?$(this).attr("data-alert"):$(this).val(),Utils.disposableAlert(e)}),$("#content").on("click",".disposable_alert",function(){return $(this).stop().fadeOut(100,function(){return $(this).remove()})})});var Assessment,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Assessment=function(e){function t(){return this.destroy=__bind(this.destroy,this),this.updateFromTrunk=__bind(this.updateFromTrunk,this),this.checkConflicts=__bind(this.checkConflicts,this),this.updateFromServer=__bind(this.updateFromServer,this),this.fetch=__bind(this.fetch,this),this.getResultCount=__bind(this.getResultCount,this),this.calcDKey=__bind(this.calcDKey,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="assessment",t.prototype.initialize=function(e){return e==null&&(e={}),this.subtests=new Subtests},t.prototype.calcDKey=function(){return this.id.substr(-5,5)},t.prototype.getResultCount=function(){var e=this;return $.ajax(Tangerine.settings.urlView("local","resultCount")({type:"GET",dataType:"json",data:{group:!0,group_level:1,key:JSON.stringify(this.id)},success:function(t){return e.resultCount=t.rows.length!==0?t.rows[0].value:0,e.trigger("resultCount")}}))},t.prototype.fetch=function(e){var n,r=this;return n=e.success,e.success=function(e){var t;return t=new Subtests,t.fetch({key:r.id,success:function(e){return r.subtests=e,r.subtests.maintainOrder(),typeof n=="function"?n(r):void 0}})},t.__super__.fetch.call(this,e)},t.prototype.updateFromServer=function(e){var t,n=this;return e==null&&(e=this.calcDKey()),this.lastDKey=e,console.log("trying to update with : "+e),t=e.replace(/[^a-f0-9]/g," ").split(/\s+/),this.trigger("status","import lookup"),$.ajax({url:Tangerine.settings.urlView("group","byDKey"),type:"GET",dataType:"jsonp",data:{keys:JSON.stringify(t)},success:function(e){var r,i,s,o,u;i=[],u=e.rows;for(s=0,o=u.length;s<o;s++)r=u[s],i.push(r.id);return $.ajax({url:Tangerine.settings.urlView("local","byDKey"),type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({keys:t}),success:function(e){var t,s,o;o=e.rows;for(t=0,s=o.length;t<s;t++)r=o[t],i.push(r.id);return i=_.uniq(i),$.couch.replicate(Tangerine.settings.urlDB("group"),Tangerine.settings.urlDB("local"),{success:function(e){return n.checkConflicts(i),n.trigger("status","import success",e)},error:function(e,t){return n.trigger("status","import error",""+e+" "+t)}},{doc_ids:i})}})}}),!1},t.prototype.checkConflicts=function(e,t){var n,r,i,s,o=this;e==null&&(e=[]),t==null&&(t={});if(typeof docs=="undefined"||docs===null)this.docs={};s=[];for(r=0,i=e.length;r<i;r++)n=e[r],s.push(Tangerine.$db.openDoc(n,{open_revs:"all",conflicts:!0,success:function(t){var n,r,i,s;if(t.length!==1){n=t,s=[];for(r=0,i=n.length;r<i;r++)t=n[r],t=t.ok,s.push(function(t,n){if(t.deletedAt==="mobile")return $.ajax({type:"PUT",dataType:"json",url:"http://localhost:5984/"+Tangerine.settings.urlDB("local")+"/"+t._id,data:JSON.stringify({_rev:t._rev,_deleted:!0}),error:function(){return console.log("Could not delete conflicting version")},complete:function(){o.docs.checked==null&&(o.docs.checked=0),o.docs.checked++;if(o.docs.checked===e.length){o.docs.checked=0;if(!_.isEmpty(o.lastDKey))return o.updateFromServer(o.lastDKey),o.lastDKey=""}}})}(t,n));return s}t=t[0].ok;if(t.deletedAt==="mobile")return $.ajax({type:"PUT",dataType:"json",url:"http://localhost:5984/"+Tangerine.settings.urlDB("local")+"/"+t._id,data:JSON.stringify({_rev:t._rev,deletedAt:t.deletedAt,_deleted:!1}),error:function(){return console.log("save new doc error")},complete:function(){o.docs.checked==null&&(o.docs.checked=0),o.docs.checked++;if(o.docs.checked===e.length){o.docs.checked=0;if(!_.isEmpty(o.lastDKey))return o.updateFromServer(o.lastDKey),o.lastDKey=""}}})},error:function(){return console.log("error with "+n)}}));return s},t.prototype.updateFromTrunk=function(e){var t,n=this;return e==null&&(e=this.calcDKey()),t=e.replace(/[^a-f0-9]/g," ").split(/\s+/),this.trigger("status","import lookup"),$.ajax({url:Tangerine.settings.urlView("trunk","byDKey"),dataType:"json",contentType:"application/json",type:"GET",data:{keys:JSON.stringify(t)},success:function(e){var t,r,i,s,o;r=[],o=e.rows;for(i=0,s=o.length;i<s;i++)t=o[i],r.push(t.id);return $.couch.replicate(Tangerine.settings.trunkDB,Tangerine.settings.groupDB,{success:function(){return n.trigger("status","import success")},error:function(e,t){return console.log(arguments),n.trigger("status","import error",""+e+" "+t)}},{doc_ids:r})}}),!1},t.prototype.duplicate=function(e,t,n,r){var i,s,o;return o=this.id,s=this.clone(),s.set(e),i=Utils.guid(),s.save({_id:i,assessmentId:i},{success:function(){var e,t=this;return e=new Questions,e.fetch({key:o,success:function(e){var t;return t=new Subtests,t.fetch({key:o,success:function(t){var n,i,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;n=t.models,v={},h=[];for(o=m=0,b=n.length;m<b;o=++m)u=n[o],l=u.clone(),l.set("assessmentId",s.id),c=Utils.guid(),v[l.id]=c,l.set("_id",c),h.push(l);for(o=g=0,w=h.length;g<w;o=++g)u=h[o],i=u.get("gridLinkId"),(i||"")!==""&&u.set("gridLinkId",v[i]),u.save();f=[],S=e.models;for(y=0,E=S.length;y<E;y++)d=S[y],a=d.clone(),p=a.get("subtestId"),a.set("assessmentId",s.id),a.set("_id",Utils.guid()),a.set("subtestId",v[p]),f.push(a),a.save();return r(s)}})}})}})},t.prototype.destroy=function(){var e=this;return Tangerine.$db.view("tangerine/revByAssessmentId",{keys:[this.id],success:function(t){var n,r,i,s,o,u;n=[],u=t.rows;for(s=0,o=u.length;s<o;s++)i=u[s],i.value._deleted=!0,i.value.deletedAt=Tangerine.settings.get("context"),n.push(i.value);return r={docs:n},$.ajax({type:"POST",contentType:"application/json; charset=UTF-8",dataType:"json",url:"/"+Tangerine.settings.urlDB("local")+"/_bulk_docs",data:JSON.stringify(r),success:function(t){var n,r,i,s;n=0;for(i=0,s=t.length;i<s;i++)r=t[i],console.log(r),r.ok!=null&&n++;return n===t.length?(e.collection.remove(e.id),e.clear()):Utils.midAlert("Delete error.")},error:function(){return Utils.midAlert("Delete error.")}})},error:function(){return Utils.midAlert("Delete error.")}})},t.prototype.isActive=function(){return!this.isArchived()},t.prototype.isArchived=function(){var e;return e=this.get("archived"),e==="true"||e===!0},t}(Backbone.Model);var Assessments,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Assessments=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.model=Assessment,t.prototype.url="assessment",t.prototype.comparator=function(e){return e.get("name")},t.prototype.initialize=function(e){if(e!=null?e.group:void 0)return this.group=e.group},t}(Backbone.Collection);var AssessmentsView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};AssessmentsView=function(e){function t(){return this.render=__bind(this.render,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="AssessmentsView",t.prototype.tagName="div",t.prototype.events={"click .toggle_archived":"toggleArchived"},t.prototype.toggleArchived=function(e){var t;return this.archivedIsVisible?(this.archivedIsVisible=!1,t=this.$el.find(".archived_list").addClass("confirmation"),this.$el.find(".toggle_archived").html("Show")):(this.archivedIsVisible=!0,t=this.$el.find(".archived_list").removeClass("confirmation"),this.$el.find(".toggle_archived").html("Hide"))},t.prototype.initialize=function(e){return e.assessments.on("add destroy remove update",this.render),this.parent=e.parent,this.assessments=e.assessments,this.subviews=[],this.archivedIsVisible=!1},t.prototype.render=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;this.closeViews(),o=this.assessments.models,n=[],i=[];for(l=0,p=o.length;l<p;l++)s=o[l],u=new AssessmentListElementView({model:s,showAll:this.showAll}),s.isArchived()&&Tangerine.settings.get("context")==="server"?i.push(u):n.push(u);this.subviews=i.concat(n);if(this.subviews.length===0&&!this.isPublic){Tangerine.settings.get("context")==="server"?this.$el.html("<p class='grey'>No assessments yet. Click <b>new</b> to get started.</p>"):this.$el.html("<p class='grey'>No assessments imported yet.</p>"),this.trigger("rendered");return}r="      <div class='archived_container'>        <h2>Archived ("+i.length+") <button class='command toggle_archived'>Show</button></h2>        <ul class='archived_list assessment_list confirmation'></ul>      </div>    ",a=i.length!==0&&Tangerine.settings.get("context")==="server",this.$el.html("      <ul class='active_list assessment_list'></ul>      "+(a?r:"")+"    "),t=this.$el.find(".active_list");for(c=0,d=n.length;c<d;c++)f=n[c],f.render(),t.append(f.el);if(a){t=this.$el.find(".archived_list");for(h=0,v=i.length;h<v;h++)f=i[h],f.render(),t.append(f.el)}return this.trigger("rendered")},t.prototype.closeViews=function(){var e,t,n,r;r=this.subviews;for(t=0,n=r.length;t<n;t++)e=r[t],e.close();return this.subviews=[]},t.prototype.onClose=function(){return this.closeViews()},t}(Backbone.View);var AssessmentListElementView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};AssessmentListElementView=function(e){function t(){return this.assessmentDelete=__bind(this.assessmentDelete,this),this.updateResultCount=__bind(this.updateResultCount,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="AssessmentListElementView",t.prototype.tagName="li",t.prototype.events={"click .assessment_menu_toggle":"assessmentMenuToggle","click .admin_name":"assessmentMenuToggle","click .assessment_delete":"assessmentDeleteToggle","click .assessment_delete_cancel":"assessmentDeleteToggle","click .assessment_delete_confirm":"assessmentDelete","click .copy":"copyTo","click .duplicate":"duplicate","click .archive":"archive","click .update":"update","click .print":"togglePrint","change #print_format":"print"},t.prototype.blankResultCount="-",t.prototype.initialize=function(e){return this.model=e.model,this.parent=e.parent,this.isAdmin=Tangerine.user.isAdmin()},t.prototype.duplicate=function(){var e,t=this;return e="Copy of "+this.model.get("name"),this.model.duplicate({name:e},null,null,function(e){return t.model.trigger("new",e)})},t.prototype.copyTo=function(e){var t=this;return this.model.replicate(e,function(){return window.location=Tangerine.settings.urlIndex(e,"assessments")})},t.prototype.update=function(){var e=this;return this.model.updateFromServer(),this.model.on("status",function(t){if(t==="import success")return Utils.midAlert("Updated"),e.model.fetch({success:function(){return e.render()}});if(t==="import error")return Utils.midAlert("Update failed")})},t.prototype.togglePrint=function(){return this.$el.find(".print_format_wrapper").fadeToggle(150)},t.prototype.print=function(){var e,t=this;e=this.$el.find("#print_format option:selected").attr("data-format");if(e==="cancel"){this.$el.find(".print_format_wrapper").fadeToggle(150,function(){return t.$el.find("#print_format").val("reset")});return}return Tangerine.router.navigate("print/"+this.model.id+"/"+e,!0)},t.prototype.updateResultCount=function(){},t.prototype.archive=function(){var e;return e=this.$el.find(".archive :selected").val()==="true",e===!0?this.$el.find(".admin_name").addClass("archived_assessment"):this.$el.find(".admin_name").removeClass("archived_assessment"),this.model.save({archived:e}),!0},t.prototype.assessmentMenuToggle=function(){return this.$el.find(".assessment_menu_toggle").toggleClass("icon_down"),this.$el.find(".assessment_menu").fadeToggle(250)},t.prototype.assessmentDeleteToggle=function(){return this.$el.find(".assessment_delete_confirm").fadeToggle(250),!1},t.prototype.assessmentDelete=function(){return this.model.destroy()},t.prototype.render=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;h=this.model.getBoolean("archived");if(!this.isAdmin&&h&&Tangerine.settings.get("context")==="mobile")return;return E="<span class='assessment_menu_toggle icon_ryte'> </span>",p="<span class='name clickable '>"+this.model.get("name")+"</span>",e="<span class='admin_name clickable "+n+"'>"+this.model.get("name")+"</span>",t="<label class='result_count small_grey no_help' title='Result count. Click to update.'>Results <b>"+this.resultCount+"</b></label>",g="<span class='result_count no_help'>Results <b>"+this.resultCount+"</b></span>",n=h?" archived_assessment":"",w=" selected='selected'",f="<a href='#edit/"+this.model.id+"'><img class='link_icon edit' title='Edit' src='images/icon_edit.png'></a>",b="<a href='#run/"+this.model.id+"'><img class='link_icon run' title='Run' src='images/icon_run.png'></a>",y="<a href='#results/"+this.model.id+"'><img class='link_icon results' title='Results' src='images/icon_results.png'></a>",d="<img class='link_icon print' title='Print' src='images/icon_print.png'> ",v="      <a href='#print/"+this.model.id+"/content'><img class='link_icon print' title='Print' src='images/icon_print.png'></a>      <a href='#print/"+this.model.id+"/stimuli'><img class='link_icon print' title='Print' src='images/icon_print.png'></a>      <a href='#print/"+this.model.id+"/backup'><img class='link_icon print' title='Print' src='images/icon_print.png'></a>    ",m="      <div class='print_format_wrapper confirmation'>        <select id='print_format'>        <option disabled='disabled' selected='selected' value='reset'>Select a print format</option>        "+function(){var e,t,n,r;n=Tangerine.settings.config.get("printFormats"),r=[];for(e=0,t=n.length;e<t;e++)l=n[e],r.push("<option data-format='"+l.key+"'>"+l.name+"</option>");return r}()+"        <option data-format='cancel'>Cancel</option>        </select>      </div>    ",i="<img class='link_icon copy' title='Copy to' src='images/icon_copy_to.png'>",s="<img class='assessment_delete link_icon' title='Delete' src='images/icon_delete.png'>",o="<span class='assessment_delete_confirm'><div class='menu_box'>Confirm <button class='assessment_delete_yes command_red'>Delete</button> <button class='assessment_delete_cancel command'>Cancel</button></div></span>",a="<img class='link_icon duplicate' title='Duplicate' src='images/icon_duplicate.png'>",S="<img class='link_icon update' title='Update' src='images/icon_sync.png'>",u="<span class='download_key small_grey'>Download key <b>"+this.model.id.substr(-5,5)+"</b></span>",r="    <select class='archive'>      <option value='false' "+(h?w:"")+">Active</option>      <option value='true'  "+(h?w:"")+">Archived</option>    </select>    ",this.isAdmin?(c="        <div>          "+E+"          "+e+"        </div>      ",Tangerine.settings.get("context")==="mobile"?c+="          <div class='assessment_menu'>            "+b+"            "+y+"            "+S+"            "+s+"            "+o+"          </div>        ":c+="          <div class='assessment_menu'>            "+b+"            "+y+"            "+f+"            "+d+"            "+a+"            "+s+"            "+u+"            "+o+"            "+m+"          </div>        "):c="<div>"+b+p+" "+y+"</div>",this.$el.html(c),this.trigger("rendered")},t}(Backbone.View);var AssessmentsMenuView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};AssessmentsMenuView=function(e){function t(){return this.newSave=__bind(this.newSave,this),this.addToCollection=__bind(this.addToCollection,this),this.render=__bind(this.render,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="AssessmentsMenuView",t.prototype.events={"keypress .new_name":"newSave","click .new_save":"newSave","click .new_cancel":"newToggle","click .new":"newToggle","click .import":"import","click .apk":"apk","click .groups":"gotoGroups","click .universal_upload":"universalUpload","click .results":"results"},t.prototype.results=function(){return Tangerine.router.navigate("dashboard",!0)},t.prototype.universalUpload=function(){return $.ajax({url:Tangerine.settings.urlView("local","byCollection"),type:"GET",dataType:"json",contentType:"application/json",data:{keys:JSON.stringify(["result"])},success:function(e){var t,n,r,i,s,o=this;r=e.rows,t=[];for(i=0,s=r.length;i<s;i++)n=r[i],t.push(n.id);return $.couch.replicate(Tangerine.settings.urlDB("local"),Tangerine.settings.urlDB("group"),{success:function(){return Utils.midAlert("Results synced to cloud successfully")},error:function(e,t){return Utils.midAlert("Upload error<br>"+e+" "+t)}},{doc_ids:t})}})},t.prototype.apk=function(){return TangerineTree.make({success:function(e){return Utils.sticky("<h1>APK link</h1><p>tangerine.xen.prgmr.com:81/apk/"+e.token+"</p>")},error:function(e,t){return Utils.sticky(t.error)}})},t.prototype.gotoGroups=function(){return Tangerine.router.navigate("groups",!0)},t.prototype["import"]=function(){return Tangerine.router.navigate("import",!0)},t.prototype.initialize=function(e){var t=this;return this.assessments=e.assessments,this.curricula=e.curricula,this.assessments.each(function(e){return e.on("new",t.addToCollection)}),this.isAdmin=Tangerine.user.isAdmin(),this.curriculaListView=new CurriculaListView({curricula:this.curricula}),this.assessmentsView=new AssessmentsView({assessments:this.assessments,parent:this}),this.usersMenuView=new UsersMenuView},t.prototype.render=function(){var e,t,n,r,i,s,o;i="<button class='new command'>New</button>",r="<button class='import command'>Import</button>",e="<button class='apk navigation'>APK</button>",t="<button class='navigation groups'>Groups</button>",o="<button class='command universal_upload'>Universal Upload</button>",s="<button class='navigation results'>Results</button>",n="      "+(Tangerine.settings.get("context")==="server"?t:"")+"      "+(Tangerine.settings.get("context")==="server"?e:"")+"      "+(Tangerine.settings.get("context")==="server"?s:"")+"      <h1>Assessments</h1>    ",this.isAdmin?n+="        "+(Tangerine.settings.get("context")==="server"?i:"")+"        "+r+"                <div class='new_form confirmation'>          <div class='menu_box_wide'>            <input type='text' class='new_name' placeholder='Name'>            <select id='new_type'>              <option value='assessment'>Assessment</option>              <option value='curriculum'>Curriculum</option>            </select><br>            <button class='new_save command'>Save</button> <button class='new_cancel command'>Cancel</button>          </div>        </div>        <div id='assessments_container'></div>        <div id='curricula_container'></div>        <br>        "+(Tangerine.settings.get("context")==="mobile"?o:"")+"        <div id='users_menu_container' class='UsersMenuView'></div>      ":n+="        <div id='assessments_container'></div>        <br>        "+(Tangerine.settings.get("context")==="mobile"?o:"")+"      ",this.$el.html(n),this.assessmentsView.setElement(this.$el.find("#assessments_container")),this.assessmentsView.render(),this.curriculaListView.setElement(this.$el.find("#curricula_container")),this.curriculaListView.render(),Tangerine.settings.get("context")==="server"&&(this.usersMenuView.setElement(this.$el.find("#users_menu_container")),this.usersMenuView.render()),this.trigger("rendered")},t.prototype.addToCollection=function(e){return e.has("curriculumId")?this.curricula.add(e):this.assessments.add(e),e.on("new",this.addToCollection)},t.prototype.newToggle=function(){return this.$el.find(".new_form, .new").fadeToggle(250),!1},t.prototype.newSave=function(e){var t,n,r,i,s=this;return e.type!=="click"&&e.which!==13?!0:(t=this.$el.find(".new_name").val(),i=this.$el.find("#new_type option:selected").val(),n=Utils.guid(),t.length===0?(Utils.midAlert("<span class='error'>Could not save <img src='images/icon_close.png' class='clear_message'></span>"),!1):(i==="assessment"?r=new Assessment({name:t,_id:n,assessmentId:n,archived:!1}):i==="curriculum"&&(r=new Curriculum({name:t,_id:n,curriculumId:n})),r.save(null,{success:function(){return s.addToCollection(r),s.$el.find(".new_form, .new").fadeToggle(250,function(){return s.$el.find(".new_name").val("")}),Utils.midAlert(""+t+" saved")},error:function(){return s.$el.find(".new_form, .new").fadeToggle(250,function(){return s.$el.find(".new_name").val("")}),Utils.midAlert("Please try again. Error saving.")}}),!1))},t.prototype.closeViews=function(){return this.assessmentsView.close(),this.curriculaListView.close()},t.prototype.onClose=function(){return this.closeViews()},t}(Backbone.View);var AssessmentEditView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in 
t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};AssessmentEditView=function(e){function t(){return this.updateSubtestLegend=__bind(this.updateSubtestLegend,this),this.render=__bind(this.render,this),this.saveNewSubtest=__bind(this.saveNewSubtest,this),this.updateModel=__bind(this.updateModel,this),this.save=__bind(this.save,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="assessment_edit_view",t.prototype.events={"click #archive_buttons input":"save","click .back":"goBack","click .new_subtest_button":"toggleNewSubtestForm","click .new_subtest_cancel":"toggleNewSubtestForm","keypress #new_subtest_name":"saveNewSubtest","click .new_subtest_save":"saveNewSubtest","change #basic input":"save","click .save":"save"},t.prototype.initialize=function(e){return this.model=e.model,this.subtestListEditView=new SubtestListEditView({assessment:this.model}),this.model.subtests.on("change remove",this.subtestListEditView.render),this.model.subtests.on("all",this.updateSubtestLegend)},t.prototype.save=function(){var e=this;if(this.updateModel())return this.model.save(null,{success:function(){return Utils.midAlert(""+e.model.get("name")+" saved")},error:function(){return Utils.midAlert("Assessment save error. Please try again.")}})},t.prototype.goBack=function(){return Tangerine.router.navigate("assessments",!0)},t.prototype.updateModel=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;l=this.model.subtests.models.length,f=this.$el.find("#sequences").val().replace(/[^0-9,\n]/g,""),a=f.split("\n");for(r=d=0,m=a.length;d<m;r=++d){o=a[r],o=o.split(",");for(i=v=0,g=o.length;v<g;i=++v){t=o[i],o[i]=parseInt(t);if(o[i]<0||o[i]>=l)s=!0;isNaN(o[i])&&(n=!0)}a[r]=o,o.length>l&&(h=!0),o.length<l&&(c=!0),o.length!==_.uniq(o).length&&(e=!0)}return _.isEmpty(_.reject(_.flatten(a),function(e){return isNaN(e)}))?this.$el.find("#sequences").val(""):(u=[],n&&u.push("Some sequences contain empty values."),s&&u.push("Some numbers do not reference a subtest from the legend."),h&&u.push("Some sequences are longer than the total number of all subtests."),c&&u.push("Some sequences are shorter than the total number of all subtests."),e&&u.push("Some sequences contain doubles."),u.length===0?(p=function(){var e,t,n;n=[];for(e=0,t=a.length;e<t;e++)o=a[e],n.push(o.join(", "));return n}().join("\n"),this.$el.find("#sequences").val(p)):alert("Warning\n\n"+u.join("\n"))),this.model.set({sequences:a,archived:this.$el.find("#archive_buttons input:checked").val()==="true",name:this.$el.find("#assessment_name").val(),dKey:this.$el.find("#assessment_d_key").val(),assessmentId:this.model.id}),!0},t.prototype.toggleNewSubtestForm=function(e){var t=this;return this.$el.find(".new_subtest_form, .new_subtest_button").fadeToggle(250,function(){return t.$el.find("#new_subtest_name").val(""),t.$el.find("#subtest_type_select").val("none")}),!1},t.prototype.saveNewSubtest=function(e){var t,n,r,i,s;return e.type!=="click"&&e.which!==13?!0:this.$el.find("#subtest_type_select option:selected").val()==="none"?(Utils.midAlert("Please select a subtest type"),!1):(t=Tangerine.templates.get("subtest"),r=Tangerine.templates.get("prototypes")[this.$el.find("#subtest_type_select").val()],i=this.$el.find("#subtest_type_select :selected").attr("data-template"),s=Tangerine.templates.get("subtestTemplates")[this.$el.find("#subtest_type_select").val()][i],t=$.extend(t,r),t=$.extend(t,s),t=$.extend(t,{name:this.$el.find("#new_subtest_name").val(),assessmentId:this.model.id,order:this.model.subtests.length}),n=this.model.subtests.create(t),this.toggleNewSubtestForm(),!1)},t.prototype.render=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d=this;s="";if(this.model.has("sequences")){s=this.model.get("sequences"),s=s.join("\n");if(_.isArray(s))for(n=c=0,h=s.length;c<h;n=++c)s=s[n],s[n]=s.join(", ")}a=this.updateSubtestLegend(),e=this.model.get("archived"),t=e===!0||e==="true"?"checked":"",i=t?"":"checked",f="<select id='subtest_type_select'>      <option value='none' disabled='disabled' selected='selected'>Please select a subtest type</option>",p=Tangerine.templates.get("subtestTemplates");for(r in p){l=p[r],f+="<optgroup label='"+r+"'>";for(o in l)u=l[o],f+="<option value='"+r+"' data-template='"+o+"'>"+o+"</option>";f+="</optgroup>"}return f+="</select>",this.$el.html("      <button class='back navigation'>Back</button>        <h1>Assessment Builder</h1>      <div id='basic'>        <label for='assessment_name'>Name</label>        <input id='assessment_name' value='"+this.model.escape("name")+"'>        <label for='assessment_d_key' title='This key is used to import the assessment from a tablet.'>Download Key</label><br>        <div class='info_box'>"+this.model.id.substr(-5,5)+"</div>      </div>      <label title='Only active assessments will be displayed in the main assessment list.'>Status</label><br>      <div id='archive_buttons' class='buttonset'>        <input type='radio' id='archive_false' name='archive' value='false' "+i+"><label for='archive_false'>Active</label>        <input type='radio' id='archive_true'  name='archive' value='true'  "+t+"><label for='archive_true'>Archived</label>      </div>      <h2>Subtests</h2>      <div class='menu_box'>        <div>        <ul id='subtest_list'>        </ul>        </div>        <button class='new_subtest_button command'>Add Subtest</button>        <div class='new_subtest_form confirmation'>          <div class='menu_box'>            <h2>New Subtest</h2>            <label for='subtest_type_select'>Type</label><br>            "+f+"<br>            <label for='new_subtest_name'>Name</label><br>            <input type='text' id='new_subtest_name'>            <button class='new_subtest_save command'>Add</button> <button class='new_subtest_cancel command'>Cancel</button>          </div>        </div>      </div>      <h2>Options</h2>      <div class='label_value'>        <label for='sequences' title='This is a list of acceptable orders of subtests, which will be randomly selected each time an assessment is run. Subtest indicies are separated by commas, new lines separate sequences. '>Random Sequences</label>        <div id='subtest_legend'>"+a+"</div>        <textarea id='sequences'>"+s+"</textarea>      </div>      <button class='save command'>Save</button>      "),this.subtestListEditView.setElement(this.$el.find("#subtest_list")),this.subtestListEditView.render(),this.$el.find("#subtest_list").sortable({handle:".sortable_handle",start:function(e,t){return t.item.addClass("drag_shadow")},stop:function(e,t){return t.item.removeClass("drag_shadow")},update:function(e,t){var r,i,s,o,u;u=function(){var e,t,n,r;n=this.$el.find("#subtest_list li"),r=[];for(e=0,t=n.length;e<t;e++)i=n[e],r.push($(i).attr("data-id"));return r}.call(d);for(n=s=0,o=u.length;s<o;n=++s)r=u[n],d.model.subtests.get(r).set({order:n},{silent:!0}).save(null,{silent:!0});return d.model.subtests.sort()}}),this.trigger("rendered")},t.prototype.updateSubtestLegend=function(){var e,t;return t="",this.model.subtests.each(function(e,n){return t+="<div class='small_grey'>"+n+" - "+e.get("name")+"</div><br>"}),e=this.$el.find("#subtest_legend"),e.length!==0&&e.html(t),t},t.prototype.onClose=function(){return this.subtestListEditView.close()},t}(Backbone.View);var AssessmentRunView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};AssessmentRunView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="AssessmentRunView",t.prototype.initialize=function(e){var t,n,r,i,s,o,u=this;this.abortAssessment=!1,this.index=0,this.model=e.model,this.orderMap=[],Tangerine.activity="assessment run",this.subtestViews=[],this.model.subtests.sort(),this.model.subtests.each(function(e){return u.subtestViews.push(new SubtestRunView({model:e,parent:u}))}),t=this.model.has("sequences")&&!_.isEmpty(_.compact(_.flatten(this.model.get("sequences"))));if(t)i=this.model.get("sequences"),this.orderMap=i[Math.floor(Math.random()*i.length)],this.orderMap[this.orderMap.length]=this.orderMap.length;else for(n=s=0,o=this.subtestViews.length;0<=o?s<=o:s>=o;n=0<=o?++s:--s)this.orderMap[n]=n;return this.result=new Result({assessmentId:this.model.id,assessmentName:this.model.get("name"),blank:!0}),t&&this.result.set({order_map:this.orderMap}),r=new ResultView({model:this.result,assessment:this.model,assessmentView:this}),this.subtestViews.push(r)},t.prototype.render=function(){var e,t=this;return e=this.subtestViews[this.orderMap[this.index]],this.model.subtests.length===0?this.$el.append("<h1>Oops...</h1><p>This assessment is blank. Perhaps you meant to add some subtests.</p>"):(this.$el.html("        <h1>"+this.model.get("name")+"</h1>        <div id='progress'></div>      "),this.$el.find("#progress").progressbar({value:(this.index+1)/(this.model.subtests.length+1)*100}),e.on("rendered",function(){return t.trigger("rendered")}),e.on("subRendered",function(){return t.trigger("subRendered")}),e.render(),this.$el.append(e.el)),this.trigger("rendered")},t.prototype.onClose=function(){var e,t,n,r;r=this.subtestViews;for(t=0,n=r.length;t<n;t++)e=r[t],e.close();return this.result.clear(),$("#current_student_id").fadeOut(250,function(){return $(this).html("").show()}),$("#current_student").fadeOut(250)},t.prototype.abort=function(){return this.abortAssessment=!0,this.next()},t.prototype.skip=function(){var e;return e=this.subtestViews[this.orderMap[this.index]],this.result.add({name:e.model.get("name"),data:e.getSkipped(),subtestId:e.model.id,skipped:!0,prototype:e.model.get("prototype"),sum:e.getSum()}),e.close(),this.abortAssessment!==!0&&this.index++,this.abortAssessment===!0&&(this.index=this.subtestViews.length-1),this.render(),window.scrollTo(0,0)},t.prototype.next=function(){var e,t;return e=this.subtestViews[this.orderMap[this.index]],e.isValid()?(t=e.getResult(),this.result.add({name:e.model.get("name"),data:t.body,subtestHash:t.meta.hash,subtestId:e.model.id,prototype:e.model.get("prototype"),sum:e.getSum()}),e.close(),this.abortAssessment!==!0&&this.index++,this.abortAssessment===!0&&(this.index=this.subtestViews.length-1),this.render(),window.scrollTo(0,0)):e.showErrors()},t}(Backbone.View);var AssessmentImportView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};AssessmentImportView=function(e){function t(){return this.updateProgress=__bind(this.updateProgress,this),this.updateActivity=__bind(this.updateActivity,this),this.updateFromActiveTasks=__bind(this.updateFromActiveTasks,this),this["import"]=__bind(this["import"],this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="AssessmentImportView",t.prototype.events={"click .import":"import","click .back":"back","click .verify":"verify","click .group_import":"groupImport"},t.prototype.groupImport=function(){var e=this;return $.ajax({url:Tangerine.settings.urlView("group","assessmentsNotArchived"),dataType:"jsonp",success:function(t){var n,r,i;return n=_.compact(function(){var e,n,i,s;i=t.rows,s=[];for(e=0,n=i.length;e<n;e++)r=i[e],s.push(r.id.substr(-5,5));return s}()).join(" "),i=new Assessment,i.on("status",e.updateActivity),i.updateFromServer(n)},error:function(e,t){return Utils.midAlert("Import error")}})},t.prototype.verify=function(){return Tangerine.user.ghostLogin(Tangerine.settings.upUser,Tangerine.settings.upPass)},t.prototype.initialize=function(e){var t,n=this;return this.noun=e.noun,this.connectionVerified=!1,Tangerine.settings.get("context")!=="server"?(this.timer=setTimeout(this.verify,2e4),t=$.ajax({url:Tangerine.settings.urlView("group","byDKey"),dataType:"jsonp",data:{keys:["testtest"]},timeout:5e3,success:function(){return clearTimeout(n.timer),n.connectionVerified=!0,n.render()}}),t.complete(function(){return console.log("complete")})):(this.connectionVerified=!0,this.render()),this.docsRemaining=0,this.serverStatus="checking...",$.ajax({dataType:"jsonp",url:Tangerine.settings.urlHost("group"),success:function(e,t){return n.serverStatus="Ok",n.updateServerStatus()},error:function(e,t){return n.serverStatus="Not available",n.updateServerStatus()}})},t.prototype.updateServerStatus=function(){return this.$el.find("#server_connection").html(this.serverStatus)},t.prototype.back=function(){return Tangerine.router.navigate("",!0),!1},t.prototype["import"]=function(){var e;return this.updateActivity(),e=this.$el.find("#d_key").val(),this.newAssessment=new Assessment,this.newAssessment.on("status",this.updateActivity),Tangerine.settings.get("context")==="server"?this.newAssessment.updateFromTrunk(e):this.newAssessment.updateFromServer(e),this.activeTaskInterval=setInterval(this.updateFromActiveTasks,3e3)},t.prototype.updateFromActiveTasks=function(){var e=this;return $.couch.activeTasks({success:function(t){var n,r,i,s;s=[];for(r=0,i=t.length;r<i;r++)n=t[r],n.type.toLowerCase()==="replication"?(_.isEmpty(n.status)||(e.activity=n.status),s.push(e.updateProgress())):s.push(void 0);return s}})},t.prototype.updateActivity=function(e,t){var n,r,i,s,o,u,a,f=this;return t!=null&&(o=u=r=0,t.docs_read!=null&&(o=t.docs_read),t.docs_written!=null&&(u=t.docs_written),t.doc_write_failures!=null&&(r=t.doc_write_failures),a=u!==1?"s":"",r!==0&&(i="        <b>"+r+"</b> failures<br>      "),t.no_changes!=null&&t.no_changes===!0&&(n="No changes")),this.$el.find(".status").fadeIn(250),this.activity="",e==="import lookup"?this.activity="Finding "+this.noun:e==="import success"?(clearInterval(this.activeTaskInterval),s="Import successful",o===0&&(s="Nothing imported"),this.activity=""+s+"<br>        <b>"+u+"</b> document"+a+" written<br>        "+(i||"")+"        "+(n||"")+"      ",this.updateProgress(null,function(){return Utils.askToLogout()})):e==="import error"&&(clearInterval(this.activeTaskInterval),this.activity="Import error: "+t),this.updateProgress()},t.prototype.updateProgress=function(e,t){var n,r,i;t==null&&(t={}),e!=null&&(this.importList[e]!=null?this.importList[e]++:this.importList[e]=1),n="<table>",i=this.importList;for(e in i)r=i[e],n+="<tr><td>"+e.titleize().pluralize()+"</td><td>"+r+"</td></tr>";return this.activity!=null&&(n+="<tr><td colspan='2'>"+this.activity+"</td></tr>"),n+="</table>",this.$el.find("#progress").html(n),typeof t=="function"?t():void 0},t.prototype.render=function(){var e,t;return Tangerine.settings.get("context")!=="server"&&(e="      <button class='command group_import'>Group import</button>    "),this.connectionVerified?t="        <div class='question'>          <label for='d_key'>Download keys</label>          <input id='d_key' value=''>          <button class='import command'>Import</button> "+(e||"")+"<br>          <small>Server connection: <span id='server_connection'>"+this.serverStatus+"</span></small>        </div>        <div class='confirmation status'>          <h2>Status<h2>          <div class='info_box' id='progress'></div>        </div>      ":t="        <section><p>Please wait while your connection is verified.</p>          <button class='command verify'>Try now</button>          <p><small>Note: If verification fails, press back to return to previous screen and please try again when internet connectivity is better.</small></p>        </section>      ",this.$el.html("      <button class='back navigation'>Back</button>      <h1>Tangerine Central Import</h1>      "+t+"    "),this.trigger("rendered")},t}(Backbone.View);var Subtest,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Subtest=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="subtest",t.prototype.initialize=function(e){this.templates=Tangerine.templates.get("prototypeTemplates");if(this.has("surveyAttributes")&&this.get("assessmentId")!==this.get("surveyAttributes").assessmentId)return this.save("surveyAttributes",{_id:this.id,assessmentId:this.get("assessmentId")})},t.prototype.loadPrototypeTemplate=function(e){var t,n,r;r=this.templates[e];for(t in r)n=r[t],this.set(t,n);return this.save()},t.prototype.copyTo=function(e){var t,n,r,i=this;return n=this.clone(),t=Utils.guid(),n.has("surveyAttributes")&&n.set("surveyAttributes",{_id:t,assessmentId:e}),n.save({_id:t,assessmentId:e,order:0,gridLinkId:""}),r=new Questions,r.fetch({key:this.get("assessmentId"),success:function(n){var r,s,o,u,a;o=n.where({subtestId:i.id});for(u=0,a=o.length;u<a;u++)s=o[u],r=s.clone(),r.save({assessmentId:e,_id:Utils.guid(),subtestId:t});return Tangerine.router.navigate("edit/"+e,!0),Utils.midAlert("Subtest copied")}})},t}(Backbone.Model);var Subtests,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Subtests=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="subtest",t.prototype.model=Subtest,t.prototype.db={view:"subtestsByAssessmentId"},t.prototype.comparator=function(e){return e.has("curriculumId")?parseInt(e.get("part"))*100+parseInt(e.get("order")):parseInt(e.get("order"))},t.prototype.initialize=function(e){},t.prototype.fetch=function(e){return t.__super__.fetch.call(this,e)},t.prototype.maintainOrder=function(){var e,t,n,r,i,s,o,u,a;i=function(){var e,n,r,i;r=this.models,i=[];for(e=0,n=r.length;e<n;e++)t=r[e],i.push(t.get("order"));return i}.call(this).join(""),n=function(){var n,r,i,s;i=this.models,s=[];for(e=n=0,r=i.length;n<r;e=++n)t=i[e],s.push(e);return s}.call(this).join("");if(i!==n){u=this.models,a=[];for(e=s=0,o=u.length;s<o;e=++s)r=u[e],r.set("order",e),a.push(r.save());return a}},t}(Backbone.Collection);var SubtestListEditView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};SubtestListEditView=function(e){function t(){return this.deleteSubtest=__bind(this.deleteSubtest,this),this.render=__bind(this.render,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="SubtestListEditView",t.prototype.tagName="ul",t.prototype.initialize=function(e){return this.assessment=e.assessment,this.views=[]},t.prototype.render=function(){var e=this;return this.closeViews(),this.assessment.subtests.sort(),this.assessment.subtests.each(function(t){var n;return n=new SubtestListElementView({subtest:t}),e.views.push(n),n.render(),n.on("subtest:delete",e.deleteSubtest),e.$el.append(n.el)})},t.prototype.deleteSubtest=function(e){return this.assessment.subtests.remove(e),e.destroy()},t.prototype.closeViews=function(){var e,t,n,r;r=this.views;for(t=0,n=r.length;t<n;t++)e=r[t],e.close();return this.views=[]},t}(Backbone.View);var SubtestListElementView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};SubtestListElementView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="subtest_element",t.prototype.tagName="li",t.prototype.events={"click .icon_edit":"edit","click .icon_delete":"toggleDeleteConfirm","click .delete_cancel":"toggleDeleteConfirm","click .delete_delete":"delete","click .icon_copy":"openCopyMenu","click .do_copy":"doCopy","click .cancel_copy":"cancelCopy"},t.prototype.toggleDeleteConfirm=function(){return this.$el.find(".delete_confirm").fadeToggle(250),!1},t.prototype["delete"]=function(){return this.trigger("subtest:delete",this.model),!1},t.prototype.edit=function(){return Tangerine.router.navigate("subtest/"+this.model.id,!0)},t.prototype.initialize=function(e){return this.model=e.subtest,this.group=e.group,this.$el.attr("data-id",this.model.id)},t.prototype.openCopyMenu=function(){return this.$el.find(".copy_menu").removeClass("confirmation"),this.$el.find(".copy_select").append("<option disabled='disabled' selected='selected'>Loading assessments...</option>"),this.fetchAssessments()},t.prototype.fetchAssessments=function(){var e,t=this;return this.groupAssessments=[],e=new Assessments,e.fetch({success:function(e){return t.groupAssessments=e.filter(function(e){return!e.getBoolean("archived")}),t.populateAssessmentSelector()}})},t.prototype.populateAssessmentSelector=function(){var e,t,n,r,i,s;n="",s=this.groupAssessments;for(r=0,i=s.length;r<i;r++)t=s[r],n+="<option data-assessmentId='"+t.id+"'>"+t.get("name")+"</option>";return e=this.$el.find(".copy_select").html(n)},t.prototype.doCopy=function(e){return this.model.copyTo(this.$el.find(".copy_select :selected").attr("data-assessmentId")),this.$el.find(".copy_menu").addClass("confirmation")},t.prototype.cancelCopy=function(){return this.$el.find(".copy_menu").addClass("confirmation")},t.prototype.render=function(){var e,t,n,r,i,s,o,u;return u=this.model.get("name"),o="<span class='small_grey'>"+this.model.get("prototype")+"</span>",i="<img src='images/icon_drag.png' title='Drag to reorder' class='icon sortable_handle'>",s="<img src='images/icon_edit.png' title='Edit' class='icon icon_edit'>",r="<img src='images/icon_delete.png' title='Delete' class='icon icon_delete'>",e="<img src='images/icon_copy_to.png' title='Copy to...' class='icon icon_copy'>",t="<div class='confirmation copy_menu'><select class='copy_select'></select><br><button class='do_copy command'>Copy</button> <button class='cancel_copy command'>Cancel</button></div>",n="<br><span class='delete_confirm'><div class='menu_box'>Confirm <button class='delete_delete command_red'>Delete</button> <button class='delete_cancel command'>Cancel</button></div></span>",this.$el.html("      <table><tr>      <td>"+i+"</td>      <td>        "+u+"        "+o+"        "+s+"        "+e+"        "+r+"        "+n+"        "+t+"      </td>      </tr></table>    "),this.trigger("rendered")},t}(Backbone.View);var SubtestEditView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};SubtestEditView=function(e){function t(){return this.save=__bind(this.save,this),this.goBack=__bind(this.goBack,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="subtest_edit",t.prototype.events={"click .back_button":"goBack","click .save_subtest":"saveSubtest","click .richtext_edit":"richtextEdit","click .richtext_save":"richtextSave","click .richtext_cancel":"richtextCancel"},t.prototype.richtextConfig=[{key:"enumerator",attributeName:"enumeratorHelp"},{key:"dialog",attributeName:"studentDialog"},{key:"transition",attributeName:"transitionComment"}],t.prototype.initialize=function(e){var t=this;return this.activity=null,this.timer=0,this.richtextKeys=_.pluck(this.richtextConfig,"key"),this.model=e.model,this.assessment=e.assessment,this.config=Tangerine.config.subtest,this.prototypeViews=Tangerine.config.get("prototypeViews"),this.prototypeEditor=new(window[this.prototypeViews[this.model.get("prototype")].edit])({model:this.model,parent:this}),this.prototypeEditor.on("question-edit",function(e){return t.save({questionSave:!1,success:function(){return Tangerine.router.navigate("question/"+e,!0)}})})},t.prototype.goBack=function(){return Tangerine.router.navigate("edit/"+this.model.get("assessmentId"),!0)},t.prototype.getRichtextConfig=function(e){var t,n,r;return _.isString(e)?r=e:(t=$(e.target),r=t.parent().attr("data-richtextKey")||t.parent().parent().attr("data-richtextKey")),n=_.where(this.richtextConfig,{key:r})[0].attributeName,{dataKey:r,attributeName:n}},t.prototype.richtextEdit=function(e){var t;return t=this.getRichtextConfig(e),this.$el.find("."+t.dataKey+"_preview, ."+t.dataKey+"_edit, ."+t.dataKey+"_buttons").fadeToggle(250),this.$el.find("textarea#"+t.dataKey+"_textarea").html(this.model.escape(t.attributeName)||"").cleditor()},t.prototype.richtextSave=function(e){var t,n,r=this;return t=this.getRichtextConfig(e),n={},n[t.attributeName]=this.$el.find("textarea#"+t.dataKey+"_textarea").val(),this.model.save,this.model.save(n,{success:function(){return r.richtextCancel(t.dataKey)},error:function(){return alert("Save error. Please try again.")}})},t.prototype.richtextCancel=function(e){var t,n,r;return r=this.getRichtextConfig(e),t=$("div."+r.dataKey+"_preview"),t.html(this.model.get(r.attributeName)||""),t.fadeIn(250),this.$el.find("button."+r.dataKey+"_edit, ."+r.dataKey+"_buttons").fadeToggle(250),n=this.$el.find("#"+r.dataKey+"_textarea").cleditor()[0],n.$area.insertBefore(n.$main),n.$area.removeData("cleditor"),n.$main.remove()},t.prototype.saveSubtest=function(){return this.save()},t.prototype.save=function(e){var t,n,r=this;return e==null&&(e={}),this.activity!==null?!1:(this.activity="saving",e.prototypeSave=e.prototypeSave!=null?e.prorotypeSave:!0,t=this.model.get("prototype"),this.model.set({name:this.$el.find("#subtest_name").val(),enumeratorHelp:this.$el.find("#enumerator_help").val(),studentDialog:this.$el.find("#student_dialog").val(),transitionComment:this.$el.find("#transition_comment").val(),skippable:this.$el.find("#skip_radio input:radio[name=skippable]:checked").val()==="true",enumeratorHelp:this.$el.find("#enumerator_textarea").val(),studentDialog:this.$el.find("#dialog_textarea").val(),transitionComment:this.$el.find("#transition_textarea").val()}),this.prototypeEditor.save(e),this.prototypeEditor.isValid()===!1?(Utils.midAlert("There are errors on this page"),typeof (n=this.prototypeEditor).showErrors=="function"&&n.showErrors(),this.activity=null):this.model.save(null,{success:function(){return r.activity=null,e.success?e.success():(Utils.midAlert("Subtest Saved"),clearTimeout(r.timer),r.timer=setTimeout(r.goBack,1e3))},error:function(){return r.activity=null,e.error!=null?e.error():Utils.midAlert("Save error")}}))},t.prototype.render=function(){var e,t,n,r,i,s,o,u;return e=this.assessment.escape("name"),r=this.model.escape("name"),i=this.model.get("prototype"),n=this.model.get("enumeratorHelp")||"",t=this.model.get("studentDialog")||"",o=this.model.get("transitionComment")||"",s=this.model.getBoolean("skippable"),this.$el.html("      <h1>Subtest Editor</h1>      <table class='basic_info'>        <tr>          <th>Assessment</th>          <td>"+e+"</td>        </tr>      </table>      <button class='save_subtest command'>Done</button>      <div id='subtest_edit_form' class='edit_form'>        <div class='label_value'>          <label for='subtest_name'>Name</label>          <input id='subtest_name' value='"+r+"'>        </div>        <div class='label_value'>          <label for='subtest_prototype' title='This is a basic type of subtest. (e.g. Survey, Grid, Location, Id, Consent). This property is set in assessment builder when you add a subtest. It is unchangeable.'>Prototype</label><br>          <div class='info_box'>"+i+"</div>        </div>        <div class='label_value'>          <label>Skippable</label><br>          <div class='menu_box'>            <div id='skip_radio' class='buttonset'>              <label for='skip_true'>Yes</label><input name='skippable' type='radio' value='true' id='skip_true' "+(s?"checked":void 0)+">              <label for='skip_false'>No</label><input name='skippable' type='radio' value='false' id='skip_false' "+(s?void 0:"checked")+">            </div>          </div>        </div>        <div class='label_value' data-richtextKey='enumerator'>          <label for='enumerator_textarea' title='If text is supplied, a help button will appear at the top of the subtest as a reference for the enumerator. If you are pasting from word it is recommended to paste into a plain text editor first, and then into this box.'>Enumerator help <button class='richtext_edit command'>Edit</button></label>          <div class='info_box_wide enumerator_preview'>"+n+"</div>          <textarea id='enumerator_textarea' class='confirmation'>"+n+"</textarea>          <div class='enumerator_buttons confirmation'>            <button class='richtext_save command'>Save</button>            <button class='richtext_cancel command'>Cancel</button>          </div>        </div>        <div class='label_value' data-richtextKey='dialog'>          <label for='dialog_textarea' title='Generally this is a script that will be read to the student. If you are pasting from word it is recommended to paste into a plain text editor first, and then into this box.'>Student Dialog <button class='richtext_edit command'>Edit</button></label>          <div class='info_box_wide dialog_preview'>"+t+"</div>          <textarea id='dialog_textarea' class='confirmation'>"+t+"</textarea>          <div class='dialog_buttons confirmation'>            <button class='richtext_save command'>Save</button>            <button class='richtext_cancel command'>Cancel</button>          </div>        </div>        <div class='label_value' data-richtextKey='transition'>          <label for='transition_testarea' title='This will be displayed with a grey background above the next button, similar to the student dialog text. If you are pasting from Word it is recommended to paste into a plain text editor first, and then into this box.'>Transition Comment <button class='richtext_edit command'>Edit</button></label>          <div class='info_box_wide transition_preview'>"+o+"</div>          <textarea id='transition_textarea' class='confirmation'>"+o+"</textarea>          <div class='transition_buttons confirmation'>            <button class='richtext_save command'>Save</button>            <button class='richtext_cancel command'>Cancel</button>          </div>        </div>      </div>      <div id='prototype_attributes'></div>      <button class='save_subtest command'>Done</button>      "),this.prototypeEditor.setElement(this.$el.find("#prototype_attributes")),typeof (u=this.prototypeEditor).render=="function"&&u.render(),this.trigger("rendered")},t.prototype.onClose=function(){var e;return typeof (e=this.prototypeEditor).close=="function"?e.close():void 0},t}(Backbone.View);var SubtestRunView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};SubtestRunView=function(e){function n(){return this.hideNext=__bind(this.hideNext,this),this.showNext=__bind(this.showNext,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="SubtestRunView",n.prototype.events={"click .next":"next","click .subtest_help":"toggleHelp","click .skip":"skip"},n.prototype.toggleHelp=function(){return this.$el.find(".enumerator_help").fadeToggle(250)},n.prototype.initialize=function(e){return this.protoViews=Tangerine.config.get("prototypeViews"),this.model=e.model,this.parent=e.parent,this.prototypeRendered=!1},n.prototype.render=function(){var e,n,r,i,s,o=this;return e=(this.model.get("enumeratorHelp")||"")!==""?"<button class='subtest_help command'>help</button><div class='enumerator_help'>"+this.model.get("enumeratorHelp")+"</div>":"",i=(this.model.get("studentDialog")||"")!==""?"<div class='student_dialog'>"+this.model.get("studentDialog")+"</div>":"",s=(this.model.get("transitionComment")||"")!==""?"<div class='student_dialog'>"+this.model.get("transitionComment")+"</div> <br>":"",n="<button class='skip navigation'>Skip</button>",r=this.model.get("skippable")===!0||this.model.get("skippable")==="true",this.$el.html("      <h2>"+this.model.get("name")+"</h2>      "+e+"      "+i+"      <div id='prototype_wrapper'></div>      <div class='controlls clearfix'>        "+s+"        <button class='next navigation'>"+t("next")+"</button>"+(r?n:"")+"      </div>    "),this.prototypeView=new(window[this.protoViews[this.model.get("prototype")].run])({model:this.model,parent:this}),this.prototypeView.on("rendered",function(){return o
.trigger("rendered")}),this.prototypeView.on("subRendered",function(){return o.trigger("subRendered")}),this.prototypeView.on("showNext",function(){return o.showNext()}),this.prototypeView.on("hideNext",function(){return o.hideNext()}),this.prototypeView.on("ready",function(){return o.prototypeRendered=!0}),this.prototypeView.setElement(this.$el.find("#prototype_wrapper")),this.prototypeView.render(),this.trigger("rendered")},n.prototype.showNext=function(){return this.$el.find(".controlls").show()},n.prototype.hideNext=function(){return this.$el.find(".controlls").hide()},n.prototype.getGridScore=function(){var e,t,n;n=this.model.get("gridLinkId")||"";if(n==="")return;return e=this.parent.model.subtests.get(this.model.get("gridLinkId")),t=this.parent.result.getGridScore(e.id),t},n.prototype.gridWasAutostopped=function(){var e,t,n;n=this.model.get("gridLinkId")||"";if(n==="")return;return e=this.parent.model.subtests.get(this.model.get("gridLinkId")),t=this.parent.result.gridWasAutostopped(e.id)},n.prototype.onClose=function(){var e;return(e=this.prototypeView)!=null?typeof e.close=="function"?e.close():void 0:void 0},n.prototype.isValid=function(){return this.prototypeRendered?this.prototypeView.isValid!=null?this.prototypeView.isValid():!1:!1},n.prototype.showErrors=function(){return this.prototypeView.showErrors()},n.prototype.getSum=function(){return this.prototypeView.getSum!=null?this.prototypeView.getSum():{correct:0,incorrect:0,missing:0,total:0}},n.prototype.abort=function(){return this.parent.abort()},n.prototype.getResult=function(){var e,t;return t=this.prototypeView.getResult(),this.model.has("hash")&&(e=this.model.get("hash")),{body:t,meta:{hash:e}}},n.prototype.getSkipped=function(){if(this.prototypeView.getSkipped!=null)return this.prototypeView.getSkipped();throw"Prototype skipping not implemented"},n.prototype.next=function(){return this.parent.next()},n.prototype.skip=function(){return this.parent.skip()},n}(Backbone.View);var ConsentRunView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ConsentRunView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="ConsentRunView",n.prototype.events={"click #non_consent_confirm":"noConsent","click #consent_yes":"clearMessages","click #consent_no":"showNonConsent"},n.prototype.initialize=function(e){return this.confirmedNonConsent=!1,this.model=this.options.model,this.parent=this.options.parent},n.prototype.render=function(){return this.$el.html("    <form>      <div class='question'>        <label>"+(this.model.get("prompt")||"Does the child consent?")+"</label>        <div class='messages'></div>        <div class='non_consent_form confirmation'>          <div>"+t("click to confirm consent not obtained")+"</div>          <button id='non_consent_confirm'>"+t("confirm")+"</button>        </div>        <div id='consent_options' class='buttonset'>          <label for='consent_yes'>"+t("yes, continue")+"</label>          <input id='consent_yes' type='radio' name='participant_consents' value='yes'>          <label for='consent_no'>"+t("no, stop")+"</label>          <input id='consent_no' type='radio' name='participant_consents' value='no'>        </div>      </div>    </form>    "),this.trigger("rendered"),this.trigger("ready")},n.prototype.isValid=function(){return this.confirmedNonConsent===!1?this.$el.find("input[name=participant_consents]:checked").val()==="yes"?!0:!1:!0},n.prototype.showNonConsent=function(){return this.$el.find(".non_consent_form").show(250)},n.prototype.clearMessages=function(){return this.$el.find(".non_consent_form").hide(250),this.$el.find(".messages").html("")},n.prototype.noConsent=function(){return this.confirmedNonConsent=!0,this.parent.abort(),!1},n.prototype.getSkipped=function(){return{consent:"skipped"}},n.prototype.showErrors=function(){var e;e=this.$el.find("input[name=participant_consents]:checked").val();if(e==="no")return Utils.midAlert(t("please confirm")),this.showNonConsent;if(e===void 0)return $(".messages").html(t("please select one."))},n.prototype.getResult=function(){return{consent:this.$el.find("input[name=participant_consents]:checked").val()}},n.prototype.getSum=function(){return{correct:1,incorrect:0,missing:0,total:1}},n}(Backbone.View);var ConsentEditView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ConsentEditView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="ConsentEditView",t.prototype.initialize=function(e){return this.model=e.model,this.parent=e.parent},t.prototype.isValid=function(){return!0},t.prototype.save=function(){return this.model.set({prompt:this.$el.find("#consent_prompt").val()})},t.prototype.render=function(){var e;return e=this.model.get("prompt")||"",this.$el.html("      <div class='label_value'>        <label for='consent_prompt'>Consent prompt</label>        <input id='consent_prompt' value='"+e+"'>      </div>    ")},t}(Backbone.View);var DatetimeRunView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};DatetimeRunView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="datetime",n.prototype.initialize=function(e){return this.model=this.options.model,this.parent=this.options.parent},n.prototype.render=function(){var e,n,r,i,s,o;return e=new Date,o=e.getFullYear(),i=[t("jan"),t("feb"),t("mar"),t("apr"),t("may"),t("jun"),t("jul"),t("aug"),t("sep"),t("oct"),t("nov"),t("dec")][e.getMonth()],n=e.getDate(),r=e.getMinutes(),r<10&&(r="0"+r),s=e.getHours()+":"+r,this.$el.html("      <div class='question'>        <table>          <tr>            <td><label for='year'>"+t("year")+"</label><input id='year' name='year' value='"+o+"'></td>            <td><label for='month'>"+t("month")+"</label><input id='month' type='month' name='month' value='"+i+"'></td>            <td><label for='day'>"+t("day")+"</label><input id='day' type='day' name='day' value='"+n+"'></td>          </tr>          <tr>            <td><label for='time'>"+t("time")+"</label><br><input type='text' id='time' name='time' value='"+s+"'></td>          </tr>        </table>      </div>      "),this.trigger("rendered"),this.trigger("ready")},n.prototype.getResult=function(){return{year:this.$el.find("#year").val(),month:this.$el.find("#month").val(),day:this.$el.find("#day").val(),time:this.$el.find("#time").val()}},n.prototype.getSkipped=function(){return{year:"skipped",month:"skipped",day:"skipped",time:"skipped"}},n.prototype.getSum=function(){return{correct:1,incorrect:0,missing:0,total:1}},n.prototype.isValid=function(){return!0},n}(Backbone.View);var DatetimeEditView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};DatetimeEditView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="DatetimeEditView",t.prototype.initialize=function(e){return this.model=e.model,this.parent=e.parent},t.prototype.save=function(){},t.prototype.isValid=function(){return!0},t}(Backbone.View);var LocationRunView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};LocationRunView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="LocationRunView",n.prototype.events={"click .school_list li":"autofill","keyup input":"showOptions","click .clear":"clearInputs"},n.prototype.initialize=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;this.model=this.options.model,this.parent=this.options.parent,this.levels=this.model.get("levels")||[],this.locations=this.model.get("locations")||[],this.levels.length===1&&this.levels[0]===""&&(this.levels=[]),this.locations.length===1&&this.locations[0]===""&&(this.locations=[]),this.haystack=[],h=this.locations;for(t=o=0,f=h.length;o<f;t=++o){r=h[t],this.haystack[t]=[];for(u=0,l=r.length;u<l;u++)i=r[u],this.haystack[t].push(i.toLowerCase())}s="<li data-index='{{i}}'>",p=this.levels;for(t=a=0,c=p.length;a<c;t=++a)n=p[t],s+="{{level_"+t+"}}",t!==this.levels.length-1&&(s+=" - ");return s+="</li>",this.li=_.template(s)},n.prototype.clearInputs=function(){var e,t,n,r,i,s;i=this.levels,s=[];for(e=n=0,r=i.length;n<r;e=++n)t=i[e],s.push(this.$el.find("#level_"+e).val(""));return s},n.prototype.autofill=function(e){var t,n,r,i,s,o,u,a;this.$el.find(".autofill").fadeOut(250),n=$(e.target).attr("data-index"),i=this.locations[n],u=this.levels,a=[];for(t=s=0,o=u.length;s<o;t=++s)r=u[t],a.push(this.$el.find("#level_"+t).val(i[t]));return a},n.prototype.showOptions=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;u=$(e.target).val().toLowerCase(),n=parseInt($(e.target).attr("data-level"));for(a=h=0,E=this.haystack.length;0<=E?h<=E:h>=E;a=0<=E?++h:--h)this.$el.find("#autofill_"+a).hide();t=!1,l=[],S=this.haystack;for(i=p=0,m=S.length;p<m;i=++p)c=S[i],s=~this.haystack[i][n].indexOf(u),s&&l.push(i),s&&(t=!0);x=this.haystack;for(i=d=0,g=x.length;d<g;i=++d){c=x[i];for(o=v=0,y=c.length;v<y;o=++v){a=c[o];if(o===n)continue;s=~this.haystack[i][o].indexOf(u),s&&!~l.indexOf(i)&&l.push(i),s&&(t=!0)}}if(t){r="";for(w=0,b=l.length;w<b;w++)f=l[w],r+=this.getLocationLi(f);return this.$el.find("#autofill_"+n).fadeIn(250),this.$el.find("#school_list_"+n).html(r)}return this.$el.find("#autofill_"+n).fadeOut(250)},n.prototype.getLocationLi=function(e){var t,n,r,i,s,o;r={i:e},o=this.locations[e];for(t=i=0,s=o.length;i<s;t=++i)n=o[t],r["level_"+t]=n;return this.li(r)},n.prototype.render=function(){var e,n,r,i,s,o,u;i="",e="      <button class='clear command'>"+t("clear")+"</button>      ",u=this.levels;for(n=s=0,o=u.length;s<o;n=++s)r=u[n],e+="        <div class='label_value'>          <label for='level_"+n+"'>"+r+"</label><br>          <input data-level='"+n+"' id='level_"+n+"' value=''>        </div>        <div id='autofill_"+n+"' class='autofill' style='display:none'>          <h2>"+t("select one from autofill list")+"</h2>          <ul class='school_list' id='school_list_"+n+"'>          </ul>        </div>    ";return this.$el.html(e),this.trigger("rendered"),this.trigger("ready")},n.prototype.getResult=function(){var e,t;return{labels:function(){var e,n,r,i;r=this.levels,i=[];for(e=0,n=r.length;e<n;e++)t=r[e],i.push(t.replace(/[\s-]/g,"_"));return i}.call(this),location:function(){var n,r,s,o;s=this.levels,o=[];for(e=n=0,r=s.length;n<r;e=++n)t=s[e],o.push($.trim(this.$el.find("#level_"+e).val()));return o}.call(this)}},n.prototype.getSkipped=function(){var e,t;return{labels:function(){var e,n,r,i;r=this.levels,i=[];for(e=0,n=r.length;e<n;e++)t=r[e],i.push(t.replace(/[\s-]/g,"_"));return i}.call(this),location:function(){var n,r,s,o;s=this.levels,o=[];for(e=n=0,r=s.length;n<r;e=++n)t=s[e],o.push("skipped");return o}.call(this)}},n.prototype.isValid=function(){var e,t,n,r;this.$el.find(".message").remove(),r=this.$el.find("input");for(t=0,n=r.length;t<n;t++){e=r[t];if($(e).val()==="")return!1}return!0},n.prototype.showErrors=function(){var e,n,r,i,s;i=this.$el.find("input"),s=[];for(n=0,r=i.length;n<r;n++)e=i[n],$(e).val()===""?s.push($(e).after(" <span class='message'>"+$("label[for="+$(e).attr("id")+"]").text()+" "+t("cannot be empty")+"</span>")):s.push(void 0);return s},n.prototype.getSum=function(){var e,t,n,r,i,s;t={correct:0,incorrect:0,missing:0,total:0},s=this.$el.find("input");for(r=0,i=s.length;r<i;r++)n=s[r],e=$(n),(e.val()||"")!==""&&(t.correct+=1),(e.val()||"")===""&&(t.missing+=1),t.total+=1;return{correct:t.correct,incorrect:t.incorrect,missing:t.missing,total:t.total}},n}(Backbone.View);var LocationEditView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};LocationEditView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="LocationEditView",t.prototype.events={"keyup #data":"updateData","keyup #levels":"updateLevels","click #data_format input":"updateData","click #levels_format input":"updateLevels"},t.prototype.updateData=function(e){var t,n,r;return(e!=null?e.type:void 0)==="click"?$(e.target).val()==="Tabs"?(this.dataCommaToTab(),r=!0,n=!1):(this.dataTabToComma(),r=!1,n=!0):(t=this.$el.find("#data").val(),r=t.match(/\t/g)!=null,n=t.match(/,/g)!=null),r?(this.$el.find("#data_format :radio[value='Tabs']").attr("checked","checked"),this.$el.find("#data_format").buttonset("refresh")):(this.$el.find("#data_format :radio[value='Commas']").attr("checked","checked"),this.$el.find("#data_format").buttonset("refresh"))},t.prototype.updateLevels=function(e){var t,n,r;return(e!=null?e.type:void 0)==="click"?$(e.target).val()==="Tabs"?(this.levelsCommaToTab(),n=!0,t=!1):(this.levelsTabToComma(),n=!1,t=!0):(r=this.$el.find("#levels").val(),n=r.match(/\t/g)!=null,t=r.match(/,/g)!=null),r=this.$el.find("#levels").val(),n=r.match(/\t/g)!=null,t=r.match(/,/g)!=null,n?(this.$el.find("#levels_format :radio[value='Tabs']").attr("checked","checked"),this.$el.find("#levels_format").buttonset("refresh")):(this.$el.find("#levels_format :radio[value='Commas']").attr("checked","checked"),this.$el.find("#levels_format").buttonset("refresh"))},t.prototype.dataTabToComma=function(){return this.$el.find("#data").val(String(this.$el.find("#data").val()).replace(/\t/g,", "))},t.prototype.dataCommaToTab=function(){return this.$el.find("#data").val(this.$el.find("#data").val().replace(/, */g,"	"))},t.prototype.levelsTabToComma=function(){return this.$el.find("#levels").val(String(this.$el.find("#levels").val()).replace(/\t/g,", "))},t.prototype.levelsCommaToTab=function(){return this.$el.find("#levels").val(this.$el.find("#levels").val().replace(/, */g,"	"))},t.prototype.save=function(){var e,t,n,r,i,s,o,u,a,f;this.$el.find("#data").val().match(/\t/g)!=null&&(this.$el.find("#data_format :radio[value='Tabs']").attr("checked","checked"),this.$el.find("#data_format").buttonset("refresh"),this.dataTabToComma()),this.$el.find("#levels").val().match(/\t/g)!=null&&(this.levelsTabToComma(),this.$el.find("#levels_format :radio[value='Tabs']").attr("checked","checked"),this.$el.find("#levels_format").buttonset("refresh")),n=this.$el.find("#levels").val().split(/, */g);for(e=o=0,a=n.length;o<a;e=++o)t=n[e],n[e]=$.trim(t).replace(/[^a-zA-Z0-9']/g,"");s=$.trim(this.$el.find("#data").val()),i=s.split("\n");for(e=u=0,f=i.length;u<f;e=++u)r=i[e],i[e]=r.split(/, */g);return this.model.set({levels:n,locations:i})},t.prototype.isValid=function(){var e,t,n,r,i;e=this.model.get("levels"),i=this.model.get("locations");for(n=0,r=i.length;n<r;n++)t=i[n],t.length!==e.length&&__indexOf.call(this.errors,"column_match")<0&&this.errors.push("column_match");return this.errors.length===0},t.prototype.showErrors=function(){var e,t,n,r,i;e="Please correct the following errors:\n\n",i=this.errors;for(n=0,r=i.length;n<r;n++)t=i[n],e+=this.errorMessages[t];return alert(e),this.errors=[]},t.prototype.initialize=function(e){return this.errors=[],this.model=e.model,this.errorMessages={column_match:"Some columns in the location data do not match the number of columns in the geographic levels."}},t.prototype.render=function(){var e,t,n,r,i,s;t=this.model.get("levels")||[],r=this.model.get("locations")||[],t=_.escape(t.join(", ")),r=r.join("\n");if(_.isArray(r))for(e=i=0,s=r.length;i<s;e=++i)n=r[e],r[e]=_.escape(n.join(", "));return this.$el.html("      <div class='label_value'>        <div class='menu_box'>          <label for='levels' title='This is a comma separated list of geographic levels. (E.g. Country, Province, District, School Id) These are the levels that you would consider individual fields on the location form.'>Geographic Levels</label>          <input id='levels' value='"+t+"'>          <label title='Tangerine uses comma separated values. If you copy and paste from another program like Excel, the values will be tab separated. These buttons allow you to switch back and forth, however, Tangerine will always save the comma version.'>Format</label><br>          <div id='levels_format' class='buttonset'>            <label for='levels_tabs'>Tabs</label>            <input id='levels_tabs' name='levels_format' type='radio' value='Tabs'>            <label for='levels_commas'>Commas</label>            <input id='levels_commas' name='levels_format' type='radio' value='Commas'>          </div>        </div>      </div>      <div class='label_value'>        <div class='menu_box'>          <label for='data' title='Comma sperated values, with multiple rows separated by line. This information will be used to autofill the location data.'>Location data</label>          <textarea id='data'>"+r+"</textarea><br>          <label title='Tangerine uses comma separated values. If you copy and paste from another program like Excel, the values will be tab separated. These buttons allow you to switch back and forth, however, Tangerine will always save the comma version.'>Format</label><br>        <div id='data_format' class='buttonset'>            <label for='data_tabs'>Tabs</label>            <input id='data_tabs' name='data_format' type='radio' value='Tabs'>            <label for='data_commas'>Commas</label>            <input id='data_commas' name='data_format' type='radio' value='Commas'>        </div>              </div>    "),this.updateLevels(),this.updateData()},t}(Backbone.View);var ResultOfMultiple,ResultOfPrevious,ResultOfQuestion,SurveyRunView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ResultOfQuestion=function(e){return $("#question-"+e).attr("data-result")},ResultOfMultiple=function(e){var t,n,r,i,s;n=[],s=$("#question-"+e+" input:checked");for(r=0,i=s.length;r<i;r++)t=s[r],n.push($(t).val());return n},ResultOfPrevious=function(e){return vm.currentView.result.getVariable(e)},SurveyRunView=function(e){function n(){return this.onQuestionRendered=__bind(this.onQuestionRendered,this),this.getResult=__bind(this.getResult,this),this.updateSkipLogic=__bind(this.updateSkipLogic,this),this.onQuestionAnswer=__bind(this.onQuestionAnswer,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="SurveyRunView",n.prototype.events={"change input":"updateSkipLogic","change textarea":"updateSkipLogic"},n.prototype.initialize=function(e){var t=this;return this.model=this.options.model,this.parent=this.options.parent,this.isObservation=this.options.isObservation,this.questionViews=[],this.answered=[],this.renderCount=0,this.questions=new Questions,this.questions.fetch({key:this.model.get("assessmentId"),success:function(e){return t.questions=new Questions(t.questions.where({subtestId:t.model.id})),t.questions.sort(),t.render()}})},n.prototype.onQuestionAnswer=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;if(this.isObservation){r=$(e.target).attr("data-cid"),h=this.questionViews;for(f=0,c=h.length;f<c;f++){a=h[f];if(a.cid===r&&a.type!=="multiple"){u=$(a.el).next();while(u.length!==0&&u.hasClass("disabled_skipped"))u=$(u).next();u.length!==0&&u.scrollTo()}}}this.autostopped=!1,n=parseInt(this.model.get("autostopLimit"))||0,o=0,t=0;if(n>0)for(s=l=1,p=this.questionViews.length;1<=p?l<=p:l>=p;s=1<=p?++l:--l)i=this.questionViews[s-1].answer,i==="0"||i==="9"?t++:t=0,o=Math.max(o,t),n!==0&&o>=n&&!this.autostopped&&(this.autostopped=!0,this.autostopIndex=s);return this.updateAutostop()},n.prototype.updateAutostop=function(){var e,t,n,r,i,s,o;e=parseInt(this.model.get("autostopLimit"))||0,s=this.questionViews,o=[];for(t=r=0,i=s.length;r<i;t=++r)n=s[t],t>this.autostopIndex-1?(this.autostopped&&n.$el.addClass("disabled_autostop"),this.autostopped?o.push(void 0):o.push(n.$el.removeClass("disabled_autostop"))):o.push(void 0);return o},n.prototype.updateSkipLogic=function(){return this.questions.each(function(e){var t,n;n=e.get("skipLogic");if(!_.isEmpty(n))return t=CoffeeScript.eval(n),t?$("#question-"+e.get("name")).addClass("disabled_skipped"):$("#question-"+e.get("name")).removeClass("disabled_skipped")}),_.each(this.questionViews,function(e){return e.updateValidity()})},n.prototype.isValid=function(){var e,t,n,r,i;i=this.questionViews;for(e=n=0,r=i.length;n<r;e=++n){t=i[e],t.updateValidity();if(t.isValid!=null&&t.model.get("skippable")!=="true"&&t.model.get("skippable")!==!0&&!t.isValid)return!1}return!0},n.prototype.getSkipped=function(){var e,t,n,r,i,s;n={},s=this.questionViews;for(e=r=0,i=s.length;r<i;e=++r)t=s[e],n[this.questions.models[e].get("name")]="skipped";return n},n.prototype.getResult=function(){var e,t,n,r,i,s;n={},s=this.questionViews;for(e=r=0,i=s.length;r<i;e=++r)t=s[e],n[this.questions.models[e].get("name")]=t.notAsked?t.notAskedResult:_.isEmpty(t.answer)?t.skipped?t.skippedResult:t.$el.hasClass("disabled_skipped")?t.logicSkippedResult:t.$el.hasClass("disabled_autostop")?t.notAskedAutostopResult:t.answer:t.answer;return n},n.prototype.getSum=function(){var e,t,n,r,i,s;e={correct:0,incorrect:0,missing:0,total:0},s=this.questionViews;for(t=r=0,i=s.length;r<i;t=++r)n=s[t],_.isString(n)?e.missing++:(n.isValid&&(e.correct+=1),n.isValid||(e.incorrect+=1),!n.isValid&&n.model.get(n.model.get(!1))&&(e.missing+=1),e.total+=1);return{correct:e.correct,incorrect:e.incorrect,missing:e.missing,total:e.total}},n.prototype.showErrors=function(){var e,n,r,i,s,o,u,a,f;this.$el.find(".message").remove(),n=!0,a=this.questionViews,f=[];for(r=o=0,u=a.length;o<u;r=++o)s=a[r],_.isString(s)?f.push(void 0):(i="",s.isValid||(e=s.model.get("customValidationMessage"),_.isEmpty(e)?i=t("please answer this question"):i=e,n===!0&&(s.$el.scrollTo(),Utils.midAlert(t("please correct the errors on this page")),n=!1)),f.push(s.setMessage(i)));return f},n.prototype.render=function(){var e,t,n,r,i,s,o,u,a,f;n=0,this.questions.sort();if(this.questions.models!=null){f=this.questions.models;for(e=u=0,a=f.length;u<a;e=++u)i=f[e],s=parseInt(i.get("linkedGridScore"))||0,t=(s!==0&&this.parent.getGridScore()<s||this.parent.gridWasAutostopped())&&this.parent.getGridScore()!==!1,t&&n++,r=new QuestionRunView({model:i,parent:this,notAsked:t,isObservation:this.isObservation}),r.on("rendered",this.onQuestionRendered),r.on("answer scroll",this.onQuestionAnswer),r.render(),this.questionViews[e]=r,this.$el.append(r.el)}return this.updateSkipLogic(),this.questions.length===n&&typeof (o=this.parent).next=="function"&&o.next(),this.trigger("rendered")},n.prototype.onQuestionRendered=function(){return this.renderCount++,this.renderCount===this.questions.length&&this.trigger("ready"),this.trigger("subRendered")},n.prototype.onClose=function(){var e,t,n,r;r=this.questionViews;for(t=0,n=r.length;t<n;t++)e=r[t],typeof e.close=="function"&&e.close();return this.questionViews=[]},n}(Backbone.View);var SurveyEditView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};SurveyEditView=function(e){function t(){return this.renderQuestions=__bind(this.renderQuestions,this),this.toggleAddQuestion=__bind(this.toggleAddQuestion,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="SurveyEditView",t.prototype.events={"click .add_question":"toggleAddQuestion","click .add_question_cancel":"toggleAddQuestion","click .add_question_add":"addQuestion","keypress #question_name":"addQuestion"},t.prototype.initialize=function(e){var t=this;return this.model=e.model,this.parent=e.parent,this.model.questions=new Questions,Utils.working(!0),this.model.questions.fetch({key:this.model.get("assessmentId"),success:function(){return Utils.working(!1),t.model.questions=new Questions(t.model.questions.where({subtestId:t.model.id})),t.model.questions.maintainOrder(),t.questionsEditView=new QuestionsEditView({questions:t.model.questions}),t.questionsEditView.on("question-edit",function(e){return t.trigger("question-edit",e)}),t.model.questions.on("change",t.renderQuestions),t.renderQuestions()},erorr:function(e,t){return Utils.working(!1),Utils.midAlert("Error<br>Could not load questions<br>"+e+", "+t,5e3)}})},t.prototype.toggleAddQuestion=function(){var e=this;return this.$el.find("#add_question_form, .add_question").fadeToggle(250,function(){if(e.$el.find("#add_question_form").is(":visible"))return e.$el.find("#question_prompt").focus()}),!1},t.prototype.addQuestion=function(e){var t,n;return e.type!=="click"&&e.which!==13?!0:(t=$.extend(Tangerine.templates.get("questionTemplate"),{subtestId:this.model.id,assessmentId:this.model.get("assessmentId"),id:Utils.guid(),order:this.model.questions.length,prompt:this.$el.find("#question_prompt").val(),name:this.$el.find("#question_name").val().safetyDance()}),n=this.model.questions.create(t),this.renderQuestions(),this.$el.find("#add_question_form input").val(""),this.$el.find("#question_prompt").focus(),!1)},t.prototype.isValid=function(){return!0},t.prototype.save=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;e.questionSave=e.questionSave?e.questionSave:!0,this.model.set({gridLinkId:this.$el.find("#link_select option:selected").val(),autostopLimit:parseInt(this.$el.find("#autostop_limit").val())||0}),r=[],t=[],o=[],c=this.model.questions.models;for(n=a=0,f=c.length;a<f;n=++a)s=c[n],s.get("type")!=="open"&&((h=s.get("options"))!=null?h.length:void 0)===0&&(t.push(n+1),e.questionSave&&(s.save()||r.push(n),s.has("linkedGridScore")&&s.get("linkedGridScore")!==""&&s.get("linkedGridScore")!==0&&this.model.has("gridLinkId")===""&&this.model.get("gridLinkId")===""&&o.push(n)));r.length!==0&&Utils.midAlert("Error<br><br>Questions: <br>"+r.join(", ")+"<br>not saved"),t.length!==0&&(i=t.length>1,l=i?"Questions":"Question",u=i?"have":"has",alert("Warning\n\n"+l+" "+t.join(" ,")+" "+u+" no options."));if(o.length!==0)return i=t.length>1,l=i?"Questions":"Question",p=i?"require":"requires",alert("Warning\n\n"+l+" "+o.join(" ,")+" "+p+" a grid to be linked to this test.")},t.prototype.onClose=function(){var e;return(e=this.questionsListEdit)!=null?e.close():void 0},t.prototype.renderQuestions=function(){var e,t;return this.$el.find("#question_list_wrapper").empty(),(e=this.questionsEditView)!=null&&e.render(),this.$el.find("#question_list_wrapper").append((t=this.questionsEditView)!=null?t.el:void 0)},t.prototype.render=function(){var e,t,n,r=this;return t=this.model.get("gridLinkId")||"",e=parseInt(this.model.get("autostopLimit"))||0,this.$el.html("      <div class='label_value'>        <label for='autostop_limit' title='The survey will discontinue after the first N questions have been answered with a &quot;0&quot; value option.'>Autostop after N incorrect</label><br>        <input id='autostop_limit' type='number' value='"+e+"'>      </div>      <div id='grid_link'></div>      <div id='questions'>        <h2>Questions</h2>        <div class='menu_box'>          <div id='question_list_wrapper'><img class='loading' src='images/loading.gif'></div>          <button class='add_question command'>Add Question</button>          <div id='add_question_form' class='confirmation'>            <div class='menu_box'>              <h2>New Question</h2>              <label for='question_prompt'>Prompt</label>              <input id='question_prompt'>              <label for='question_name'>Variable name</label>              <input id='question_name' title='Allowed characters: A-Z, a-z, 0-9, and underscores.'><br>              <button class='add_question_add command'>Add</button><button class='add_question_cancel command'>Cancel</button>            </div>          </div>         </div>      </div>"),this.renderQuestions(),n=new Subtests,n.fetch({key:this.model.get("assessmentId"),success:function(e){var n,i,s,o;e=e.where({prototype:"grid"}),n="          <div class='label_value'>            <label for='link_select'>Linked to grid</label><br>            <div class='menu_box'>              <select id='link_select'>              <option value=''>None</option>";for(s=0,o=e.length;s<o;s++)i=e[s],n+="<option value='"+i.id+"' "+(t===i.id?"selected":"")+">"+i.get("name")+"</option>";return n+="</select></div></div>",r.$el.find("#grid_link").html(n)}})},t}(Backbone.View);var IdRunView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};IdRunView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="id",n.prototype.events={"click #generate":"generate","change #participant_id":"setValidator"},n.prototype.initialize=function(e){return this.model=this.options.model,this.parent=this.options.parent,this.validator=new CheckDigit},n.prototype.render=function(){return this.$el.html("    <form>      <label for='participant_id'>"+t("random identifier")+"</label>      <input id='participant_id' name='participant_id'>      <button id='generate' class='command'>"+t("generate")+"</button>      <div class='messages'></div>    </form>"),this.trigger("rendered"),this.trigger("ready")},n.prototype.getResult=function(){return{participant_id:this.$el.find("#participant_id").val()}},n.prototype.getSkipped=function(){return{participant_id:"skipped"}},n.prototype.getSum=function(){return{correct:1,incorrect:0,missing:0,total:1}},n.prototype.setValidator=function(){return this.validator.set(this.$el.find("#participant_id").val())},n.prototype.isValid=function(){return this.setValidator(),this.validator.isValid()?this.updateNavigation():!1},n.prototype.showErrors=function(){return this.$el.find(".messages").html(this.validator.getErrors().join(", "))},n.prototype.generate=function(){return this.$el.find(".messages").empty(),this.$el.find("#participant_id").val(this.validator.generate()),!1},n.prototype.updateNavigation=function(){return Tangerine.nav.setStudent(this.$el.find("#participant_id").val())},n}(Backbone.View);var IdEditView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};IdEditView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="IdEditView",t.prototype.initialize=function(e){return this.model=e.model,this.parent=e.parent},t.prototype.isValid=function(){return!0},t.prototype.save=function(){},t}(Backbone.View);var GridRunView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};GridRunView=function(e){function n(){return this.updateMode=__bind(this.updateMode,this),this.updateCountdown=__bind(this.updateCountdown,this),this.removeUndo=__bind(this.removeUndo,this),this.lastHandler=__bind(this.lastHandler,this),this.intermediateItemHandler=__bind(this.intermediateItemHandler,this),this.markHandler=__bind(this.markHandler,this),this.gridClick=__bind(this.gridClick,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="grid_prototype",n.prototype.events=Modernizr.touch?{"touchstart .grid_element":"gridClick","touchstart .end_of_grid_line":"endOfGridLineClick","click .grid_mode":"updateMode","click .start_time":"startTimer","click .stop_time":"stopTimer","click .restart":"restartTimer"}:{"click .end_of_grid_line":"endOfGridLineClick","click .grid_element"
:"gridClick","click .grid_mode":"updateMode","click .start_time":"startTimer","click .stop_time":"stopTimer","click .restart":"restartTimer"},n.prototype.restartTimer=function(){return this.timeRunning&&this.stopTimer({simpleStop:!0}),this.resetVariables(),this.$el.find(".element_wrong").removeClass("element_wrong")},n.prototype.gridClick=function(e){var t,n;return typeof (t=this.modeHandlers)[n=this.mode]=="function"?t[n](e):void 0},n.prototype.markHandler=function(e){var t,n;t=$(e.target),n=t.attr("data-index");if(parseInt(this.lastAttempted)!==0&&parseInt(n)>parseInt(this.lastAttempted))return;this.markElement(n);if(this.autostop!==0)return this.checkAutostop()},n.prototype.intermediateItemHandler=function(e){var t,n;return this.timeIntermediateCaptured=this.getTime()-this.startTime,t=$(e.target),n=t.attr("data-index"),this.itemAtTime=n,t.addClass("element_minute"),this.updateMode(null,"mark")},n.prototype.checkAutostop=function(){var e,t,n,r;if(this.timeRunning){e=0;for(t=n=0,r=this.autostop-1;0<=r?n<=r:n>=r;t=0<=r?++n:--n){if(this.gridOutput[t]==="correct")break;e++}this.autostopped===!1&&e===this.autostop&&this.autostopTest();if(this.autostopped===!0&&e<this.autostop&&this.undoable===!0)return this.unAutostopTest()}},n.prototype.markElement=function(e,t){var n;t==null&&(t=null);if(parseInt(this.lastAttempted)!==0&&parseInt(e)>parseInt(this.lastAttempted))return;n=this.$el.find(".grid_element[data-index="+e+"]"),this.markRecord.push(e);if(!this.autostopped){if(t===null)return this.gridOutput[e-1]=this.gridOutput[e-1]==="correct"?"incorrect":"correct",n.toggleClass("element_wrong");this.gridOutput[e-1]=t;if(t==="incorrect")return n.addClass("element_wrong");if(t==="correct")return n.removeClass("element_wrong")}},n.prototype.endOfGridLineClick=function(e){var t,n,r,i,s,o,u;if(this.mode==="mark"){t=$(e.target);if(t.hasClass("element_wrong")){t.removeClass("element_wrong"),r=t.attr("data-index");for(n=i=r,o=r-(this.columns-1);r<=o?i<=o:i>=o;n=r<=o?++i:--i)this.markElement(n,"correct")}else if(!t.hasClass("element_wrong")&&!this.autostopped){t.addClass("element_wrong"),r=t.attr("data-index");for(n=s=r,u=r-(this.columns-1);r<=u?s<=u:s>=u;n=r<=u?++s:--s)this.markElement(n,"incorrect")}if(this.autostop!==0)return this.checkAutostop()}},n.prototype.lastHandler=function(e){var t,n;t=$(e.target),n=t.attr("data-index");if(n-1>=this.gridOutput.lastIndexOf("incorrect"))return this.$el.find(".element_last").removeClass("element_last"),t.addClass("element_last"),this.lastAttempted=n},n.prototype.startTimer=function(){if(this.timerStopped===!1&&this.timeRunning===!1)return this.interval=setInterval(this.updateCountdown,1e3),this.startTime=this.getTime(),this.timeRunning=!0,this.updateMode(null,"mark"),this.enableGrid(),this.updateCountdown()},n.prototype.enableGrid=function(){return this.$el.find("table.disabled, div.disabled").removeClass("disabled")},n.prototype.stopTimer=function(e,n){n==null&&(n=!1);if(this.timeRunning!==!0)return;clearInterval(this.interval),this.stopTime=this.getTime(),this.timeRunning=!1,this.timerStopped=!0,this.updateCountdown();if(e!=null?!e.simpleStop:!void 0){Utils.flash(),this.captureLastAttempted&&this.updateMode(null,"last");if(n)return Utils.topAlert(n);if(this.captureLastAttempted)return Utils.midAlert(t("Please mark last item attempted"))}},n.prototype.autostopTest=function(){return Utils.flash(),clearInterval(this.interval),this.stopTime=this.getTime(),this.autostopped=!0,this.timerStopped=!0,this.timeRunning=!1,this.$el.find(".grid_element").slice(this.autostop-1,this.autostop).addClass("element_last"),this.lastAttempted=this.autostop,this.timeout=setTimeout(this.removeUndo,3e3),Utils.topAlert(t("autostop activated discontinue test"))},n.prototype.removeUndo=function(){return this.undoable=!1,this.updateMode(null,"disabled"),clearTimeout(this.timeout)},n.prototype.unAutostopTest=function(){return this.interval=setInterval(this.updateCountdown,1e3),this.updateCountdown(),this.autostopped=!1,this.lastAttempted=0,this.$el.find(".grid_element").slice(this.autostop-1,this.autostop).removeClass("element_last"),this.timeRunning=!0,this.updateMode(null,"mark"),Utils.topAlert(t("autostop removed continue"))},n.prototype.updateCountdown=function(){this.timeElapsed=Math.min(this.getTime()-this.startTime,this.timer),this.timeRemaining=this.timer-this.timeElapsed,this.$el.find(".timer").html(this.timeRemaining),this.timeRemaining<=0&&this.timeRunning===!0&&this.captureLastAttempted&&this.stopTimer(null,t("time please mark last item attempted"));if(this.captureItemAtTime&&!this.gotIntermediate&&!this.minuteMessage&&this.timeElapsed>=this.captureAfterSeconds)return Utils.flash("yellow"),Utils.midAlert(t("please select the item the child is currently attempting")),this.minuteMessage=!0,this.mode="minuteItem"},n.prototype.updateMode=function(e,t){t==null&&(t=null);if(t===null&&this.timeElapsed===0||t==="disabled"){this.$el.find("#grid_mode :radio").removeAttr("checked"),this.$el.find("#grid_mode").buttonset("refresh");return}if(t!=null){this.mode=t,this.$el.find("#grid_mode :radio[value="+t+"]").attr("checked","checked"),this.$el.find("#grid_mode").buttonset("refresh").click(this.updateMode);return}if(!this.autostopped)return this.mode=$(e.target).val()},n.prototype.getTime=function(){return Math.round((new Date).getTime()/1e3)},n.prototype.resetVariables=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;this.gotMinuteItem=!1,this.minuteMessage=!1,this.itemAtTime=null,this.timeIntermediateCaptured=null,this.markRecord=[],this.timerStopped=!1,this.startTime=0,this.stopTime=0,this.timeElapsed=0,this.timeRemaining=this.timer,this.lastAttempted=0,this.interval=null,this.undoable=!0,this.timeRunning=!1,this.timer=parseInt(this.model.get("timer"))||0,this.untimed=this.timer===0,this.items=_.compact(this.model.get("items")),this.itemMap=[],this.mapItem=[];if(this.model.has("randomize")&&this.model.get("randomize")){d=this.items;for(e=i=0,a=d.length;i<a;e=++i)t=d[e],this.itemMap[e]=e;v=this.items;for(e=s=0,f=v.length;s<f;e=++s)t=v[e],n=Math.floor(Math.random()*this.items.length),r=this.itemMap[n],this.itemMap[n]=this.itemMap[e],this.itemMap[e]=r;m=this.itemMap;for(e=o=0,l=m.length;o<l;e=++o)t=m[e],this.mapItem[this.itemMap[e]]=e}else{g=this.items;for(e=u=0,c=g.length;u<c;e=++u)t=g[e],this.itemMap[e]=e,this.mapItem[e]=e}!this.captureLastAttempted&&!this.captureItemAtTime?this.mode="mark":this.mode="disabled",this.gridOutput=[],y=this.items;for(e=p=0,h=y.length;p<h;e=++p)t=y[e],this.gridOutput[e]="correct";return this.columns=parseInt(this.model.get("columns"))||3,this.autostop=this.untimed?0:parseInt(this.model.get("autostop"))||0,this.autostopped=!1,this.$el.find(".grid_element").removeClass("element_wrong").removeClass("element_last").addClass("disabled"),this.$el.find("table").addClass("disabled"),this.$el.find(".timer").html(this.timer),this.updateMode(null,this.mode)},n.prototype.initialize=function(e){var t;return this.captureAfterSeconds=this.model.has("captureAfterSeconds")?this.model.get("captureAfterSeconds"):0,this.captureItemAtTime=this.model.has("captureItemAtTime")?this.model.get("captureItemAtTime"):!1,this.captureLastAttempted=this.model.has("captureLastAttempted")?this.model.get("captureLastAttempted"):!0,this.endOfLine=this.model.has("endOfLine")?this.model.get("endOfLine"):!0,this.layoutMode=this.model.has("layoutMode")?this.model.get("layoutMode"):"fixed",this.fontSize=this.model.has("fontSize")?this.model.get("fontSize"):"normal",this.fontSize==="small"?t="font_size_small":t="",this.totalTime=this.model.get("timer")||0,this.modeHandlers={mark:this.markHandler,last:this.lastHandler,minuteItem:this.intermediateItemHandler,disabled:$.noop},this.model=this.options.model,this.parent=this.options.parent,this.resetVariables(),this.gridElement=_.template("<td><div data-label='{{label}}' data-index='{{i}}' class='grid_element "+t+"'>{{label}}</div></td>"),this.variableGridElement=_.template("<span data-label='{{label}}' data-index='{{i}}' class='grid_element "+t+"'>{{label}}</span>"),this.layoutMode==="fixed"?this.endOfGridLine=_.template("<td><div data-index='{{i}}' class='end_of_grid_line'>*</div></td>"):this.endOfGridLine=_.template("")},n.prototype.render=function(){var e,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b;r=0,p="<div class='timer_wrapper'><button class='start_time time'>"+t("start")+"</button><div class='timer'>"+this.timer+"</div></div>",n=this.untimed?"":"disabled",o=this.untimed?"":p,s="";if(this.layoutMode==="fixed"){s+="<table class='grid "+n+"'>",i=!0;for(;;){if(r>this.items.length)break;s+="<tr>";for(u=v=1,y=this.columns;1<=y?v<=y:v>=y;u=1<=y?++v:--v)r<this.items.length&&(s+=this.gridElement({label:_.escape(this.items[this.itemMap[r]]),i:r+1})),r++;i?(r<this.items.length+1&&this.endOfLine&&(s+="<td></td>"),i=!1):r<this.items.length+1&&this.endOfLine&&(s+=this.endOfGridLine({i:r})),s+="</tr>"}s+="</table>"}else{s+="<div class='grid "+n+"'>",b=this.items;for(u=m=0,g=b.length;m<g;u=++m)a=b[u],s+=this.variableGridElement({label:_.escape(this.items[this.itemMap[u]]),i:u+1});s+="</div>"}o+=s,d="<div class='timer_wrapper'><button class='stop_time time'>"+t("stop")+"</button><div class='timer'>"+this.timer+"</div></div>",h="    <div>      <button class='restart command'>"+t("restart")+"</button>      <br>    </div>",c="";if(this.captureLastAttempted||this.captureItemAtTime)l="",this.captureItemAtTime&&(f=t("item at __seconds__ seconds",{seconds:this.captureAfterSeconds}),l="          <label for='minute_item'>"+f+"</label>          <input class='grid_mode' name='grid_mode' id='minute_item' type='radio' value='minuteItem'>        "),e="",this.captureLastAttempted&&(e="          <label for='last_attempted'>"+t("last attempted")+"</label>          <input class='grid_mode' name='grid_mode' id='last_attempted' type='radio' value='last'>        "),c="        <div id='grid_mode' class='question buttonset clearfix'>          <label>"+t("input mode")+"</label><br>          <label for='mark'>"+t("mark")+"</label>          <input class='grid_mode' name='grid_mode' id='mark' type='radio' value='mark'>          "+l+"          "+e+"        </div>      ";return o+="      "+(this.untimed?"":d)+"      "+(this.untimed?"":h)+"      "+c+"    ",this.$el.html(o),this.trigger("rendered"),this.trigger("ready")},n.prototype.isValid=function(){return this.timeRunning&&this.stopTimer(),this.captureLastAttempted&&this.lastAttempted===0?!1:this.timeRunning===!0?!1:!0},n.prototype.showErrors=function(){this.captureLastAttempted&&this.lastAttempted===0&&(Utils.midAlert(t("please touch last item read")),this.updateMode(null,"last"));if(this.timeRuning===!0)return Utils.midAlert(t("time still running"))},n.prototype.getResult=function(){var e,t,n,r,i,s,o,u;e=[],r=[],this.captureLastAttempted||(this.lastAttempted=this.items.length),u=this.items;for(t=s=0,o=u.length;s<o;t=++s)n=u[t],this.mapItem[t]<this.lastAttempted?r[t]={itemResult:this.gridOutput[this.mapItem[t]],itemLabel:n}:r[t]={itemResult:"missing",itemLabel:this.items[this.mapItem[t]]};return this.captureLastAttempted||(this.lastAttempted=!1),i={capture_last_attempted:this.captureLastAttempted,item_at_time:this.itemAtTime,time_intermediate_captured:this.timeIntermediateCaptured,capture_item_at_time:this.captureItemAtTime,auto_stop:this.autostopped,attempted:this.lastAttempted,items:r,time_remain:this.timeRemaining,mark_record:this.markRecord,variable_name:this.model.get("variableName")}},n.prototype.getSkipped=function(){var e,t,n,r,i,s,o;n=[],o=this.items;for(e=i=0,s=o.length;i<s;e=++i)t=o[e],n[e]={itemResult:"skipped",itemLabel:t};return r={capture_last_attempted:"skipped",item_at_time:"skipped",time_intermediate_captured:"skipped",capture_item_at_time:"skipped",auto_stop:"skipped",attempted:"skipped",items:n,time_remain:"skipped",mark_record:"skipped",variable_name:this.model.get("variableName")}},n.prototype.onClose=function(){return clearInterval(this.interval)},n.prototype.getSum=function(){var e,t,n,r,i;e={correct:0,incorrect:0,missing:this.items.length-this.lastAttempted,total:this.items.length},i=this.gridOutput;for(n=0,r=i.length;n<r;n++)t=i[n],t==="correct"&&(e.correct+=1),t==="incorrect"&&(e.incorrect+=1);return{correct:e.correct,incorrect:e.incorrect,missing:e.missing,total:e.total,correct_per_minute:e.correct*(60/this.timeElapsed)}},n}(Backbone.View);var GridEditView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};GridEditView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="GridEditView",t.prototype.events={"blur #subtest_items":"cleanWhitespace"},t.prototype.cleanWhitespace=function(){return this.$el.find("#subtest_items").val(this.$el.find("#subtest_items").val().replace(/\s+/g," "))},t.prototype.initialize=function(e){return this.model=e.model},t.prototype.isValid=function(){return!0},t.prototype.save=function(){return/\t|,/.test(this.$el.find("#subtest_items").val())&&alert('Please remember\n\nGrid items are space " " delimited'),this.model.set({captureLastAttempted:this.$el.find("#capture_last_attempted input:checked").val()==="true",endOfLine:this.$el.find("#end_of_line input:checked").val()==="true",captureItemAtTime:this.$el.find("#capture_item_at_time input:checked").val()==="true",captureAfterSeconds:parseInt(this.$el.find("#capture_after_seconds").val()),fontSize:this.$el.find("#font_size input:checked").val(),layoutMode:this.$el.find("#layout_mode input:checked").val(),randomize:this.$el.find("#randomize input:checked").val()==="true",timer:parseInt(this.$el.find("#subtest_timer").val()),items:_.compact(this.$el.find("#subtest_items").val().split(" ")),columns:parseInt(this.$el.find("#subtest_columns").val()),autostop:parseInt(this.$el.find("#subtest_autostop").val()),variableName:this.$el.find("#subtest_variable_name").val().replace(/\s/g,"_").replace(/[^a-zA-Z0-9_]/g,"")})},t.prototype.render=function(){var e,t,n,r,i,s,o,u,a,f,l,c;return u=this.model.get("items").join(" "),l=this.model.get("timer")||0,i=this.model.get("columns")||0,e=this.model.get("autostop")||0,c=this.model.get("variableName")||"",f=this.model.has("randomize")?this.model.get("randomize"):!1,n=this.model.has("captureItemAtTime")?this.model.get("captureItemAtTime"):!1,t=this.model.has("captureAfterSeconds")?this.model.get("captureAfterSeconds"):0,r=this.model.has("captureLastAttempted")?this.model.get("captureLastAttempted"):!0,s=this.model.has("endOfLine")?this.model.get("endOfLine"):!0,o=this.model.has("fontSize")?this.model.get("fontSize"):"medium",a=this.model.has("layoutMode")?this.model.get("layoutMode"):"fixed",this.$el.html("      <div class='label_value'>        <label for='subtest_variable_name' title='This will be used for CSV exporting.'>Variable name</label>        <input id='subtest_variable_name' value='"+c+"'>      </div>      <div class='label_value'>        <label for='subtest_items' title='These items are space delimited. Pasting text from other applications may insert tabs and new lines. Whitespace will be automatically corrected.'>Grid Items</label>        <textarea id='subtest_items'>"+u+"</textarea>      </div>      <div class='label_value'>        <label>Randomize items</label><br>        <div class='menu_box'>          <div id='randomize' class='buttonset'>            <label for='randomize_true'>Yes</label><input name='randomize' type='radio' value='true' id='randomize_true' "+(f?"checked":void 0)+">            <label for='randomize_false'>No</label><input name='randomize' type='radio' value='false' id='randomize_false' "+(f?void 0:"checked")+">          </div>        </div>        <br>        <label>Layout mode</label><br>        <div class='menu_box'>          <div id='layout_mode' class='buttonset'>            <label for='layout_mode_fixed'>Fixed<img></label><input name='layout_mode' type='radio' value='fixed' id='layout_mode_fixed' "+(a==="fixed"?"checked":"")+">            <label for='layout_mode_variable'>Variable<img></label><input name='layout_mode' type='radio' value='variable' id='layout_mode_variable' "+(a==="variable"?"checked":"")+">          </div>        </div>        <br>        <label>Grid font size</label><br>        <div class='menu_box'>          <div id='font_size' class='buttonset'>            <label for='font_size_medium'>Medium</label><input name='font_size' type='radio' value='medium' id='font_size_medium' "+(o==="medium"?"checked":"")+">            <label for='font_size_small'>Small</label><input name='font_size' type='radio' value='small' id='font_size_small' "+(o==="small"?"checked":"")+">          </div>        </div>        <br>        <label>Capture item at specified number of seconds</label><br>        <div class='menu_box'>          <div id='capture_item_at_time' class='buttonset'>            <label for='capture_item_at_time_true'>Yes</label><input name='capture_item_at_time' type='radio' value='true' id='capture_item_at_time_true' "+(n?"checked":void 0)+">            <label for='capture_item_at_time_false'>No</label><input name='capture_item_at_time' type='radio' value='false' id='capture_item_at_time_false' "+(n?void 0:"checked")+">          </div>          <div class='label_value'>            <label for='capture_after_seconds' title='After this number of seconds has passed the enumerator will be instructed to mark the item currently being attempted, and then resume.'>Seconds</label>            <input id='capture_after_seconds' value='"+t+"' type='number'>          </div>        </div>        <br>        <label>Capture last item attempted</label><br>        <div class='menu_box'>          <div id='capture_last_attempted' class='buttonset'>            <label for='capture_last_attempted_true'>Yes</label><input name='capture_last_attempted' type='radio' value='true' id='capture_last_attempted_true' "+(r?"checked":void 0)+">            <label for='capture_last_attempted_false'>No</label><input name='capture_last_attempted' type='radio' value='false' id='capture_last_attempted_false' "+(r?void 0:"checked")+">          </div>        </div>        <br>        <label>Mark entire line button</label><br>        <div class='menu_box'>          <div id='end_of_line' class='buttonset'>            <label for='end_of_line_true'>Yes</label><input name='end_of_line' type='radio' value='true' id='end_of_line_true' "+(s?"checked":void 0)+">            <label for='end_of_line_false'>No</label><input name='end_of_line' type='radio' value='false' id='end_of_line_false' "+(s?void 0:"checked")+">          </div>        </div>      </div>      <div class='label_value'>        <label for='subtest_columns' title='Number of columns in which to display the grid items.'>Columns</label>        <input id='subtest_columns' value='"+i+"' type='number'>      </div>      <div class='label_value'>        <label for='subtest_autostop' title='Number of incorrect items in a row from the beginning, after which, the test automatically stops. If the item that triggered the autostop was an enumerator error, the enumerator has 3 seconds to undo any incorrect item and resume the test. Otherwise, the test is stopped but may still be reset completely.'>Autostop</label>        <input id='subtest_autostop' value='"+e+"' type='number'>      </div>      <div class='label_value'>        <label for='subtest_timer' title='Seconds to give the child to complete the test. Setting this value to 0 will make the test untimed.'>Timer</label>        <input id='subtest_timer' value='"+l+"' type='number'>      </div>")},t}(Backbone.View);var ObservationRunView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ObservationRunView=function(e){function n(){return this.saveCurrentSurvey=__bind(this.saveCurrentSurvey,this),this.updateObservationIndex=__bind(this.updateObservationIndex,this),this.checkSurveyDisplay=__bind(this.checkSurveyDisplay,this),this.checkIfOver=__bind(this.checkIfOver,this),this.checkWarning=__bind(this.checkWarning,this),this.checkObservationPace=__bind(this.checkObservationPace,this),this.tick=__bind(this.tick,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="ObservationRunView",n.prototype.events={"click .start_time":"startObservations","click .stop_time":"stopObservations","click .done":"completeObservation"},n.FORCE=1,n.prototype.initialize=function(e){return this.model=this.options.model,this.parent=this.options.parent,this.warningSeconds=5,this.initializeFlags(),this.initializeSurvey()},n.prototype.initializeSurvey=function(){var e,t,n;return this.survey!=null&&this.onClose(),e=$.extend(this.model.get("surveyAttributes"),{_id:this.model.id}),n=function(){var n,r,s;s=[];for(t=n=1,r=parseInt(this.model.get("totalSeconds")/this.model.get("intervalLength"));1<=r?n<=r:n>=r;t=1<=r?++n:--n)s.push(new Backbone.Model(e));return s}.call(this),n.unshift(""),this.skippableView=new SurveyRunView({model:n[1],parent:this,isObservation:!0}),this.survey={models:n,results:[]}},n.prototype.initializeFlags=function(){return this.iAm={counting:!1,recording:!1},this.iHavent={warned:!0},this.iHave={runOnce:!1,finished:!1},this.my={time:{start:0,elapsed:0},observation:{index:0,oldIndex:0,completed:0,total:parseInt(this.model.get("totalSeconds")/this.model.get("intervalLength"))}}},n.prototype.startObservations=function(){if(this.iAm.counting||this.iHave.runOnce)return;return this.$el.find(".stop_button_wrapper, .next_display, .completed_display").removeClass("confirmation"),this.$el.find(".start_button_wrapper").addClass("confirmation"),this.timerInterval=setInterval(this.tick,1e3),this.iAm.counting=!0,this.my.time.start=this.getTime(),this.my.time.elapsed=0},n.prototype.stopObservations=function(e){var n,r;return clearInterval(this.timerInterval),n=e!=null,r=e==null,e!=null&&this.trigger("showNext"),r&&!this.iHave.finished?(this.iAm.recording&&(this.resetObservationFlags(),this.saveCurrentSurvey()),this.my.observation.index++,this.renderSurvey()):(this.$el.find(".stop_button_wrapper").addClass("confirmation"),Utils.midAlert(t("observations finished"))),this.$el.find(".next_display").addClass("confirmation"),this.iHave.finished=!0,this.iHave.runOnce=!0},n.prototype.tick=function(){return this.my.time.elapsed=this.getTime()-this.my.time.start,this.checkIfOver(),this.updateObservationIndex(),this.updateProgressDisplay(),this.checkSurveyDisplay(),this.checkObservationPace(),this.checkWarning()},n.prototype.checkObservationPace=function(){if(this.iAm.recording&&this.my.observation.completed<this.my.observation.index-1&&this.my.observation.index!==0)return this.iHave.forcedProgression=!0,this.resetObservationFlags(),this.saveCurrentSurvey(),this.renderSurvey()},n.prototype.checkWarning=function(){var e,n;n=Math.floor((this.my.time.elapsed+this.warningSeconds)/this.model.get("intervalLength")),e=this.my.observation.index<n&&!this.iHave.finished;if(this.iAm.recording&&this.iHavent.warned&&e&&this.my.observation.index!==0)return Utils.midAlert(t("observation ending soon")),this.iHavent.warned=!1},n.prototype.gridWasAutostopped=function(){return!1},n.prototype.checkIfOver=function(){if(this.my.time.elapsed>=this.model.get("totalSeconds"))return this.stopObservations()},n.prototype.checkSurveyDisplay=function(){if(this.my.observation.oldIndex!==this.my.observation.index&&!this.iHave.finished&&!this.iAm.recording)return this.renderSurvey(),this.my.observation.oldIndex=this.my.observation.index},n.prototype.updateObservationIndex=function(){this.my.observation.index=Math.floor(this.my.time.elapsed/this.model.get("intervalLength"));if(this.my.observation.index>this.survey.models.length-1)return this.my.observation.index=this.survey.models.length-1},n.prototype.updateProgressDisplay=function(){var e;this.$el.find(".current_observation").html(this.my.observation.index),this.$el.find(".completed_count").html(this.my.observation.completed),e=Math.max((this.my.observation.index+1)*this.model.get("intervalLength")-this.my.time.elapsed,0),this.$el.find(".time_till_next").html(e);if(!this.iAm.recording&&!this.iHave.finished)return this.$el.find(".next_display, .completed_display").removeClass("confirmation")},n.prototype.resetObservationFlags=function(){return this.iAm.recording=!1,this.iHavent.warned=!0},n.prototype.getTime=function(){return parseInt((new Date).getTime()/1e3)},n.prototype.completeObservation=function(e){return this.survey.view.isValid()?(this.saveCurrentSurvey(),this.iHave.finished&&this.trigger("showNext")):this.survey.view.showErrors(),this.tick()},n.prototype.saveCurrentSurvey=function(){return this.resetObservationFlags(),this.my.observation.completed++,this.survey.results.push({observationNumber:this.survey.view.index,data:this.survey.view.getResult(),saveTime:this.my.time.elapsed}),this.survey.view.close(),this.$el.find(".done").remove()},n.prototype.render=function(){var e;return this.trigger("hideNext"),e=this.model.get("totalSeconds"),this.$el.html("      <div class='timer_wrapper'>        <div class='progress clearfix'>          <span class='completed_display confirmation'>"+t("completed")+" <div class='info_box completed_count'>"+this.my.observation.completed+"</div></span>          <span class='next_display confirmation'>"+t("next observation")+" <div class='info_box time_till_next'>"+this.model.get("intervalLength")+"</div></span>        </div>        <div>          <div class='start_button_wrapper'><button class='start_time command'>"+t("start")+"</button></div>          <div class='stop_button_wrapper confirmation'><button class='stop_time command'>"+t("abort all observations")+"</button></div>        </div>      </div>      <div id='current_survey'></div>    "),this.trigger("rendered"),this.trigger("ready")},n.prototype.renderSurvey=function(e){var n=this;if(!this.iAm.counting)return;return this.iAm.recording=!0,this.survey.view=new SurveyRunView({model:this.survey.models[this.my.observation.index],parent:this,isObservation:!0}),this.survey.view.index=function(){return n.my.observation.index}(),this.survey.view.on("rendered subRendered",function(){return n.trigger("subRendered")}),this.survey.view.render(),this.$el.find("#current_survey").html("<span class='observation_display confirmation'>"+t("observation")+" <div class='info_box current_observation'>"+this.my.observation.index+"</div></span>"),this.$el.find("#current_survey").append(this.survey.view.el),this.$el.find("#current_survey").append("<button class='command done'>"+t("done with this observation")+"</button>"),this.$el.find("#current_survey").scrollTo(250,function(){if(n.iHave.forcedProgression)return Utils.midAlert(t("please continue with the next observation")),n.iHave.forcedProgression=!1;if(n.iHave.finished)return Utils.midAlert(t("please enter last observation"))})},n.prototype.onClose=function(){var e;return(e=this.survey.view)!=null&&e.close(),this.skippableView.close()},n.prototype.getResult=function(){return{surveys:this.survey.results,variableName:this.model.get("variableName"),totalTime:this.model.get("totalTime"),intervalLength:this.model.get("intervalTime"),completedObservations:this.my.observation.completed}},n.prototype.getSum=function(){return{total:this.my.observation.completed}},n.prototype.getSkipped=function(){var e,t,n,r,i;n=this.skippableView.getSkipped(),t=[];for(e=r=1,i=this.survey.models.length-1;1<=i?r<=i:r>=i;e=1<=i?++r:--r)t.push({observationNumber:e,data:n,saveTime:"skipped"});return{surveys:t,variableName:"skipped",totalTime:"skipped",intervalLength:"skipped",completedObservations:"skipped"}},n.prototype.isValid=function(){return this.iHave.finished},n.prototype.showErrors=function(){return this.$el.find("messages").html(this.validator.getErrors().join(", "))},n.prototype.updateNavigation=function(){return Tangerine.nav.setStudent(this.$el.find("#participant_id").val())},n}(Backbone.View);var ObservationEditView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ObservationEditView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="ObservationEditView",t.prototype.initialize=function(e){var t;return this.model=e.model,t=$.extend(this.model.get("surveyAttributes"),{_id:this.model.id,assessmentId:this.model.get("assessmentId")}),this.surveyModel=new Backbone.Model(t),this.surveyView=new SurveyEditView({model:this.surveyModel})},t.prototype.isValid=function(){return!0},t.prototype.save=function(){var e,t,n;return e=[],n=parseInt(this.$el.find("#total_seconds").val()),t=parseInt(this.$el.find("#interval_length").val()),n===0&&e.push("Total seconds needs to be non-zero value."),t===0&&e.push("Interval length needs to be a non-zero value."),e.length!==0&&alert("Warning\n\n"+e.join("\n")),this.model.set({totalSeconds:n,intervalLength:t,surveyAttributes:this.surveyModel.attributes})},t.prototype.render=function(){var e,t;return t=this.model.get("totalSeconds")||0,e=this.model.get("intervalLength")||0,this.$el.html("      <div class='label_value'>        <label for='total_seconds'>Total seconds</label>        <input id='total_seconds' value='"+t+"' type='number'><br>        <label for='interval_length' title='In seconds'>Interval length</label>        <input id='interval_length' value='"+e+"' type='number'>      </div>      <div id='survey_editor'></div>    "),this.surveyView.setElement(this.$el.find("#survey_editor")),this.surveyView.render(),this.$el.find("#grid_link").remove()},t}(Backbone.View);var Result,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Result=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="result",t.prototype.initialize=function(e){var t,n;if(e.blank===!0)return t=t||Device||{},n={name:t.name,platform:t.platform,uuid:t.uuid,version:t.version,userAgent:navigator.userAgent},this.set({subtestData:[],start_time:(new Date).getTime(),enumerator:Tangerine.user.name,tangerine_version:Tangerine.version,device:n}),this.unset("blank")},t.prototype.beforeSave=function(){},t.prototype.add=function(e){var t;return e.timestamp=(new Date).getTime(),t=this.get("subtestData"),t.push(e),this.save({subtestData:t})},t.prototype.getVariable=function(e){var t,n,r,i,s,o,u,a,f;f=this.get("subtestData");for(u=0,a=f.length;u<a;u++){i=f[u],t=i.data;for(o in t){s=t[o];if(o===e)return _.isObject(s)?_.compact(function(){var e;e=[];for(n in s)r=s[n],e.push(r==="checked"?n:void 0);return e}()):s}}return null},t.prototype.getGridScore=function(e){var t,n,r,i;i=this.get("subtestData");for(n=0,r=i.length;n<r;n++){t=i[n];if(t.subtestId===e)return parseInt(t.data.attempted)}},t.prototype.gridWasAutostopped=function(e){var t,n,r,i;i=this.get("subtestData");for(n=0,r=i.length;n<r;n++){t=i[n];if(t.subtestId===e)return t.data.auto_stop}},t}(Backbone.Model);var Results,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Results=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="result",t.prototype.model=Result,t.prototype.db={view:"resultsByAssessmentId"},t.prototype.comparator=function(e){return e.get("start_time")||0},t.prototype.fetch=function(e){return e==null&&(e={}),e.include_docs==null&&(e.include_docs=!0),t.__super__.fetch.call(this,e)},t}(Backbone.Collection);var ResultView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ResultView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="result_view",t.prototype.events={"click .save":"save","click .another":"another"},t.prototype.another=function(){return Tangerine.router.navigate("restart/"+this.assessment.id,!0)},t.prototype.save=function(){var e;return this.model.add({name:"Assessment complete",prototype:"complete",data:{comment:this.$el.find("#additional_comments").val()||"",end_time
:(new Date).getTime(),gps:this.gpsData},subtestId:"result",sum:{correct:1,incorrect:0,missing:0,total:1}}),this.model.save()?(Tangerine.activity="",Utils.midAlert("Result saved"),this.$el.find(".save_status").html("saved"),this.$el.find(".save_status").removeClass("not_saved"),this.$el.find(".question").fadeOut(250),e=this.$el.find("button.save"),e.removeClass("save").addClass("another").html("Perform another assessment")):(Utils.midAlert("Save error"),this.$el.find(".save_status").html("Results may not have saved"))},t.prototype.initialize=function(e){var t=this;this.gpsData={};try{navigator.geolocation.getCurrentPosition(function(e){return t.gpsData=e.coords},function(){return t.gpsData[n]=arguments},{enableHighAccuracy:!0})}catch(n){this.gpsData={error:n}}return this.model=e.model,this.assessment=e.assessment,this.saved=!1,this.resultSumView=new ResultSumView({model:this.model,finishCheck:!1})},t.prototype.render=function(){return this.$el.html("      <h2>Assessment complete</h2>      <button class='save command'>Save result</button>      <div class='info_box save_status not_saved'>Not saved yet</div>      <br>      <div class='question'>        <div class='prompt'>Additional comments (optional)</div>        <textarea id='additional_comments' class='full_width'></textarea>      </div>      <div class='label_value'>        <h2>Subtests completed</h2>        <div id='result_sum' class='info_box'></div>      </div>    "),this.resultSumView.setElement(this.$el.find("#result_sum")),this.resultSumView.render(),this.trigger("rendered")},t.prototype.onClose=function(){return this.resultSumView.close()},t}(Backbone.View);var ResultsView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ResultsView=function(e){function t(){return this.afterRender=__bind(this.afterRender,this),this.updateResults=__bind(this.updateResults,this),this.updateOptions=__bind(this.updateOptions,this),this.detectTablets=__bind(this.detectTablets,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="ResultsView",t.prototype.events={"click .cloud":"cloud","click .csv":"csv","click .tablets":"tablets","click .detect":"detectOptions","click .details":"showResultSumView","click .csv_beta":"csvBeta","change #limit":"setLimit","change #page":"setOffset"},t.prototype.csvBeta=function(){var e;return e=this.assessment.get("name"),document.location="/"+Tangerine.db_name+"/_design/"+Tangerine.design_doc+('/_list/csv/csvRowByResult?key="'+this.assessment.id+'"&filename='+e)},t.prototype.showResultSumView=function(e){var t,n,r;r=$(e.target).attr("data-result-id"),t=this.$el.find("#details_"+r);if(!_.isEmpty(t.html())){t.empty();return}return n=new Result({_id:r}),n.fetch({success:function(){var e;return e=new ResultSumView({model:n,finishCheck:!0}),e.render(),t.html("<div class='info_box'>"+$(e.el).html()+"</div>"),e.close()}})},t.prototype.cloud=function(){var e=this;return this.available.cloud.ok?$.couch.replicate(Tangerine.settings.urlDB("local"),Tangerine.settings.urlDB("group"),{success:function(){return e.$el.find(".status").find(".info_box").html("Results synced to cloud successfully")},error:function(t,n){return e.$el.find(".status").find(".info_box").html("<div>Sync error</div><div>"+t+" "+n+"</div>")}},{doc_ids:this.docList}):Utils.midAlert("Cannot detect cloud"),!1},t.prototype.tablets=function(){var e,t,n,r,i,s=this;if(this.available.tablets.okCount>0){i=this.available.tablets.ips,t=function(e){return $.couch.replicate(Tangerine.settings.urlDB("local"),Tangerine.settings.urlSubnet(e),{success:function(){return s.$el.find(".status").find(".info_box").html("Results synced to "+s.available.tablets.okCount+" successfully")},error:function(e,t){return s.$el.find(".status").find(".info_box").html("<div>Sync error</div><div>"+e+" "+t+"</div>")}},{doc_ids:s.docList})};for(n=0,r=i.length;n<r;n++)e=i[n],t(e)}else Utils.midAlert("Cannot detect tablets");return!1},t.prototype.csv=function(){var e,t=this;return this.$el.find("button.csv").html("Preparing CSV..."),e=new CSVView({assessmentId:this.assessment.id}),e.render(),e.on("ready",function(){var e,n,r;return r=t.assessment.get("name")+"-"+moment().format("YYYY-MMM-DD HH:mm"),n=Tangerine.settings.urlShow("local","csv/Tangerine-"+t.assessment.id.substr(-5,5)+".csv?filename="+r),e=t.$el.find("button.csv"),e.after("<a href='"+n+"' class='command'>Download CSV</a>"),e.remove()})},t.prototype.initDetectOptions=function(){return this.available={cloud:{ok:!1,checked:!1},tablets:{ips:[],okCount:0,checked:0,total:256}}},t.prototype.detectOptions=function(){return $("button.cloud, button.tablets").attr("disabled","disabled"),this.detectCloud(),this.detectTablets()},t.prototype.detectCloud=function(){var e=this;return $.ajax({dataType:"jsonp",url:Tangerine.settings.urlHost("group"),success:function(t,n){return e.available.cloud.ok=!0},error:function(t,n){return e.available.cloud.ok=!1},complete:function(){return e.available.cloud.checked=!0,e.updateOptions()}})},t.prototype.detectTablets=function(){var e,t,n,r=this;n=[];for(e=t=0;t<=255;e=++t)n.push(function(e){var t;return t=Tangerine.settings.subnetIP(e),$.ajax({url:Tangerine.settings.urlSubnet(t),dataType:"jsonp",contentType:"application/json;charset=utf-8",timeout:3e4,complete:function(e,n){return r.available.tablets.checked++,e.status===200&&(r.available.tablets.okCount++,r.available.tablets.ips.push(t)),r.updateOptions()}})}(e));return n},t.prototype.updateOptions=function(){var e,t,n;t=Math.decimals(this.available.tablets.checked/this.available.tablets.total*100,2),t===100?e="finished":e=""+t+"%",n="Searching for tablets: "+e,this.available.tablets.checked>0&&this.$el.find(".checking_status").html(""+n),this.available.cloud.checked&&this.available.tablets.checked===this.available.tablets.total&&(this.$el.find(".status .info_box").html("Done detecting options"),this.$el.find(".checking_status").hide()),this.available.cloud.ok&&this.$el.find("button.cloud").removeAttr("disabled");if(this.available.tablets.okCount>0&&t===100)return this.$el.find("button.tablets").removeAttr("disabled")},t.prototype.readyCSVBeta=function(){var e=this;return $.ajax({dataType:"json",contentType:"application/json;charset=utf-8",url:"http://localhost:5984/tangerine/_design/tangerine/_list/csvHeaders/csvRowByResult",data:{key:'"'+this.assessment.id+'"'},success:function(t){var n;return n=e.$el.find(".csv_beta"),n.removeAttr("disabled"),n.html("CSV"),e.columnHeaders=t}})},t.prototype.initialize=function(e){var t,n,r,i;this.resultLimit=100,this.resultOffset=0,this.subViews=[],this.results=e.results,this.assessment=e.assessment,this.docList=[],i=this.results;for(n=0,r=i.length;n<r;n++)t=i[n],this.docList.push(t.get("id"));return this.initDetectOptions(),this.detectCloud()},t.prototype.render=function(){var e,t,n,r;return this.clearSubViews(),e="<button class='cloud command' disabled='disabled'>Cloud</button>",r="<button class='tablets command' disabled='disabled'>Tablets</button>",t="<button class='csv command'>CSV</button>",n="      <h1>"+this.assessment.get("name")+" results</h1>      <h2>Save options</h2>      <div class='menu_box'>        "+(Tangerine.settings.get("context")==="mobile"?e:"")+"        "+(Tangerine.settings.get("context")==="mobile"?r:"")+"        "+t+"        <button class='command csv_beta'>CSV (beta)</button>      </div>",Tangerine.settings.get("context")==="mobile"&&(n+="        <button class='detect command'>Detect options</button>        <div class='status'>          <h2>Status</h2>          <div class='info_box'></div>          <div class='checking_status'></div>        </div>        "),n+="      <h2 id='results_header'>Results (<span id='result_position'>loading...</span>)</h2>      <div class='confirmation' id='controls'>        <label for='page' class='small_grey'>Page</label><input id='page' type='number' value='0'>        <label for='limit' class='small_grey'>Per page</label><input id='limit' type='number' value='0'>      </div>      <div id='results_container'></div>    ",this.$el.html(n),this.updateResults(),this.trigger("rendered")},t.prototype.setLimit=function(e){return this.resultLimit=parseInt($("#limit").val())||100,this.updateResults()},t.prototype.setOffset=function(e){var t,n,r;return r=parseInt($("#page").val())||1,t=(r-1)*this.resultLimit,n=Math.floor(this.results.length/this.resultLimit),this.resultOffset=Math.limit(0,t,n*this.resultLimit),this.updateResults()},t.prototype.updateResults=function(e){var t,n,r=this;if(((n=this.results)!=null?n.length:void 0)===0){this.$el.find("#results_header").html("No results yet!");return}return t=Tangerine.settings.get("context")==="server"?"group":Tangerine.settings.get("context")==="mobile"?"local":void 0,$.ajax({url:Tangerine.settings.urlView(t,"resultSummaryByAssessmentId"),type:"GET",dataType:"json",contentType:"application/json",data:{keys:JSON.stringify([this.assessment.id]),descending:!0,limit:this.resultLimit,skip:this.resultOffset},success:function(t){var n,i,s,o,u,a,f,l,c,h,p,d,v,m,g;h=t.rows,n=h.length,l=100,i=Math.floor(r.resultOffset/r.resultLimit)+1,r.results.length>l&&(r.$el.find("#controls").removeClass("confirmation"),r.$el.find("#page").val(i),r.$el.find("#limit").val(r.resultLimit)),r.$el.find("#result_position").html(""+r.resultOffset+"-"+Math.min(r.resultOffset+r.resultLimit,r.results.length)+" of "+r.results.length),u="";for(v=0,m=h.length;v<m;v++)c=h[v],a=((g=c.value)!=null?g.participant_id:void 0)||"No ID",s=c.value.end_time,s!=null?(f=moment(s).format("YYYY-MMM-DD HH:mm"),o=moment(s).fromNow()):(p=c.value.start_time,f="<b>started</b> "+moment(p).format("YYYY-MMM-DD HH:mm"),o=moment(p).fromNow()),d=""+f+" ("+o+")",u+="            <div>              "+a+" -              "+d+"              <button data-result-id='"+c.id+"' class='details command'>details</button>              <div id='details_"+c.id+"'></div>            </div>          ";return r.$el.find("#results_container").html(u),r.$el.find(e).focus()}})},t.prototype.afterRender=function(){var e,t,n,r,i;r=this.subViews,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(typeof e.afterRender=="function"?e.afterRender():void 0);return i},t.prototype.clearSubViews=function(){var e,t,n,r;r=this.subViews;for(t=0,n=r.length;t<n;t++)e=r[t],e.close();return this.subViews=[]},t}(Backbone.View);var ResultSumView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ResultSumView=function(e){function t(){return this.afterRender=__bind(this.afterRender,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="info_box",t.prototype.events={"click .details":"toggleDetails"},t.prototype.toggleDetails=function(){return this.$el.find(".detail_box").toggle(250)},t.prototype.initialize=function(e){var t,n,r,i,s,o,u;this.result=e.model,this.finishCheck=e.finishCheck,this.finished=((s=_.last(this.result.attributes.subtestData))!=null?s.data.end_time:void 0)!=null?!0:!1,this.studentId="",o=this.result.attributes.subtestData,u=[];for(r=0,i=o.length;r<i;r++){n=o[r],t=n.prototype;if(t==="id"){this.studentId=n.data.participant_id;break}u.push(void 0)}return u},t.prototype.render=function(){var e,t,n,r,i,s;t="<div class='detail_box'>",!this.finished&&!!this.finishCheck&&(t+="<div>Not finished<a href='#resume/"+this.result.get("assessmentId")+"/"+this.result.id+"'><button class='command'>Resume</button></a></div>"),s=this.result.get("subtestData");for(n=r=0,i=s.length;r<i;n=++r)e=s[n],t+="<div><span id='"+this.cid+"_"+n+"'></span>"+e.name+" - items "+e.sum.total+"</div>";return t+="      </div>    ",this.$el.html(t),this.trigger("rendered")},t.prototype.afterRender=function(){var e,t,n,r,i,s;s=this.result.get("subtestData");for(t=r=0,i=s.length;r<i;t=++r)e=s[t],n="#"+this.cid+"_"+t,this.$el.find(n).sparkline([e.sum.correct,e.sum.incorrect,e.sum.missing],{type:"pie",width:"30",height:"30",sliceColors:["#6f6","#c66","#ccc"]});return null},t}(Backbone.View);var CSVView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};CSVView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="CSVView",t.prototype.exportValueMap={correct:1,checked:1,incorrect:0,unchecked:0,missing:".",not_asked:".",skipped:999},t.prototype.initialize=function(e){var t,n=this;return this.assessmentId=Utils.cleanURL(e.assessmentId),t=new Results,t.fetch({key:this.assessmentId,success:function(e){return n.results=e.models,n.render()}}),this.metaKeys=["enumerator"]},t.prototype.exportValue=function(e){return this.exportValueMap[e]!=null?this.exportValueMap[e]:e},t.prototype.render=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,D,P,H,B,j,F,I,q,R,U,z,W,X,V,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft,lt,ct,ht,pt,dt,vt,mt,gt,yt,bt,wt=this;if(this.results!=null&&this.results[0]!=null){L="",r=[],e=[],f=[],Z=this.results;for(O=0,H=Z.length;O<H;O++){E=Z[O],y=E.has("order_map")?E.get("order_map"):function(){vt=[];for(var e=0,t=E.attributes.subtestData.length-1;0<=t?e<=t:e>=t;0<=t?e++:e--)vt.push(e);return vt}.apply(this);for(w=D=0,ut=E.attributes.subtestData.length-1;0<=ut?D<=ut:D>=ut;w=0<=ut?++D:--D){T=y.indexOf(w),x=E.attributes.subtestData[T];if(x==null){console.log(""+w+" => "+T),console.log(x);continue}N=(at=x.name)!=null?at.toLowerCase().dasherize():void 0,b=x.prototype,a=[];if(b==="id")a.push("id");else if(b==="datetime")a.push("year","month","date","assess_time");else if(b==="location"){ft=x.data.labels;for(P=0,B=ft.length;P<B;P++)l=ft[P],a.push(l)}else if(b==="consent")a.push("consent");else if(b==="grid"){A=x.data.variable_name,a.push(""+A+"_auto_stop",""+A+"_time_remain",""+A+"_attempted",""+A+"_item_at_time",""+A+"_time_intermediate_captured",""+A+"_correct_per_minute"),lt=x.data.items;for(s=V=0,F=lt.length;V<F;s=++V)u=lt[s],a.push(""+A+(s+1))}else if(b==="survey"){ct=x.data;for(k in ct){C=ct[k];if(_.isObject(C))for(m in C)g=C[m],a.push(""+k+"_"+m);else a.push(k)}}else if(b==="observation"){ht=x.data.surveys;for(s=J=0,I=ht.length;J<I;s=++J){v=ht[s],d=v.data;for(k in d){C=d[k];if(_.isObject(C))for(m in C)g=C[m],a.push(""+k+"_"+m+"_"+(s+1));else a.push(""+k+"_"+(s+1))}}}else b==="complete"&&a.push("additional_comments","end_time","gps_latitude","gps_longitude","gps_accuracy");f[w]==null&&(f[w]=[]),f[w].length<a.length&&(f[w]=a)}}this.metaKeys.push("start_time","order_map"),e=this.metaKeys.concat(_.flatten(f)),r.push(e),pt=this.results;for(i=K=0,q=pt.length;K<q;i=++K){E=pt[i],S=[],dt=this.metaKeys;for(Q=0,R=dt.length;Q<R;Q++)c=dt[Q],E.attributes[c]!=null&&S.push(E.attributes[c]);S[e.indexOf("start_time")]=E.has("starttime")?E.get("starttime"):E.get("start_time"),S[e.indexOf("order_map")]=E.has("order_map")?E.get("order_map"):"no_record",tt=E.attributes.subtestData;for(G=0,U=tt.length;G<U;G++){x=tt[G],b=x.prototype;if(b==="id")S[e.indexOf("id")]=x.data.participant_id;else if(b==="location"){nt=x.data.labels;for(s=Y=0,z=nt.length;Y<z;s=++Y)l=nt[s],S[e.indexOf(l)]=x.data.location[s]}else if(b==="datetime")p=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],~p.indexOf(x.data.month.toLowerCase())?h=p.indexOf(x.data.month.toLowerCase())+1:h=x.data.month,S[e.indexOf("year")]=x.data.year,S[e.indexOf("month")]=h,S[e.indexOf("date")]=x.data.day,S[e.indexOf("assess_time")]=x.data.time;else if(b==="consent")S[e.indexOf("consent")]=x.data.consent;else if(b==="grid"){A=x.data.variable_name,S[e.indexOf(""+A+"_auto_stop")]=x.data.auto_stop,S[e.indexOf(""+A+"_time_remain")]=x.data.time_remain,S[e.indexOf(""+A+"_attempted")]=x.data.attempted,S[e.indexOf(""+A+"_item_at_time")]=x.data.item_at_time,S[e.indexOf(""+A+"_time_intermediate_captured")]=x.data.time_intermediate_captured,S[e.indexOf(""+A+"_correct_per_minute")]=x.sum.correct_per_minute,rt=x.data.items;for(s=mt=0,W=rt.length;mt<W;s=++mt)u=rt[s],S[e.indexOf(""+A+(s+1))]=this.exportValue(u.itemResult)}else if(b==="survey"){it=x.data;for(k in it){C=it[k];if(_.isObject(C))for(m in C)g=C[m],S[e.indexOf(""+k+"_"+m)]=this.exportValue(g);else S[e.indexOf(""+k)]=this.exportValue(C)}}else if(b==="observation"){st=x.data.surveys;for(s=gt=0,X=st.length;gt<X;s=++gt){v=st[s],d=v.data;for(k in d){C=d[k];if(_.isObject(C))for(m in C)g=C[m],S[e.indexOf(""+k+"_"+m+"_"+(s+1))]=this.exportValue(g);else S[e.indexOf(""+k+"_"+(s+1))]=this.exportValue(C)}}}else b==="complete"&&(S[e.indexOf("additional_comments")]=x.data.comment,S[e.indexOf("end_time")]=x.data.end_time,x.data.gps!=null&&(S[e.indexOf("gps_latitude")]=x.data.gps.latitude,S[e.indexOf("gps_longitude")]=x.data.gps.longitude,S[e.indexOf("gps_accuracy")]=x.data.gps.accuracy))}r.push(S)}for(s=yt=0,j=r.length;yt<j;s=++yt){S=r[s],L+="<tr>",t=0;for(o=bt=0,ot=S.length-1;0<=ot?bt<=ot:bt>=ot;o=0<=ot?++bt:--bt)L+="<td>"+S[o]+"</td>",t++;L+="</tr>"}L=L.replace(/undefined/g,"no_record"),this.csv=$("<table>"+L+"</table>").table2CSV({delivery:"value"}),n=new Backbone.Model({_id:"Tangerine-"+this.assessmentId.substr(-5,5)+".csv"}),n.url="csv",n.fetch({complete:function(){return n.save({csv:wt.csv},{complete:function(){return wt.trigger("ready")}})}})}return this.trigger("rendered")},t}(Backbone.View);var DashboardView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};DashboardView=function(e){function t(){return this.renderResults=__bind(this.renderResults,this),this.render=__bind(this.render,this),this.update=__bind(this.update,this),this.syntaxHighlight=__bind(this.syntaxHighlight,this),this.showResult=__bind(this.showResult,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="DashboardView",t.prototype.events={"change #groupBy":"update","change #assessment":"update","change #shiftHours":"update","click .result":"showResult"},t.prototype.showResult=function(e){var t,n,r=this;return t=$("#resultDetails"),t.is(":visible")?t.hide():(n=$(e.target).text(),$.couch.db(document.location.pathname.match(/^\/(.*?)\//).pop()).openDoc(n,{success:function(n){return t.html("<pre>"+r.syntaxHighlight(n)+"</pre>"),t.css({top:$(e.target).position().top+30,width:400,left:50}),t.show()}}))},t.prototype.syntaxHighlight=function(e){return window.json=e,typeof e!="string"&&(e=JSON.stringify(e,void 0,2)),e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){var t;return t="number",/^"/.test(e)?/:$/.test(e)?t="key":t="string":/true|false/.test(e)?t="boolean":/null/.test(e)&&(t="null"),'<span class="'+t+'">'+e+"</span>"})},t.prototype.update=function(){return Tangerine.router.navigate("dashboard/groupBy/"+$("#groupBy").val()+"/assessment/"+$("#assessment").val()+"/shiftHours/"+$("#shiftHours").val(),!0)},t.prototype.render=function(){var e;return e=this.options,this.groupBy=e.groupBy,this.key=e.assessment,this.shiftHours=e.shiftHours||0,this.key==="All"?$.couch.db(Tangerine.db_name).view(""+Tangerine.design_doc+"/dashboardResults",{reduce:!1,success:this.renderResults}):$.couch.db(Tangerine.db_name).view(""+Tangerine.design_doc+"/dashboardResults",{key:this.key,reduce:!1,success:this.renderResults})},t.prototype.renderResults=function(e){var t,n,r,i=this;return r={},t={},n={},this.groupBy==null&&(this.groupBy=_.keys(e.rows[0].value)[0]),_.each(e.rows,function(e){var s,o;return o=e.value[i.groupBy],s=e.value.startTime?moment(e.value.startTime).add("h",i.shiftHours).format("Do MMM"):"Unknown",t[s]=s,r[o]==null&&(r[o]={}),r[o][s]==null&&(r[o][s]=[]),r[o][s].push("        <div style='padding-top:10px;'>          <table>          "+_.map(e.value,function(e,t){return n[t]=!0,t==="startTime"&&(e=moment(e).add("h",i.shiftHours).format("YYYY-MM-DD HH:mm")),t==="resultId"&&(e="<button class='result'>"+e+"</button>"),"<tr><td>"+t+"</td><td>"+e+"</td></tr>"}).join("")+"          </table>        </div>        <hr/>      ")}),this.$el.html("      Assessment:      <select id='assessment'>      </select>      <br/>      Value used for grouping:      <select id='groupBy'>        "+_.map(n,function(e,t){return"<option "+(t===i.groupBy?"selected='true'":"")+">              "+t+"            </option>"})+"      </select>      <br/>      <br/>      <button onClick='$(\"#advancedOptions\").toggle()'>Advanced Options</button>      <div style='display:none' id='advancedOptions'>      Current time in your timezone ("+jstz.determine().name()+") is "+moment().format("YYYY-MM-DD HH:mm")+"<br/>      Shift time values by <input id='shiftHours' type='number' value='"+this.shiftHours+"'></input> hours to handle correct timezone.<br/>      Shifted time: "+moment().add("h",this.shiftHours).format("YYYY-MM-DD HH:mm")+"      <br/>      </div>      <table id='results' class='tablesorter'>        <thead>          <th>"+this.groupBy+"</th>          "+_.map(_.sortBy(t,function(e){return e}),function(e){return"<th class='"+e.replace(/\s/g,"-")+"'>"+e+"</th>"}).join("")+"        </thead>        <tbody>          "+_.map(r,function(e,n){return"<tr>                <td>"+n+"</td>                "+_.map(_.sortBy(t,function(e){return e}),function(t){return"<td class='"+t.replace(/\s/g,"-")+"'>                      "+(e[t]?"                            <button class='sort-value' onClick='$(this).siblings().toggle()'>"+e[t].length+"</button>                            <div style='display:none'>                              "+e[t].join("")+"                            </div>                          ":"")+"                    </td>"}).join("")+"              </tr>"}).join("")+"        </tbody>      </table>      <div id='resultDetails'>      </div>      <style>        #resultDetails{          position:absolute;          background-color:black;          display:none;        }        pre {          font-size: 75%;          outline: 1px solid #ccc;           padding: 5px;           margin: 5px;           text-shadow: none;          overflow-wrap:break-word;        }        .string { color: green; }        .number { color: darkorange; }        .boolean { color: blue; }        .null { color: magenta; }        .key { color: red; }      </style>    "),$("table").tablesorter({widgets:["zebra"],sortList:[[0,0]],textExtraction:function(e){var t;return t=$(e).find(".sort-value").text(),t!==""?t:$(e).text()}}),$("#advancedOptions").append("Select which dates to show<br/>"),_.each(_.sortBy(t,function(e){return e}),function(e){var t;return t=$("<label for='"+e+"'>"+e+"</label><input name='"+e+"' id='"+e+"' type='checkbox' checked='true'/>"),t.click(function(){return $("."+e.replace(/\s/,"-")).toggle()}),$("#advancedOptions").append(t)}),$.couch.db(Tangerine.db_name).view(""+Tangerine.design_doc+"/dashboardResults",{group:!0,success:function(e){return $("select#assessment").html("<option>All</option>"+_.map(e.rows,function(e){return"<option value='"+e.key+"' "+(e.key===i.key?"selected='true'":"")+">"+e.key+"</option>"}).join("")),_.each(e.rows,function(e){if(e.key==null)return;return $.couch.db(Tangerine.db_name).openDoc(e.key,{success:function(t){return $("option[value="+e.key+"]").html(t.name)},error:function(t){return $("option[value="+e.key+"]").html("Unknown assessment")}})})}}),this.trigger("rendered")},t}(Backbone.View);var AdminView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};AdminView=function(e){function t(){return this.render=__bind(this.render,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="AdminView",t.prototype.render=function(){var e=this;return $.couch.allDbs({success:function(t){var n;return n=_(t).filter(function(e){return e.match(/^group-/)}),e.$el.html("          TODO: <button>Replicate from update database to all existing groups (design doc, views, etc)</button>          <h2>Active Groups</h2>        "),_(n).each(function(t){var n;return n=t.replace(/group-/,""),$.couch.db(t).view(Tangerine.design_doc+"/resultCount",{group:!0,success:function(r){return e.$el.append("                <h2>"+n+"</h2>                <table id='"+t+"'>                  <tr>                    <td>Version</td><td id='"+t+"-version'></td>                  </tr>                  <tr>                    <td>Last Result</td><td id='"+t+"-last-result'></td>                  </tr>                  <tr>                    <td>Total Assessments</td><td id='"+t+"-total-assessments'></td>                  </tr>                  <tr>                    <td>Total Results</td><td id='"+t+"-total-results'></td>                  </tr>                </table>                <button onClick='document.location='>"+n+" Dashboard</button><br/>                <button onClick='$(\"#"+t+"-details\").toggle()'>Details</button>                <table style='display:none' id='"+t+"-details'>                  <thead>                    <th>Assessment</th>                    <th>Number of Results</th>                  </thead>                  "+_(r.rows).map(function(e){return"                    <tr>                      <td id='"+e.key+"'>"+e.key+"</td><td class='result-count'>"+e.value+"</td>                    </tr>                    "}).join("")+"                </table>              "),$("#"+t+"-total-assessments").html(e.$el.find("table#"+t+"-details tr").length),$("#"+t+"-total-results").html(_(e.$el.find(".result-count")).reduce(function(e,t){return e+=parseInt($(t).text())},0)),$.couch.db(t).view(Tangerine.design_doc+"/resultSummaryByAssessmentId",{group:!0,success:function(e){return _(e.rows).each(function(e){if(e.value!=null)return $("#"+t+"-last-result").html("                        <span data-end-time='"+e.value+"'>"+moment(e.value).fromNow()+"</span>                      ")})}}),$.ajax("/"+t+"/_design/"+Tangerine.design_doc+"/js/version.js",{dataType:"text",success:function(e){return $("#"+t+"-version").html(e.match(/"(.*)"/)[1])}}),_.each(r.rows,function(e){if(e.key==null)return;return $.couch.db(t).openDoc(e.key,{success:function(t){return $("#"+e.key).html(t.name)},error:function(t){return $("#"+e.key).html("Unknown assessment")}})})}})}),e.trigger("rendered")}})},t}(Backbone.View);var Question,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Question=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="question",t.prototype.config={types:["multiple","single","open"]},t.prototype["default"]={order:0,prompt:"Is this an example question?",hint:"[hint or answer]",type:"single",otherWriteIn:!1,options:[],linkedGridScore:0,skipLink:null,skipRequirement:null},t.prototype.initialize=function(e){},t}(Backbone.Model);var Questions,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Questions=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.model=Question,t.prototype.url="question",t.prototype.db={view:"questionsByAssessmentId"},t.prototype.comparator=function(e){return e.get("order")},t.prototype.maintainOrder=function(){var e,t,n,r,i,s,o,u,a;i=function(){var e,n,r,i;r=this.models,i=[];for(e=0,n=r.length;e<n;e++)t=r[e],i.push(t.get("order"));return i}.call(this).join(""),n=function(){var n,r,i,s;i=this.models,s=[];for(e=n=0,r=i.length;n<r;e=++n)t=i[e],s.push(e);return s}.call(this).join("");if(i!==n){u=this.models,a=[];for(e=s=0,o=u.length;s<o;e=++s)r=u[e],r.set("order",e),a.push(r.save());return a}},t}(Backbone.Collection);var QuestionRunView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};QuestionRunView=function(e){function t(){return this.setMessage=__bind(this.setMessage,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="question buttonset",t.prototype.events={"change input":"update","change textarea":"update","click .autoscroll_icon":"scroll"},t.prototype.scroll=function(e){return this.trigger("scroll",e,this.model.get("order"))},t.prototype.initialize=function(e){this.model=e.model,this.answer={},this.name=this.model.escape("name").replace(/[^A-Za-z0-9_]/g,"-"),this.type=this.model.get("type"),this.options=this.model.get("options"),this.notAsked=e.notAsked,this.isObservation=e.isObservation,this.defineSpecialCaseResults(),this.model.getBoolean("skippable")?(this.isValid=!0,this.skipped=!0):(this.isValid=!1,this.skipped=!1);if(this.notAsked===!0)return this.isValid=!0,this.updateResult()},t.prototype.update=function(e){return this.updateResult(),this.updateValidity(),this.trigger("answer",e,this.model.get("order"))},t.prototype.updateResult=function(){var e,t,n,r,i,s,o,u;if(this.type==="open")this.notAsked===!0?this.answer="not_asked":this.answer=this.$el.find("#"+this.cid+"_"+this.name).val();else if(this.type==="single")this.notAsked===!0?this.answer="not_asked":this.answer=this.$el.find("."+this.cid+"_"+this.name+":checked").val();else if(this.type==="multiple")if(this.notAsked===!0){o=this.options;for(e=n=0,i=o.length;n<i;e=++n)t=o[e],this.answer[this.options[e].value]="not_asked"}else{u=this.options;for(e=r=0,s=u.length;r<s;e=++r)t=u[e],this.answer[this.options[e].value]=this.$el.find("#"+this.cid+"_"+this.name+"_"+e).is(":checked")?"checked":"unchecked"}return this.$el.attr("data-result",_.isString(this.answer)?this.answer:JSON.stringify(this.answer))},t.prototype.updateValidity=function(){var e,t,n,r;r=this.model.getBoolean("skippable"),t=this.$el.hasClass("disabled_autostop"),n=this.$el.hasClass("disabled_skipped");if(r||n||t)return this.isValid=!0,this.skipped=_.isEmpty(this.answer)?!0:!1;e=this.model.get("customValidationCode");if(!!_.isEmpty(e))return this.isValid=_.isEmpty(this.answer)?!1:!0;try{return this.isValid=CoffeeScript.eval.apply(this,[e])}catch(i){return alert("Custom Validation error\n\n"+i)}},t.prototype.setMessage=function(e){return this.$el.find(".error_message").html(e)},t.prototype.render=function(){var e,t,n,r,i,s,o;this.$el.attr("id","question-"+this.name);if(!this.notAsked){t="<div class='error_message'></div><div class='prompt'>"+this.model.get("prompt")+"</div>      <div class='hint'>"+(this.model.get("hint")||"")+"</div>";if(this.type==="open")this.model.get("multiline")?t+="<div><textarea id='"+this.cid+"_"+this.name+"' data-cid='"+this.cid+"'></textarea></div>":t+="<div><input id='"+this.cid+"_"+this.name+"' data-cid='"+this.cid+"'></div>";else{e=this.type==="multiple"?"checkbox":"radio",o=this.options;for(n=i=0,s=o.length;i<s;n=++i)r=o[n],t+="            <label for='"+this.cid+"_"+this.name+"_"+n+"'>"+r.label+"</label>            <input id='"+this.cid+"_"+this.name+"_"+n+"' class='"+this.cid+"_"+this.name+"'  data-cid='"+this.cid+"' name='"+this.name+"' value='"+r.value+"' type='"+e+"'>          "}this.isObservation&&(t+="<img src='images/icon_scroll.png' class='icon autoscroll_icon' data-cid='"+this.cid+"'>"),this.$el.html(t)}else this.$el.hide();return this.trigger("rendered")},t.prototype.defineSpecialCaseResults=function(){var e,t,n,r,i,s,o,u,a;n=["missing","notAsked","skipped","logicSkipped","notAskedAutostop"];for(i=0,o=n.length;i<o;i++){e=n[i];if(this.type==="single"||this.type==="open")this[e+"Result"]=e;if(this.type==="multiple"){this[e+"Result"]={},a=this.options;for(t=s=0,u=a.length;s<u;t=++s)r=a[t],this[e+"Result"][this.options[t].value]=e}}},t}(Backbone.View);var QuestionEditView,__bind=function(e,t){return function(){return e.apply(t,arguments
)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};QuestionEditView=function(e){function t(){return this.updateModel=__bind(this.updateModel,this),this.goBack=__bind(this.goBack,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="question_list_element",t.prototype.events={"click .back":"goBack","click .done":"done","click .add_option":"addOption","click .delete_option":"showDeleteConfirm","click .delete_cancel":"hideDeleteConfirm","click .delete_delete":"deleteOption","click #question_type input:radio":"changeQuestionType",keypress:"hijackEnter","change .option_select":"templateFill","keypress .option_value":"quickAddWithEnter","keypress .option_label":"quickFocusValue","change #custom_validation_code":"validateSyntax"},t.prototype.initialize=function(e){return this.activity=null,this.timer=0,this.question=e.question,this.subtest=e.subtest,this.assessment=e.assessment},t.prototype.validateSyntax=function(){var e,t;if(!_.isEmpty(e=this.$el.find("#custom_validation_code").val()))try{return t=this.answer,this.answer={},this.isValid=CoffeeScript.eval.apply(this,[e]),t!=null?this.answer=t:delete this.answer}catch(n){return alert("Custom Validation error for "+this.name+" \n\n"+n)}},t.prototype.quickAddWithEnter=function(e){return e.keyCode!=null&&e.keyCode!==13?!0:this.addOption()},t.prototype.quickFocusValue=function(e){return e.keyCode!=null&&e.keyCode!==13?!0:$(e.target).parent().find(".option_value").focus()},t.prototype.templateFill=function(e){var t,n;return t=$(e.target).find("option:selected").attr("data-index"),n=Tangerine.templates.get("optionTemplates"),n[t]!=null&&(this.question.set("options",n[t].options),this.$el.find("#option_list_wrapper").html(this.getOptionList())),!1},t.prototype.getOptionList=function(){var e,t,n,r,i,s;r=this.question.get("options"),e="<h2>Options</h2>      <div class='menu_box'>        <ul id='option_list'>    ";for(t=i=0,s=r.length;i<s;t=++i)n=r[t],e+="      <li class='question'>        <table><tr><td>          <img src='images/icon_drag.png' class='sortable_handle'>        </td>        <td>          <div style='display: block;'>            <div class='option_label_value'>              <label class='edit' for='options."+t+".label'>Label</label>              <input id='options."+t+".label' value='"+_.escape(n.label)+"' placeholder='Option label' class='option_label'><br>              <label class='edit' for='options."+t+".value' title='Allowed characters&#58; A-Z, a-z, 0-9, and underscores.'>Value</label>              <input id='options."+t+".value' value='"+_.escape(n.value)+"' placeholder='Option value' class='option_value'><br>            </div>            <img src='images/icon_delete.png' class='delete_option' data-index='"+t+"'>            <div class='confirmation delete_confirm_"+t+"'>              <button class='delete_delete command_red' data-index='"+t+"'>Delete</button>              <button data-index='"+t+"' class='delete_cancel command'>Cancel</button>            </div>          </div>        </td></tr></table>      </li>      ";return e+="</ul>      <button class='add_option command'>Add option</button>    </div>    "},t.prototype.addOption=function(){var e,t;this.updateModel(),t=this.question.get("options"),t.push({label:"",value:""}),this.question.set("options",t),this.refreshOptionList(),e=this.$el.find("#option_list_wrapper li");if(e.length!==0)return $(e.last()).scrollTo().find("input:first").focus()},t.prototype.render=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y;e=this.assessment.escape("name"),v=this.subtest.escape("name"),u=this.question.escape("name")||"",h=this.question.escape("prompt")||"",i=this.question.escape("hint")||"",p=this.question.escape("skipLogic")||"",n=this.question.escape("customValidationCode")||"",r=this.question.escape("customValidationMessage")||"",m=this.question.get("type"),c=this.question.get("options"),o=this.question.get("linkedGridScore")||0,d=this.question.get("skippable")===!0||this.question.get("skippable")==="true",t=m==="multiple"?"checkbox":"radio",this.$el.html("      <button class='back navigation'>Back</button>      <h1>Question Editor</h1>      <table class='basic_info'>        <tr>          <th>Subtest</th>          <td>"+v+"</td>        </tr>        <tr>          <th>Assessment</th>          <td>"+e+"</td>        </tr>      </table>      <button class='done command'>Done</button>      <div class='edit_form'>        <div class='label_value'>          <label for='name'>Variable name</label>          <input id='name' type='text' value='"+u+"'>        </div>        <div class='label_value'>          <label for='prompt'>Prompt</label>          <input id='prompt' type='text' value='"+h+"'>        </div>        <div class='label_value'>          <label for='hint'>Note to enumerator</label>          <input id='hint' type='text' value='"+i+"'>        </div>        <div class='label_value'>          <label for='skip-logic'>Skip if <span style='font-size: small;font-weight:normal'>example: ResultOfQuestion(\"maze1\") isnt \"2\" Example 2: \"red\" in ResultOfMultiple(\"fave_colors\")</span></label>          <input id='skip-logic' type='text' value='"+p+"'>        </div>        <div class='menu_box'>          <label>Custom validation</label>          <div class='label_value'>            <label for='custom_validation_code' title='Intended for open questions. This code should evaluate to true or false. False will trigger an error message for this question. E.g. @answer == \"1\" will evaluate to false for any value other than 1.'>Valid when</label>            <input id='custom_validation_code' type='text' value='"+n+"'>          </div>          <div class='label_value'>            <label for='custom_validation_message'>Error message</label>            <input id='custom_validation_message' type='text' value='"+r+"'>          </div>        </div>        <div class='label_value'>          <label>Skippable</label>          <div id='skip_radio' class='buttonset'>            <label for='skip_true'>Yes</label><input name='skippable' type='radio' value='true' id='skip_true' "+(d?"checked":void 0)+">            <label for='skip_false'>No</label><input name='skippable' type='radio' value='false' id='skip_false' "+(d?void 0:"checked")+">          </div>        </div>        <div class='label_value'>          <label for='linked_grid_score'>Items attempted required on linked grid</label>          <input id='linked_grid_score' type='number' value='"+o+"'>        </div>        <div class='label_value' id='question_type' class='question_type'>          <label>Question Type</label>          <div class='buttonset'>            <label for='single'>single</label>            <input id='single' name='type' type='radio' value='single' "+(m==="single"?"checked":void 0)+">            <label for='multiple'>multiple</label>            <input id='multiple' name='type'  type='radio' value='multiple' "+(m==="multiple"?"checked":void 0)+">            <label for='open'>open</label>            <input id='open' name='type'  type='radio' value='open' "+(m==="open"?"checked":void 0)+">          </div>        </div>        ");if(m!=="open"){f="        <div class='label_value'>        <label for='question_template_select'>Fill from template</label><br>        <div class='menu_box'>          <select id='question_template_select' class='option_select'>            <option selected='selected'>Select template</option>        ",l=Tangerine.templates.get("optionTemplates");for(s=g=0,y=l.length;g<y;s=++g)a=l[s],f+="<option data-index='"+s+"' class='template_option'>"+a.name+"</option>";f+="</select>        </div>        <div id='option_list_wrapper'>"+this.getOptionList()+"</div>        ",this.$el.append(f),this.refreshSortable()}return this.$el.append("<button class='done command'>Done</button>      </div>      "),this.trigger("rendered")},t.prototype.refreshOptionList=function(){return this.$el.find("#option_list_wrapper").html(this.getOptionList()),this.refreshSortable()},t.prototype.refreshSortable=function(){var e=this;return this.$el.find("#option_list").sortable({handle:".sortable_handle",start:function(e,t){return t.item.addClass("drag_shadow")},stop:function(e,t){return t.item.removeClass("drag_shadow")},update:function(t,n){return e.updateModel()}})},t.prototype.hijackEnter=function(e){if(e.which===13)return this.$el.find(e.target).blur(),!1},t.prototype.changeQuestionType=function(e){var t;t=$(e.target);if(t.val()!=="open"&&this.question.get("type")==="open"||t.val()==="open"&&this.question.get("type")!=="open")return this.updateModel(),this.question.set("type",t.val()),this.question.set("options",[]),this.render()},t.prototype.done=function(){var e=this;return this.activity!==null?!1:(this.activity="saving",this.updateModel(),this.question.save(null,{success:function(){return e.activity=null,Utils.midAlert("Question Saved"),clearTimeout(e.timer),e.timer=setTimeout(e.goBack,500)},error:function(){return e.activity=null,Utils.midAlert("Save error")}}),!1)},t.prototype.goBack=function(){return Tangerine.router.navigate("subtest/"+this.question.get("subtestId"),!0),!1},t.prototype.updateModel=function(){var e,t,n,r,i,s,o,u,a;this.question.set({prompt:this.$el.find("#prompt").val(),name:this.$el.find("#name").val().safetyDance(),hint:this.$el.find("#hint").val(),skipLogic:this.$el.find("#skip-logic").val(),linkedGridScore:parseInt(this.$el.find("#linked_grid_score").val()),type:this.$el.find("#question_type input:checked").val(),skippable:this.$el.find("#skip_radio input:radio[name=skippable]:checked").val()==="true",customValidationCode:this.$el.find("#custom_validation_code").val(),customValidationMessage:this.$el.find("#custom_validation_message").val()}),s=[],e=0,i=this.$el.find("#option_list li");for(u=0,a=i.length;u<a;u++){r=i[u],t=$(r).find(".option_label").val(),o=$(r).find(".option_value").val().safetyDance();if(t!=null||o!=null)s[e]={label:t,value:o},e++}return s.length!==0&&(n=s.pop(),n.label!==""&&n.value!==""&&s.push(n)),this.question.set("options",s)},t.prototype.showDeleteConfirm=function(e){return this.$el.find(".delete_confirm_"+this.$el.find(e.target).attr("data-index")).fadeIn(250)},t.prototype.hideDeleteConfirm=function(e){return this.$el.find(".delete_confirm_"+this.$el.find(e.target).attr("data-index")).fadeOut(250)},t.prototype.deleteOption=function(e){var t;return this.updateModel(),t=this.question.get("options"),t.splice(this.$el.find(e.target).attr("data-index"),1),this.question.set("options",t),this.refreshOptionList(),!1},t}(Backbone.View);var QuestionsEditView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};QuestionsEditView=function(e){function t(){return this.render=__bind(this.render,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="questions_edit_view",t.prototype.tagName="ul",t.prototype.initialize=function(e){return this.views=[],this.questions=e.questions},t.prototype.onClose=function(){return this.closeViews()},t.prototype.closeViews=function(){var e,t,n,r,i;r=this.views,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.close());return i},t.prototype.render=function(){var e,t,n,r,i,s,o=this;this.closeViews(),s=this.questions.models;for(e=r=0,i=s.length;r<i;e=++r)t=s[e],n=new QuestionsEditListElementView({question:t}),this.views.push(n),n.on("deleted",this.render),n.on("question-edit",function(e){return console.log("passing up a qID"),console.log(e),o.trigger("question-edit",e)}),n.render(),this.$el.append(n.el);return this.$el.sortable({handle:".sortable_handle",start:function(e,t){return t.item.addClass("drag_shadow")},stop:function(e,t){return t.item.removeClass("drag_shadow")},update:function(t,n){var r,i,s,u,a,f,l;f=function(){var e,t,n,r;n=this.$el.find("li.question_list_element"),r=[];for(e=0,t=n.length;e<t;e++)i=n[e],r.push($(i).attr("data-id"));return r}.call(o),l=[];for(e=u=0,a=f.length;u<a;e=++u)r=f[e],s=o.questions.get(r),l.push(o.questions.get(r).set({order:e},{silent:!0}).save(null,{silent:!0}));return l}})},t}(Backbone.View);var QuestionsEditListElementView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};QuestionsEditListElementView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="question_list_element",t.prototype.tagName="li",t.prototype.events={"click .edit":"edit","click .delete":"toggleDelete","click .delete_cancel":"toggleDelete","click .delete_delete":"delete"},t.prototype.edit=function(e){return console.log("trying to edit my ID"),console.log(this.question.id),this.trigger("question-edit",this.question.id),!1},t.prototype.toggleDelete=function(){return this.$el.find(".delete_confirm").fadeToggle(250)},t.prototype["delete"]=function(e){return this.question.collection.remove(this.question.id),this.question.destroy(),this.trigger("deleted"),!1},t.prototype.initialize=function(e){return this.question=e.question,this.$el.attr("data-id",this.question.id)},t.prototype.render=function(){return this.$el.html("      <table>        <tr>          <td>            <img src='images/icon_drag.png' class='sortable_handle'>          </td>          <td>            <span>"+this.question.get("prompt")+"</span> <span>[<small>"+this.question.get("name")+", "+this.question.get("type")+"</small>]</span>            <img src='images/icon_edit.png' class='link_icon edit'>            <img src='images/icon_delete.png' class='link_icon delete'><br>            <div class='confirmation delete_confirm'>              <div class='menu_box'>Confirm<br><button class='delete_delete command_red'>Delete</button><button class='delete_cancel command'>Cancel</button>            </div>          </td>        </tr>      </table>      "),this.trigger("rendered")},t}(Backbone.View);var Klass,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Klass=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="klass",t.prototype.initialize=function(){},t.prototype.destroy=function(){var e,n,r;return r=this.id,n=new Students,n.fetch({success:function(e){var t,n,i,s,o;n=e.where({klassId:r}),o=[];for(i=0,s=n.length;i<s;i++)t=n[i],o.push(t.save({klassId:""}));return o}}),e=new Results,e.fetch({success:function(e){var t,n,i,s,o;n=e.where({klassId:r}),o=[];for(i=0,s=n.length;i<s;i++)t=n[i],o.push(t.destroy());return o}}),t.__super__.destroy.call(this)},t.prototype.calcCurrentPart=function(){var e,t,n,r,i;return e=1e3,r=60*e,n=60*r,t=24*n,i=7*t,Math.round(((new Date).getTime()-this.get("startDate"))/i)},t}(Backbone.Model);var KlassView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="KlassView",n.prototype.initialize=function(e){var t,n=this;return this.klass=e.klass,this.assessments=this.klass.assessments,this.results=[],t=new KlassAssessments,t.fetch({success:function(e){var t;return n.assessments=e.where({klassId:n.klass.id}),t=new Results,t.fetch({success:function(e){var t,r,i,s;s=n.assessments;for(r=0,i=s.length;r<i;r++)t=s[r],t.results=e.where({assessmentId:t.id});return n.render()}})}})},n.prototype.render=function(){var e,n,r,i,s,o,u,a,f;s=this.klass.get("year")||"",n=this.klass.get("grade")||"",i=this.klass.get("stream")||"",r="    <h1>"+t("class")+" "+i+"</h1>    <table>      <tr><td>School year</td><td>"+s+"</td></tr>      <tr><td>"+t("grade")+"</td><tr>"+n+"</td></tr>    </table>    </div>    <ul class='assessment_list'>",a=this.assessments;for(o=0,u=a.length;o<u;o++)e=a[o],r+="<li data-id='"+e.id+"'>"+e.get("name")+" - "+((f=e.get("results"))!=null?f.length:void 0)+"</li>";return r+="</ul>",this.$el.html(r),this.trigger("rendered")},n}(Backbone.View);var KlassEditView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassEditView=function(e){function n(){return this.renderStudents=__bind(this.renderStudents,this),this.onSubviewRendered=__bind(this.onSubviewRendered,this),this.registerStudent=__bind(this.registerStudent,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="KlassEditView",n.prototype.events={"click .back":"back","click .save":"basicInfoSave","click .basic_info_edit":"basicInfoToggle","click .basic_info_cancel":"basicInfoToggle","change #teacher_select":"teacherSelect","click .add_student":"addStudentToggle","click .add_student_cancel":"addStudentToggle","click .add_student_add":"addStudent","click .register_student":"registerStudentToggle","click .register_student_cancel":"registerStudentToggle","click .register_student_save":"registerStudent"},n.prototype.teacherSelect=function(e){var t;return t=this.$el.find("#teacher_select option:selected").attr("data-teacherId"),this.klass.set("teacherId",t)},n.prototype.addStudentToggle=function(){return this.$el.find(".add_student_form, .add_student").toggle()},n.prototype.registerStudentToggle=function(){return this.$el.find(".register_student_form, .register_student").toggle(),this.$el.find(".register_student_form").is(":visible")&&this.$el.find(".register_student_form").scrollTo(),this.$el.find("#register_student_name ,#register_student_gender, #register_student_age").val("")},n.prototype.addStudent=function(){var e,t;return this.$el.find("#add_student_select option:selected").val()==="_none"?alert("Please select a student, or cancel."):(t=this.$el.find("#add_student_select option:selected").attr("data-id"),e=this.allStudents.get(t),e.save({klassId:this.klass.id},{success:function(){return this.students.add(e),this.addStudentToggle()}}))},n.prototype.registerStudent=function(){return this.students.create({name:this.$el.find("#register_student_name").val(),gender:this.$el.find("#register_student_gender").val(),age:this.$el.find("#register_student_age").val(),klassId:this.klass.id},{wait:!0}),this.registerStudentToggle(),this.$el.find("#register_student_form input").val()},n.prototype.basicInfoToggle=function(){var e;return this.$el.find(".basic_info").toggle(),e=$(this.$el.find(".basic_info")[1]),e.is(":visible")&&(e.scrollTo(),this.$el.find("#year").focus()),this.$el.find("#school_name").val(this.klass.getString("schoolName")),this.$el.find("#year").val(this.klass.getString("year")),this.$el.find("#grade").val(this.klass.getString("grade")),this.$el.find("#stream").val(this.klass.getString("stream"))},n.prototype.basicInfoSave=function(){var e,t,n=this;return e=this.$el.find("#start_date").val().split("/"),t=new Date,t.setFullYear(parseInt(e[0])),t.setMonth(parseInt(e[1])-1),t.setDate(parseInt(e[2])),this.klass.save({schoolName:this.$el.find("#school_name").val(),year:this.$el.find("#year").val(),grade:this.$el.find("#grade").val(),stream:this.$el.find("#stream").val(),startDate:t.getTime()},{success:function(){return n.render()},error:function(){return Utils.midAlert("Save error<br>Please try again.")}})},n.prototype.back=function(){return window.history.back()},n.prototype.initialize=function(e){return this.klass=e.klass,this.students=e.students,this.allStudents=e.allStudents,this.teachers=e.teachers,this.students.on("add remove change",this.renderStudents),this.views=[]},n.prototype.closeViews=function(){var e,t,n,r;r=this.views;for(t=0,n=r.length;t<n;t++)e=r[t],e.close();return this.views=[]},n.prototype.onSubviewRendered=function(){return this.trigger("subRendered")},n.prototype.renderStudents=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d;e=$("<ul>").addClass("student_list"),this.closeViews(),h=this.students.models;for(o=0,f=h.length;o<f;o++)r=h[o],s=new StudentListElementView({student:r,students:this.students}),this.views.push(s),s.on("rendered",this.onSubviewRendered),s.render(),s.on("change",this.renderStudents),e.append(s.el);this.$el.find("#student_list_wrapper").html(e),i="<option value='_none' disabled='disabled' selected='selected'>("+$.t("name")+") - ("+$.t("age")+")</option>",p=this.allStudents.models;for(u=0,l=p.length;u<l;u++){r=p[u],n=!1,d=this.students.models;for(a=0,c=d.length;a<c;a++)t=d[a],t.id===r.id&&(n=!0);n||(i+="<option data-id='"+r.id+"'>"+r.get("name")+" - "+r.get("age")+"</option>")}return this.$el.find("#add_student_select").html(i)},n.prototype.render=function(){var e,n,r,i,s,o,u,a,f,l;return i=this.klass.getString("schoolName"),l=this.klass.getString("year"),e=this.klass.getString("grade"),o=this.klass.getString("stream"),s=new Date(this.klass.getNumber("startDate")),(a=this.klass.get("teacherId")==="admin")?f="admin":f=this.teachers.get(this.klass.get("teacherId")).get("name"),Tangerine.user.isAdmin()&&(n="      <tr><td><label>Teacher</label></td><td>"+f+"</td></tr>    "),Tangerine.user.isAdmin()&&(r="      <label>Teacher</label><br>      <select id='teacher_select'>      "+function(){var e,t,n,r;n=this.teachers.models,r=[];for(e=0,t=n.length;e<t;e++)u=n[e],r.push("<option "+(u.id===this.klass.get("teacherId")?"selected='selected' ":"")+" data-teacherId='"+u.id+"'>"+u.get("name")+"</option>");return r}.call(this)+"      </select>    "),this.$el.html("    <button class='back navigation'>"+t("back")+"</button>    <h1>"+t("class editor")+"</h1>    <h2>"+t("basic info")+"</h2>    <table class='info_box basic_info'>      <tr><td><label>School name</label></td><td>"+i+"</td></tr>      "+(n||"")+"      <tr><td><label>School year</label></td><td>"+l+"</td></tr>      <tr><td><label>"+t("grade")+"</label></td><td>"+e+"</td></tr>      <tr><td><label>"+t("stream")+"</label></td><td>"+o+"</td></tr>      <tr><td><label>"+t("starting date")+"</label></td><td>"+(s.getFullYear()+"/"+(s.getMonth()+1)+"/"+s.getDate())+"</td></tr>      <tr><td colspan='2'><button class='basic_info_edit command'>"+t("edit")+"</button></td></tr>    </table>    <div class='basic_info confirmation'>      <div class='menu_box'>        <div class='label_value'>          <label for='school_name'>School name</label>          <input id='school_name' value='"+i+"'>        </div>        <div class='label_value'>          "+(r||"")+"        </div>        <div class='label_value'>          <label for='year'>School year</label>          <input id='year' value='"+l+"'>        </div>        <div class='label_value'>          <label for='grade'>"+t("grade")+"</label>          <input id='grade' value='"+e+"'>        </div>        <div class='label_value'>          <label for='stream'>"+t("stream")+"</label>          <input id='stream' value='"+o+"'>        </div>        <div class='label_value'>          <label for='start_date'>"+t("starting date")+"</label>          <input id='start_date' value='"+(s.getFullYear()+"/"+(s.getMonth()+1)+"/"+s.getDate())+"'>        </div>              <button class='save command'>"+t("save")+"</button> <button class='basic_info_cancel command'>"+t("cancel")+"</button>      </div>    </div>        <h2>"+t("students").capitalize()+"</h2>    <div id='student_list_wrapper'></div>    <button class='add_student command'>Add student</button>    <div class='add_student_form menu_box confirmation'>      <div class='label_value'>        <label for='add_student_select'>"+t("add student")+"</label><br>        <select id='add_student_select'>        </select>      </div>            <button class='add_student_add command'>"+t("add")+"</button><button class='add_student_cancel command'>"+t("cancel")+"</button>    </div>    <button class='register_student command'>"+$.t("register student")+"</button>    <div class='register_student_form menu_box confirmation'>      <h2>"+t("register student")+"</h2>      <div class='label_value'>        <label for='register_student_name'>Full name</label>        <input id='register_student_name' value=''>      </div>      <div class='label_value'>        <label for='register_student_gender'>"+t("gender")+"</label>        <input id='register_student_gender' value=''>      </div>      <div class='label_value'>        <label for='register_student_age'>"+t("age")+"</label>        <input id='register_student_age' value=''>      </div>      <button class='register_student_save command'>"+t("save")+"</button>      <button class='register_student_cancel command'>"+t("cancel")+"</button>    </div>    "),this.trigger("rendered"),this.renderStudents()},n}(Backbone.View);var Klasses,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Klasses=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.model=Klass,t.prototype.url="klass",t}(Backbone.Collection);var KlassesView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassesView=function(e){function n(){return this.render=__bind(this.render,this),this.onSubviewRendered=__bind(this.onSubviewRendered,this),this.updatePullResult=__bind(this.updatePullResult,this),this.updatePull=__bind(this.updatePull,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="KlassesView",n.prototype.events={"click .add":"toggleAddForm","click .cancel":"toggleAddForm","click .save":"saveNewKlass","click .goto_class":"gotoKlass","click .curricula":"gotoCurricula","click .pull_data":"pullData"},n.prototype.initialize=function(e){return this.views=[],this.klasses=e.klasses,this.curricula=e.curricula,this.teachers=e.teachers,this.klasses.on("add remove change",this.render)},n.prototype.pullData=function(){var e=this;return this.tablets={checked:0,complete:0,successful:0,okCount:0,ips:[],result:0},Utils.midAlert("Please wait, detecting tablets."),Utils.working(!0),this.randomIdDoc=hex_sha1(""+Math.random()),Tangerine.$db.saveDoc({_id:this.randomIdDoc},{success:function(t){var n,r,i;e.randomDoc=t,i=[];for(n=r=0;r<=15;n=++r)i.push(function(t){var n,r;return n=Tangerine.settings.subnetIP(t),r=$.ajax({url:Tangerine.settings.urlSubnet(n),dataType:"jsonp",contentType:"application/json;charset=utf-8",timeout:1e4}),r.complete(function(t,r){return e.tablets.checked++,parseInt(t.status)===200&&(e.tablets.okCount++,e.tablets.ips.push(n)),e.updatePull()})}(n));return i},error:function(){return Utils.working(!1),Utils.midAlert("Internal database error")}})},n.prototype.updatePull=function(){var e,t,n,r,i,s=this;if(this.tablets.checked<16)return;if(this.tablets.okCount>1){this.tablets.okCount--,Utils.midAlert("Pulling from "+this.tablets.okCount+" tablets."),r=this.tablets.ips,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(function(e){var t;return t=$.ajax({url:Tangerine.settings.urlSubnet(e)+"/"+s.randomIdDoc,dataType:"jsonp",timeout:1e4,contentType:"application/json;charset=utf-8"}),t.success(function(e,t,n){}),t.complete(function(t,n){return function(t){var n;if(parseInt(t.status)===200)return;return n=$.ajax({url:Tangerine.settings.urlSubnet(e)+"/_design/tangerine/_view/byCollection",dataType:"jsonp",contentType:"application/json;charset=utf-8",data:{include_docs:!1,keys:JSON.stringify(["result","klass","student","curriculum","teacher"])}}),n.success(function(t){var n,r;return r=function(){var e,r,i,s;i=t.rows,s=[];for(e=0,r=i.length;e<r;e++)n=i[e],s.push(n.id);return s}(),$.couch.replicate(Tangerine.settings.urlSubnet(e),Tangerine.settings.urlDB("local"),{success:function(){return s.tablets.complete++,s.tablets.successful++,s.updatePullResult()},error:function(e,t){return s.tablets.complete++,s.updatePullResult()}},{doc_ids:r})})}(t)})}(e));return i}return Utils.working(!1),Utils.midAlert("Cannot detect tablets"),Tangerine.$db.removeDoc({_id:this.randomDoc.id,_rev:this.randomDoc.rev})},n.prototype.updatePullResult=function(){var e=this;if(this.tablets.complete===this.tablets.okCount)return Utils.working(!1),Utils.midAlert("Pull finished.<br>"+this.tablets.successful+" out of "+this.tablets.okCount+" successful.",5e3),Tangerine.$db.removeDoc({_id:this.randomDoc.id,_rev:this.randomDoc.rev}),this.klasses.fetch({success:function(){return e.renderKlasses()}})},n.prototype.gotoCurricula=function(){return Tangerine.router.navigate("curricula",!0)},n.prototype.saveNewKlass=function(){var e,t;return e=[],$.trim(this.$el.find("#school_name").val())===""&&e.push(" - No school name."),$.trim(this.$el.find("#year").val())===""&&e.push(" - No year."),$.trim(this.$el.find("#grade").val())===""&&e.push(" - No grade."),$.trim(this.$el.find("#stream").val())===""&&e.push(" - No stream."),this.$el.find("#curriculum option:selected").val()==="_none"&&e.push(" - No curriculum selected."),e.length===0?(t=Tangerine.user.has("teacherId")?Tangerine.user.get("teacherId"):"admin",this.klasses.create({teacherId:t,schoolName:this.$el.find("#school_name").val(),year:this.$el.find("#year").val(),grade:this.$el.find("#grade").val(),stream:this.$el.find("#stream").val(),curriculumId:this.$el.find("#curriculum option:selected").attr("data-id"),startDate:(new Date).getTime()})):alert("Please correct the following errors:\n\n"+e.join("\n"))},n.prototype.gotoKlass=function(e){return Tangerine.router.navigate("class/edit/"+$(e.target).attr("data-id"))},n.prototype.toggleAddForm=function(){var e;this.$el.find("#add_form, .add").toggle(),Tangerine.user.isAdmin()?this.$el.find("#school_name").focus():(e=this.teachers.get(Tangerine.user.get("teacherId")).get("school"),this.$el.find("#school_name").val(e),this.$el.find("#year").focus());if(this.$el.find("#add_form").is(":visible"))return this.$el.find("#add_form").scrollTo()},n.prototype.renderKlasses=function(){var e,t,n,r,i,s;this.closeViews(),e=$("<ul>").addClass("klass_list"),s=this.klasses.models;for(r=0,i=s.length;r<i;r++)t=s[r],n=new KlassListElementView({klass:t,curricula:this.curricula}),n.on("rendered",this.onSubviewRendered),n.render(),this.views.push(n),e.append(n.el);return this.$el.find("#klass_list_wrapper").empty(),this.$el.find("#klass_list_wrapper").append(e)},n.prototype.onSubviewRendered=function(){return this.trigger("subRendered")},n.prototype.render=function(){var e,n,r,i,s,o;r="<option value='_none' disabled='disabled' selected='selected'>"+t("select a curriculum")+"</option>",o=this.curricula.models;for(i=0,s=o.length;i<s;i++)n=o[i],r+="<option data-id='"+n.id+"'>"+n.get("name")+"</option>";return Tangerine.user.isAdmin()&&(e="      <h1>Admin menu</h1>      <button class='pull_data command'>Pull data</button>    "),this.$el.html("      "+(e||"")+"      <h1>"+t("classes")+"</h1>      <div id='klass_list_wrapper'></div>      <button class='add command'>"+t("add")+"</button>      <div id='add_form' class='confirmation'>        <div class='menu_box'>           <div class='label_value'>            <label for='school_name'>School name</label>            <input id='school_name'>          </div>          <div class='label_value'>            <label for='year'>School year</label>            <input id='year'>          </div>          <div class='label_value'>            <label for='grade'>"+t("grade")+"</label>            <input id='grade'>          </div>          <div class='label_value'>            <label for='stream'>"+t("stream")+"</label>            <input id='stream'>          </div>          <div class='label_value'>            <label for='curriculum'>"+t("curriculum")+"</label><br>            <select id='curriculum'>"+r+"</select>          </div>          <button class='command save'>"+t("save")+"</button><button class='command cancel'>"+t("cancel")+"</button>        </div>      </div>      <button class='command curricula'>"+t("all curricula")+"</button>    "),this.renderKlasses(),this.trigger("rendered")},n.prototype.closeViews=
function(){var e,t,n,r;r=this.views!=null;for(t=0,n=r.length;t<n;t++)e=r[t],e.close();return this.views=[]},n.prototype.onClose=function(){return this.closeViews()},n}(Backbone.View);var KlassListElementView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassListElementView=function(e){function n(){return this.render=__bind(this.render,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="KlassListElementView",n.prototype.tagName="li",n.prototype.events={"click .run":"run","click .results":"showReportSelect","change #report":"getReportMenu","click .cancel_report":"cancelReport","click .edit":"edit","click .delete":"toggleDelete","click .delete_cancel":"toggleDelete","click .delete_delete":"delete"},n.prototype.initialize=function(e){return this.availableReports=Tangerine.config.get("reports"),e.klass.has("curriculumId")?(this.curriculum=new Curriculum({_id:e.klass.get("curriculumId")}),this.curriculum.fetch({success:this.render})):this.curriculum=new Curriculum},n.prototype.edit=function(){return Tangerine.router.navigate("class/edit/"+this.options.klass.id,!0)},n.prototype.getReportMenu=function(e){var t;return(t=this.subMenuView)!=null&&t.close(),this.subMenuView=new(window[$(e.target).find(":selected").attr("data-menu_view")])({parent:this}),this.$el.find("#report_menu_container").append("<div class='report_menu'></div>"),this.subMenuView.setElement(this.$el.find("#report_menu_container .report_menu")),this.subMenuView.render()},n.prototype.showReportSelect=function(){return this.$el.find(".report_select_container").removeClass("confirmation")},n.prototype.cancelReport=function(){var e;return this.$el.find("div#report_menu").empty(),this.$el.find("#report :nth-child(1)").attr("selected","selected"),this.$el.find(".report_select_container").addClass("confirmation"),(e=this.subMenuView)!=null?e.close():void 0},n.prototype.onClose=function(){var e;return(e=this.subMenuView)!=null?e.close():void 0},n.prototype.run=function(){return Tangerine.router.navigate("class/"+this.options.klass.id,!0)},n.prototype.toggleDelete=function(){return this.$el.find(".delete_confirm").toggle()},n.prototype["delete"]=function(){return this.options.klass.collection.get(this.options.klass).destroy()},n.prototype.render=function(){var e,n,r,i,s;return n=this.options.klass,n.get("teacherId")==="admin"?s="admin":(i=vm.currentView.teachers.get(n.get("teacherId")),s=(i!=null?i.getEscapedString("name"):void 0)||""),Tangerine.user.isAdmin()&&(e="      <tr><td><small>Teacher</small></td><td>"+s+"</td></tr>    "),this.$el.html("      <table>        "+(e||"")+"        <tr><td><small>School name</small></td><td>"+n.getEscapedString("schoolName")+"</td></tr>        <tr><td><small>School year</small></td><td>"+n.getString("year")+"</td></tr>        <tr><td><small>"+t("grade")+"</small></td><td>"+n.getString("grade")+"</td></tr>        <tr><td><small>"+t("stream")+"</small></td><td>"+n.getString("stream")+"</td></tr>        <tr><td><small>"+t("curriculum")+"</small></td><td>"+this.curriculum.getEscapedString("name")+"</td></tr>      </table>      <img src='images/icon_run.png'     class='icon run'>       <img src='images/icon_results.png' class='icon results'>       <img src='images/icon_edit.png'    class='icon edit'>       <img src='images/icon_delete.png'  class='icon delete'>       <div class='report_select_container confirmation'>        <div class='menu_box'>          <select id='report'>            <option selected='selected' disabled='disabled'>"+t("select report type")+"</option>            "+function(){var e,n,i,s;i=this.availableReports,s=[];for(e=0,n=i.length;e<n;e++)r=i[e],s.push("<option data-menu_view='"+r.menuView+"'>"+t(r.name)+"</option>");return s}.call(this).join("")+"          </select>        </div>        <div id='report_menu_container'></div>        <button class='command cancel_report'>"+t("cancel")+"</button>      </div>      <div class='delete_confirm confirmation'>        <div class='menu_box'>          "+t("confirm")+"<br>          <button class='delete_delete command_red'>"+t("delete")+"</button>          <button class='delete_cancel command'>"+t("cancel")+"</button>        </div>      </div>    "),this.trigger("rendered")},n}(Backbone.View);var KlassSubtestRunView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassSubtestRunView=function(e){function t(){return this.onPrototypeRendered=__bind(this.onPrototypeRendered,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="KlassSubtestRunView",t.prototype.events={"click .done":"done","click .cancel":"cancel","click .subtest_help":"toggleHelp"},t.prototype.toggleHelp=function(){return this.$el.find(".enumerator_help").fadeToggle(250)},t.prototype.initialize=function(e){this.linkedResult=e.linkedResult,this.student=e.student,this.subtest=e.subtest,this.questions=e.questions,this.prototype=this.subtest.get("prototype"),this.protoViews=Tangerine.config.get("prototypeViews"),this.prototypeRendered=!1;if(this.prototype==="grid")return this.result=new KlassResult({prototype:"grid",startTime:(new Date).getTime(),itemType:this.subtest.get("itemType"),reportType:this.subtest.get("reportType"),studentId:this.student.id,subtestId:this.subtest.id,part:this.subtest.get("part"),klassId:this.student.get("klassId"),timeAllowed:this.subtest.get("timer")});if(this.prototype==="survey")return this.result=new KlassResult({prototype:"survey",startTime:(new Date).getTime(),studentId:this.student.id,subtestId:this.subtest.id,part:this.subtest.get("part"),klassId:this.student.get("klassId"),itemType:this.subtest.get("itemType"),reportType:this.subtest.get("reportType")}),this.questions.sort(),this.render()},t.prototype.render=function(){var e,t;return e=(this.subtest.get("enumeratorHelp")||"")!==""?"<button class='subtest_help command'>help</button><div class='enumerator_help'>"+this.options.subtest.get("enumeratorHelp")+"</div>":"",t=(this.subtest.get("studentDialog")||"")!==""?"<div class='student_dialog'>"+this.options.subtest.get("studentDialog")+"</div>":"",this.$el.html("      <h2>"+this.options.subtest.get("name")+"</h2>      "+e+"      "+t+"    "),this.prototypeView=new(window[this.protoViews[this.subtest.get("prototype")].run])({model:this.subtest,parent:this}),this.prototypeView.on("rendered",this.onPrototypeRendered),this.prototypeView.render(),this.$el.append(this.prototypeView.el),this.prototypeRendered=!0,this.$el.append("<button class='done navigation'>Done</button> <button class='cancel navigation'>Cancel</button>"),this.trigger("rendered")},t.prototype.onPrototypeRendered=function(){return this.trigger("rendered")},t.prototype.getGridScore=function(){var e;return this.linkedResult.get("subtestData")==null?!1:(e=this.linkedResult.get("subtestData").attempted||0,e)},t.prototype.gridWasAutostopped=function(){var e;return((e=this.linkedResult.get("subtestData"))!=null?e.auto_stop:void 0)||0},t.prototype.onClose=function(){var e;return(e=this.prototypeView)!=null?typeof e.close=="function"?e.close():void 0:void 0},t.prototype.isValid=function(){return this.prototypeRendered?this.prototypeView.isValid!=null?this.prototypeView.isValid():!1:!1},t.prototype.getSkipped=function(){if(this.prototypeView.getSkipped!=null)return this.prototypeView.getSkipped();throw"Prototype skipping not implemented"},t.prototype.cancel=function(){return Tangerine.router.navigate("class/"+this.options.student.get("klassId")+"/"+this.options.subtest.get("part"),!0)},t.prototype.done=function(){var e=this;return this.isValid()?Tangerine.$db.view("tangerine/resultsByStudentSubtest",{key:[this.options.student.id,this.subtest.id],success:function(t){var n,r,i,s;r=t.rows;for(i=0,s=r.length;i<s;i++)n=r[i],Tangerine.$db.saveDoc($.extend(n.value,{old:!0}));return e.result.add(e.prototypeView.getResult(),function(){return Tangerine.router.navigate("class/"+e.options.student.get("klassId")+"/"+e.options.subtest.get("part"),!0)})}}):this.prototypeView.showErrors()},t}(Backbone.View);var KlassSubtestResultView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassSubtestResultView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="KlassSubtestResultView",n.prototype.events={"click .run":"gotoRun","click .back":"back","click .show_itemized":"showItemized"},n.prototype.initialize=function(e){return this.results=e.results,this.result=this.results[0],this.previous=e.previous,this.subtest=e.subtest,this.student=e.student},n.prototype.showItemized=function(){return this.$el.find(".itemized").fadeToggle()},n.prototype.gotoRun=function(){return Tangerine.router.navigate("class/run/"+this.options.student.id+"/"+this.options.subtest.id,!0)},n.prototype.back=function(){return Tangerine.router.navigate("class/"+this.options.student.get("klassId")+"/"+this.options.subtest.get("part"),!0)},n.prototype.render=function(){var e,n,r,i,s,o,u,a,f,l,c,h,p;if(this.result!=null){this.results=this.results[0],i="<button class='command show_itemized'>"+t("itemized results")+"</button><table class='itemized confirmation'><tbody><tr><th>Item</th><th>Result</th></tr>";if(this.subtest.get("prototype")==="grid"){h=this.result.get("subtestData").items;for(n=l=0,c=h.length;l<c;n=++l)e=h[n],i+="<tr><td>"+e.itemLabel+"</td><td>"+t(e.itemResult)+"</td></tr>"}else if(this.subtest.get("prototype")==="survey"){p=this.result.get("subtestData");for(r in p)a=p[r],i+="<tr><td>"+r+"</td><td>"+t(a)+"</td></tr>"}i+="</tbody></table><br>",u=new Date(this.result.get("startTime")),this.previous>0&&(o="        <tr>          <td><label>Taken last</label></td><td>"+u.getFullYear()+"/"+(u.getMonth()+1)+"/"+u.getDate()+"</td>        </tr>        <tr>          <td><label>Previous attempts</label></td><td>"+this.previous+"</td>        </tr>      ")}if(this.result==null||(typeof (f=this.result).get=="function"?f.get("reportType"):void 0)!=="progress")s="      <div class='menu_box'>        <img src='images/icon_run.png' class='run'>      </div><br>    ";return this.$el.html("      <h1>Result</h1>      <table><tbody>        <tr>          <td><label>Assessment</label></td>          <td>"+this.subtest.get("part")+"</td>        </tr>        <tr>          <td><label>Student</label></td>          <td>"+this.student.escape("name")+"</td>        </tr>        <tr>          <td><label>Subtest</label></td>          <td>"+this.subtest.escape("name")+"</td>        </tr>        "+o+"      </tbody></table>      "+(i||"")+"      "+(s||"")+"      <button class='navigation back'>Back</button>    "),this.trigger("rendered")},n}(Backbone.View);var KlassMenuView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassMenuView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="KlassMenuView",t.prototype.events={"click .registration":"gotoKlasses"},t.prototype.gotoKlasses=function(){return Tangerine.router.navigate("class",!0)},t.prototype.initialize=function(e){},t.prototype.render=function(){return this.$el.html("    <h1>Tangerine Class</h1>    <button class='collect command'>Collect</button>    <button class='manage command'>Manage</button>    <button class='reports command'>Reports</button>    <button class='advice command'>Advice</button>    <button class='registration command'>Class Registration</button>        "),this.trigger("rendered")},t}(Backbone.View);var KlassPartlyView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassPartlyView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="KlassPartlyView",n.prototype.events={"click .next_part":"nextPart","click .prev_part":"prevPart","click .back":"back","click .student_subtest":"gotoStudentSubtest","keyup #current_part":"gotoAssessment","keyup #search_student_name":"filterStudents"},n.prototype.filterStudents=function(){var e;return e=this.$el.find("#search_student_name").val(),this.search=e,this.updateGridPage()},n.prototype.gotoAssessment=function(){var e;e=this.$el.find("#current_part").val();if(e==="")return;return this.currentPart=parseInt(e),this.updateGridPage()},n.prototype.update=function(){return this.render(),Tangerine.router.navigate("class/"+this.options.klass.id+"/"+this.currentPart)},n.prototype.back=function(){return Tangerine.router.navigate("class",!0)},n.prototype.gotoStudentSubtest=function(e){var t,n;return t=$(e.target).attr("data-studentId"),n=$(e.target).attr("data-subtestId"),Tangerine.router.navigate("class/result/student/subtest/"+t+"/"+n,!0)},n.prototype.nextPart=function(){if(this.currentPart<this.lastPart)return this.currentPart++,this.update()},n.prototype.prevPart=function(){if(this.currentPart>1)return this.currentPart--,this.update()},n.prototype.initialize=function(e){return this.search="",this.currentPart=e.part||1,this.subtestsByPart=[],this.subtestsByPart=e.subtests.indexBy("part"),this.lastPart=Math.max.apply(this,_.compact(e.subtests.pluck("part")))||1},n.prototype.updateGridPage=function(){return this.$el.find("#grid_container").html(this.getGridPage())},n.prototype.getGridPage=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T;c=[],l=this.subtestsByPart[this.currentPart];if(l==null)return"No subtests for this assessment.";T=this.options.students.models;for(r=d=0,y=T.length;d<y;r=++d){u=T[r],c[r]=[],s=new KlassResults(this.options.results.where({studentId:u.id}));for(i=v=0,b=l.length;v<b;i=++v)f=l[i],a=s.where({subtestId:f.id}),h=a.length!==0,(~u.get("name").toLowerCase().indexOf(this.search.toLowerCase())||this.search==="")&&c[r].push({content:h?"&#x2714;":"?",taken:h,studentId:u.id,studentName:u.get("name"),subtestId:f.id})}n="<table class='info_box_wide'><tbody><tr><th></th>";for(m=0,w=l.length;m<w;m++)f=l[m],n+="<th><div class='part_subtest_report' data-id='"+f.id+"'>"+f.get("name")+"</div></th>";n+="</tr>";for(g=0,E=c.length;g<E;g++){o=c[g];if(o!=null&&o.length){n+="<tr><td><div class='student' data-studentId='"+o[0].studentId+"'>"+o[0].studentName+"</div></td>";for(t=x=0,S=o.length;x<S;t=++x)e=o[t],p=e.taken?" subtest_taken":"",n+="<td><div class='student_subtest command "+p+"' data-taken='"+e.taken+"' data-studentId='"+e.studentId+"' data-subtestId='"+e.subtestId+"'>"+e.content+"</div></td>";n+="</tr>"}}return n+="</tbody></table>",n},n.prototype.render=function(){var e;return e=this.getGridPage(),this.$el.html("      <h1>"+t("assessment status")+"</h1>      <input id='search_student_name' placeholder='"+t("search student name")+"' type='text'>      <div id='grid_container'>"+e+"</div><br>      <h2>"+t("current assessment")+" </h2>            <button class='prev_part command'>&lt;</button> <input type='number' value='"+this.currentPart+"' id='current_part'> <button class='next_part command'>&gt;</button><br><br>      <button class='back navigation'>"+t("back")+"</button>       "),this.trigger("rendered")},n}(Backbone.View);var KlassResult,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassResult=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="result",t.prototype.add=function(e,t){var n=this;return this.save({subtestData:e},{success:function(){return t()}})},t.prototype.get=function(e){if(e==="correct")return this.gridCount(["correct",1]);if(e==="incorrect")return this.gridCount(["incorrect",0]);if(e==="missing")return this.gridCount(["missing",9]);if(e==="total"){if(this.attributes.prototype==="grid")return this.attributes.subtestData.items.length;if(this.attributes.prototype==="survey")return _.keys(this.attributes.subtestData).length}return e==="attempted"?this.getAttempted():e==="time_remain"?this.getTimeRemain():t.__super__.get.call(this,e)},t.prototype.gridCount=function(e){var t,n,r,i,s,o,u,a,f,l,c,h;t=0;if(this.attributes.prototype==="grid")if(_.isArray(e)){f=this.get("subtestData").items;for(s=0,u=f.length;s<u;s++)n=f[s],~e.indexOf(n.itemResult)&&t++}else{l=this.get("subtestData").items;for(o=0,a=l.length;o<a;o++)n=l[o],n.itemResult===e&&t++}else if(this.attributes.prototype==="survey")if(_.isArray(e)){c=this.attributes.subtestData;for(r in c)i=c[r],(~e.indexOf(i)||~e.indexOf(parseInt(i)))&&t++}else{h=this.attributes.subtestData;for(r in h)i=h[r],(e===i||e===parseInt(i))&&t++}return t},t.prototype.getAttempted=function(){return parseInt(this.get("subtestData").attempted)},t.prototype.getTimeRemain=function(){return parseInt(this.get("subtestData").time_remain)},t.prototype.getCorrectPerSeconds=function(e){return Math.round(this.get("correct")/(e-this.getTimeRemain())*e)},t}(Backbone.Model);var KlassResults,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassResults=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="result",t.prototype.model=KlassResult,t.prototype.initialize=function(e){var t=this;e==null&&(e={});if(e.showOld==null||e.showOld!==!0)return this.on("all",function(e){var n,r,i,s,o,u,a,f,l;i=[],f=t.models;for(s=0,u=f.length;s<u;s++)n=f[s],n.has("old")&&i.push(n.id);l=[];for(o=0,a=i.length;o<a;o++)r=i[o],l.push(t.remove(r,{silent:!0}));return l})},t}(Backbone.Collection);var RegisterTeacherView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};RegisterTeacherView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="RegisterTeacherView",t.prototype.events={"click .register":"register","click .cancel":"cancel"},t.prototype.initialize=function(e){return this.name=e.name,this.pass=e.pass,this.fields=["first","last","gender","school","contact"]},t.prototype.cancel=function(){return Tangerine.router.login()},t.prototype.register=function(){var e=this;return this.validate(function(){return e.saveUser()})},t.prototype.validate=function(e){var t,n,r,i,s;n=!1,s=this.fields;for(r=0,i=s.length;r<i;r++)t=s[r],_.isEmpty(this[t].val())?(this.$el.find("#"+t+"_message").html("Please fill out this field."),n=!0):this.$el.find("#"+t+"_message").html("");return n?Utils.midAlert("Please correct the errors on this page."):e()},t.prototype.saveUser=function(){var e,t,n,r,i,s,o,u=this;r={name:this.name},o=this.fields;for(i=0,s=o.length;i<s;i++)t=o[i],r[t]=this[t].val();return e={name:this.name},n=new Teacher(r),n.save({_id:Utils.humanGUID()},{success:function(){return $.couch.userDb(function(e){return e.openDoc("org.couchdb.user:"+u.name,{success:function(t){var r;return r=$.extend(t,{teacherId:n.id}),e.saveDoc(t,{success:function(){return Utils.midAlert("New teacher registered"),Tangerine.user.login(u.name,u.pass)},error:function(e){return Utils.midAlert("Registration error<br>"+e,5e3)}})}})})}})},t.prototype.render=function(){var e,t,n,r,i;this.$el.html("      <h1>Register new teacher</h1>      <table>        <tr>          <td class='small_grey'><b>Username</b></td>          <td class='small_grey'>"+this.name+"</td>          <td class='small_grey'><b>Password</b></td>          <td class='small_grey'>"+function(){var e,n,r,i;r=this.pass,i=[];for(e=0,n=r.length;e<n;e++)t=r[e],i.push("*");return i}.call(this).join("")+"</td>        </tr>      </table>      <div class='label_value'>        <label for='first'>First name</label>        <div id='first_message' class='messages'></div>        <input id='first'>      </div>      <div class='label_value'>        <label for='last'>Last Name</label>        <div id='last_message' class='messages'></div>        <input id='last'>      </div>      <div class='label_value'>        <label for='gender'>Gender</label>        <div id='gender_message' class='messages'></div>        <input id='gender'>      </div>      <div class='label_value'>        <label for='school'>School name</label>        <div id='school_message' class='messages'></div>        <input id='school'>      </div>      <div class='label_value'>        <label for='contact'>Email address or mobile phone number</label>        <div type='email' id='contact_message' class='messages'></div>        <input id='contact'>      </div>      <button class='register command'>Register</button> <button class='cancel command'>Cancel</button>    "),i=this.fields;for(n=0,r=i.length;n<r;n++)e=i[n],this[e]=this.$el.find("#"+e);return this.trigger("rendered")},t}(Backbone.View);var KlassSubtestEditView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassSubtestEditView=function(e){function t(){return this.toggleAddQuestion=__bind(this.toggleAddQuestion,this),this.renderQuestions=__bind(this.renderQuestions,this),this.goBack=__bind(this.goBack,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="subtest_edit",t.prototype.events={"click .back_button":"goBack","click .save_subtest":"save","blur #subtest_items":"cleanWhitespace","click .add_question":"toggleAddQuestion","click .add_question_cancel":"toggleAddQuestion","click .add_question_add":"addQuestion","keypress #question_name":"addQuestion"},t.prototype.cleanWhitespace=function(){return this.$el.find("#subtest_items").val(this.$el.find("#subtest_items").val().replace(/\s+/g," "))},t.prototype.initialize=function(e){var t=this;this.model=e.model,this.curriculum=e.curriculum,this.prototype=this.model.get("prototype"),this.prototypeViews=Tangerine.config.get("prototypeViews");if(this.prototype==="survey")return this.questions=e.questions,this.surveyEditor=new window[this.prototypeViews[this.prototype].edit]({model:this.model,parent:this}),this.questions.maintainOrder(),this.questionsEditView=new QuestionsEditView({questions:this.questions}),this.questionsEditView.on("question-edit",function(e){return t.save(null,{questionSave:!1,success:function(){return Tangerine.router.navigate("class/question/"+e,!0)}})}),this.questions.on("change",function(){return t.renderQuestions()}),this.renderQuestions()},t.prototype.goBack=function(){return Tangerine.router.navigate("curriculum/"+this.model.get("curriculumId"),!0)},t.prototype.save=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v=this;t==null&&(t={});if(this.prototype==="grid")return this.model.save({name:this.$el.find("#name").val(),part:Math.max(parseInt(this.$el.find("#part").val()),1),reportType:this.$el.find("#report_type").val().toLowerCase(),itemType:this.$el.find("#item_type").val().toLowerCase(),scoreTarget:parseInt(this.$el.find("#score_target").val()),scoreSpread:parseInt(this.$el.find("#score_spread").val()),order:parseInt(this.$el.find("#order").val()),captureLastAttempted:this.$el.find("#capture_last_attempted input:checked").val()==="true",endOfLine:this.$el.find("#end_of_line input:checked").val()==="true",randomize:this.$el.find("#randomize input:checked").val()==="true",timer:Math.max(parseInt(this.$el.find("#subtest_timer").val()),0),items:_.compact(this.$el.find("#subtest_items").val().split(" ")),columns:Math.max(parseInt(this.$el.find("#subtest_columns").val()),0)},{success:function(){return Utils.midAlert("Subtest Saved")},error:function(){return Utils.midAlert("Save error")}});if(this.prototype==="survey"){t.questionSave=t.questionSave?t.questionSave:!0,i=[],n=[],u=[],h=this.questions.models;for(r=f=0,l=h.length;f<l;r=++f)o=h[r],o.get("type")!=="open"&&((p=o.get("options"))!=null?p.length:void 0)===0&&(n.push(r+1),t.questionSave&&(o.save()||i.push(r),o.has("linkedGridScore")&&o.get("linkedGridScore")!==""&&o.get("linkedGridScore")!==0&&this.model.has("gridLinkId")===""&&this.model.get("gridLinkId")===""&&u.push(r)));return i.length!==0&&Utils.midAlert("Error<br><br>Questions: <br>"+i.join(", ")+"<br>not saved"),n.length!==0&&(s=n.length>1,c=s?"Questions":"Question",a=s?"have":"has",alert("Warning\n\n"+c+" "+n.join(" ,")+" "+a+" no options.")),u.length!==0&&(s=n.length>1,c=s?"Questions":"Question",d=s?"require":"requires",alert("Warning\n\n"+c+" "+u.join(" ,")+" "+d+" a grid to be linked to this test.")),this.model.save({name:this.$el.find("#name").val(),part:Math.max(parseInt(this.$el.find("#part").val()),1),reportType:this.$el.find("#report_type").val().toLowerCase(),itemType:this.$el.find("#item_type").val().toLowerCase(),scoreTarget:parseInt(this.$el.find("#score_target").val()),scoreSpread:parseInt(this.$el.find("#score_spread").val()),order:Math.max(parseInt(this.$el.find("#order").val()),0),gridLinkId:this.$el.find("#link_select option:selected").val(),autostopLimit:parseInt(this.$el.find("#autostop_limit").val())||0},{success:function(){return t.success?t.success():(Utils.midAlert("Subtest Saved"),setTimeout(v.goBack,1e3))},error:function(){return t.error!=null?t.error():Utils.midAlert("Save error")}})}},t.prototype.renderQuestions=function(){var e,t;return this.$el.find("#question_list_wrapper").empty(),(e=this.questionsEditView)!=null&&e.render(),this.$el.find("#question_list_wrapper").append((t=this.questionsEditView)!=null?t.el:void 0)},t.prototype.toggleAddQuestion=function(){var e=this;return this.$el.find("#add_question_form, .add_question").fadeToggle(250,function(){if(e.$el.find("#add_question_form").is(":visible"))return e.$el.find("#question_prompt").focus()}),!1},t.prototype.addQuestion=function(e){var t,n;return e.type!=="click"&&e.which!==13?!0:(t=$.extend(Tangerine.templates.get("questionTemplate"),{subtestId:this.model.id,curriculumId:this.curriculum.id,id:Utils.guid(),order:this.questions.length,prompt:this.$el.find("#question_prompt").val(),name:this.$el.find("#question_name").val().safetyDance()}),n=this.questions.create(t),this.$el.find("#add_question_form input").val(""),this.$el.find("#question_prompt").focus(),!1)},t.prototype.render=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g=this;return r=this.curriculum.escape("name"),a=this.model.escape("name"),l=this.model.getNumber("part"),p=this.model.escape("reportType"),o=this.model.escape("itemType"),v=this.model.getNumber("scoreTarget"),d=this.model.getNumber("scoreSpread"),f=this.model.getNumber("order"),this.prototype==="grid"?(i=this.model.has("endOfLine")?this.model.get("endOfLine"):!0,h=this.model.has("randomize")?this.model.get("randomize"):!1,t=this.model.has("captureLastAttempted")?this.model.get("captureLastAttempted"):!1,u=this.model.get("items").join(" "),m=this.model.get("timer")||0,n=this.model.get("columns")||0,c="        <div class='label_value'>          <label for='subtest_items' title='These items are space delimited. Pasting text from other applications may insert tabs and new lines. Whitespace will be automatically corrected.'>Grid Items</label>          <textarea id='subtest_items'>"+u+"</textarea>        </div>        <label>Randomize items</label><br>        <div class='menu_box'>          <div id='randomize' class='buttonset'>            <label for='randomize_true'>Yes</label><input name='randomize' type='radio' value='true' id='randomize_true' "+(h?"checked":void 0)+">            <label for='randomize_false'>No</label><input name='randomize' type='radio' value='false' id='randomize_false' "+(h?void 0:"checked")+">          </div>        </div><br>        <label>Mark entire line button</label><br>        <div class='menu_box'>          <div id='end_of_line' class='buttonset'>            <label for='end_of_line_true'>Yes</label><input name='end_of_line' type='radio' value='true' id='end_of_line_true' "+(i?"checked":void 0)+">            <label for='end_of_line_false'>No</label><input name='end_of_line' type='radio' value='false' id='end_of_line_false' "+(i?void 0:"checked")+">          </div>        </div><br>        <label>Capture last item attempted</label><br>        <div class='menu_box'>          <div id='capture_last_attempted' class='buttonset'>            <label for='capture_last_attempted_true'>Yes</label><input name='capture_last_attempted' type='radio' value='true' id='capture_last_attempted_true' "+(t?"checked":void 0)+">            <label for='capture_last_attempted_false'>No</label><input name='capture_last_attempted' type='radio' value='false' id='capture_last_attempted_false' "+(t?void 0:"checked")+">          </div>        </div><br>        <div class='label_value'>          <label for='subtest_columns' title='Number of columns in which to display the grid items.'>Columns</label><br>          <input id='subtest_columns' value='"+n+"' type='number'>        </div>        <div class='label_value'>          <label for='subtest_timer' title='Seconds to give the child to complete the test. Setting this value to 0 will make the test untimed.'>Timer</label><br>          <input id='subtest_timer' value='"+m+"' type='number'>        </div>      "):this.prototype==="survey"&&(s=this.model.get("gridLinkId")||"",e=parseInt(this.model.get("autostopLimit"))||0,this.on("rendered",function(){var e;return g.renderQuestions(),e=new Subtests,e.fetch({key:g.curriculum.id,success:function(e){var t,n,r,i,o;e=new Subtests(e.where({prototype:"grid"})),e.sort(),t="              <div class='label_value'>                <label for='link_select'>Linked to grid</label><br>                <div class='menu_box'>                  <select id='link_select'>                  <option value=''>None</option>",o=e.models;for(r=0,i=o.length;r<i;r++)n=o[r],t+="<option value='"+n.id+"' "+(s===n.id?"selected":"")+">"+n.get("part")+" "+n.get("name")+"</option>";return t+="</select></div></div>",g.$el.find("#grid_link").html(t)}})}),c="        <div class='label_value'>          <label for='autostop_limit' title='The survey will discontinue after the first N questions have been answered with a &quot;0&quot; value option.'>Autostop after N incorrect</label><br>          <input id='autostop_limit' type='number' value='"+e+"'>        </div>        <div id='grid_link'></div>        <div id='questions'>          <h2>Questions</h2>          <div class='menu_box'>            <div id='question_list_wrapper'><img class='loading' src='images/loading.gif'></div>            <button class='add_question command'>Add Question</button>            <div id='add_question_form' class='confirmation'>              <div class='menu_box'>                <h2>New Question</h2>                <label for='question_prompt'>Prompt</label>                <input id='question_prompt'>                <label for='question_name'>Variable name</label>                <input id='question_name' title='Allowed characters: A-Z, a-z, 0-9, and underscores.'><br>                <button class='add_question_add command'>Add</button><button class='add_question_cancel command'>Cancel</button>              </div>            </div>           </div>        </div>      "),this.$el.html("      <button class='back_button navigation'>Back</button><br>      <h1>Subtest Editor</h1>      <table class='basic_info'>        <tr>          <th>Curriculum</th>          <td>"+r+"</td>        </tr>      </table>      <button class='save_subtest command'>Done</button>      <div class='label_value'>        <label for='name'>Name</label>        <input id='name' value='"+a+"'>      </div>      <div class='label_value'>        <label for='report_type'>Report Type</label>        <input id='report_type' value='"+p+"'>      </div>      <div class='label_value'>        <label for='item_type' title='This variable is used for reports. All results from subtests with the same Item Type will show up together. Inconsistent naming will invalidate results.  '>Item Type</label>        <input id='item_type' value='"+
o+"'>      </div>      <div class='label_value'>        <label for='part'>Assessment Number</label><br>        <input type='number' id='part' value='"+l+"'>      </div>      <div class='label_value'>        <label for='score_target'>Target score</label><br>        <input type='number' id='score_target' value='"+v+"'>      </div>      <div class='label_value'>        <label for='score_spread'>Score spread</label><br>        <input type='number' id='score_spread' value='"+d+"'>      </div>      <div class='label_value'>        <label for='order'>Order</label><br>        <input type='number' id='order' value='"+f+"'>      </div>      "+c+"      <button class='save_subtest command'>Done</button>      "),this.trigger("rendered")},t}(Backbone.View);var KlassGroupingView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassGroupingView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="KlassGroupingView",n.prototype.normalCurve=[0,.00399,.00798,.01197,.01595,.01994,.02392,.0279,.03188,.03586,.03983,.0438,.04776,.05172,.05567,.05962,.06356,.06749,.07142,.07535,.07926,.08317,.08706,.09095,.09483,.09871,.10257,.10642,.11026,.11409,.11791,.12172,.12552,.1293,.13307,.13683,.14058,.14431,.14803,.15173,.15542,.1591,.16276,.1664,.17003,.17364,.17724,.18082,.18439,.18793,.19146,.19497,.19847,.20194,.2054,.20884,.21226,.21566,.21904,.2224,.22575,.22907,.23237,.23565,.23891,.24215,.24537,.24857,.25175,.2549,.25804,.26115,.26424,.2673,.27035,.27337,.27637,.27935,.2823,.28524,.28814,.29103,.29389,.29673,.29955,.30234,.30511,.30785,.31057,.31327,.31594,.31859,.32121,.32381,.32639,.32894,.33147,.33398,.33646,.33891,.34134,.34375,.34614,.34849,.35083,.35314,.35543,.35769,.35993,.36214,.36433,.3665,.36864,.37076,.37286,.37493,.37698,.379,.381,.38298,.38493,.38686,.38877,.39065,.39251,.39435,.39617,.39796,.39973,.40147,.4032,.4049,.40658,.40824,.40988,.41149,.41308,.41466,.41621,.41774,.41924,.42073,.4222,.42364,.42507,.42647,.42785,.42922,.43056,.43189,.43319,.43448,.43574,.43699,.43822,.43943,.44062,.44179,.44295,.44408,.4452,.4463,.44738,.44845,.4495,.45053,.45154,.45254,.45352,.45449,.45543,.45637,.45728,.45818,.45907,.45994,.4608,.46164,.46246,.46327,.46407,.46485,.46562,.46638,.46712,.46784,.46856,.46926,.46995,.47062,.47128,.47193,.47257,.4732,.47381,.47441,.475,.47558,.47615,.4767,.47725,.47778,.47831,.47882,.47932,.47982,.4803,.48077,.48124,.48169,.48214,.48257,.483,.48341,.48382,.48422,.48461,.485,.48537,.48574,.4861,.48645,.48679,.48713,.48745,.48778,.48809,.4884,.4887,.48899,.48928,.48956,.48983,.4901,.49036,.49061,.49086,.49111,.49134,.49158,.4918,.49202,.49224,.49245,.49266,.49286,.49305,.49324,.49343,.49361,.49379,.49396,.49413,.4943,.49446,.49461,.49477,.49492,.49506,.4952,.49534,.49547,.4956,.49573,.49585,.49598,.49609,.49621,.49632,.49643,.49653,.49664,.49674,.49683,.49693,.49702,.49711,.4972,.49728,.49736,.49744,.49752,.4976,.49767,.49774,.49781,.49788,.49795,.49801,.49807,.49813,.49819,.49825,.49831,.49836,.49841,.49846,.49851,.49856,.49861,.49865,.49869,.49874,.49878,.49882,.49886,.49889,.49893,.49896,.499,.49903,.49906,.4991,.49913,.49916,.49918,.49921,.49924,.49926,.49929,.49931,.49934,.49936,.49938,.4994,.49942,.49944,.49946,.49948,.4995,.49952,.49953,.49955,.49957,.49958,.4996,.49961,.49962,.49964,.49965,.49966,.49968,.49969,.4997,.49971,.49972,.49973,.49974,.49975,.49976,.49977,.49978,.49978,.49979,.4998,.49981,.49981,.49982,.49983,.49983,.49984,.49985,.49985,.49986,.49986,.49987,.49987,.49988,.49988,.49989,.49989,.4999,.4999,.4999,.49991,.49991,.49992,.49992,.49992,.49992,.49993,.49993,.49993,.49994,.49994,.49994,.49994,.49995,.49995,.49995,.49995,.49995,.49996,.49996,.49996,.49996,.49996,.49996,.49997,.49997,.49997,.49997,.49997,.49997,.49997,.49997,.49998,.49998,.49998,.49998],n.prototype.colorClass=["concerning","poor","good","great"],n.prototype.status=["Concerning","Poor","Good","Great"],n.prototype.events={"click .back":"goBack","change #selector_container input":"selector","click .student_name":"showItemized"},n.prototype.showItemized=function(e){var t,n,r;return n=$(e.target),r=$(e.target).attr("data-studentId"),t=this.$el.find(".student_"+r),t.is(":visible")?(t.addClass("confirmation"),n.css({color:"black"})):(this.$el.find(".student_name").css({color:"black"}),n.css({color:"white"}),this.$el.find(".itemized_results").addClass("confirmation"),this.$el.find(".student_"+r).removeClass("confirmation"))},n.prototype.selector=function(){var e;return e=this.$el.find("#selector_container input:checked").attr("data-subtestId"),this.selected.subtestId=e,this.selected.results=this.results.where({subtestId:e}),this.updateTable(),this.render()},n.prototype.goBack=function(){return history.back()},n.prototype.initialize=function(e){var t,n,r,i,s;this.results=e.results,this.subtests=e.subtests,this.students=e.students,this.selected={},s=this.subtests.models;for(t=r=0,i=s.length;r<i;t=++r){n=s[t],this.selected.subtestId=this.subtests.models[t].id;if((this.selected.results=this.results.where({subtestId:n.id})).length!==0)break}return this.updateTable()},n.prototype.updateTable=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C;this.table=[],e=0,this.subtest=this.subtests.get(this.selected.subtestId),this.summary={name:this.subtest.get("name"),classSize:this.students.length,resultCount:this.selected.results.length,aCorrect:0,anCorrect:0,stdDev:0,attempted:0,totalItems:this.subtest.get("items").length,watchList:[]},x=this.selected.results;for(v=0,b=x.length;v<b;v++)p=x[v],h={studentId:p.get("studentId"),items:p.get("subtestData").items,name:this.students.get(p.get("studentId")).get("name"),pCorrect:0,nCorrect:p.get("correct"),attempted:p.get("total")-p.get("missing"),total:p.get("total"),deviation:0,percentile:0,status:""},h.pCorrect=Math.round(h.nCorrect/h.attempted*100),this.summary.aCorrect+=h.pCorrect,this.summary.anCorrect+=h.nCorrect,this.summary.attempted+=h.attempted,this.table.push(h);this.summary.aCorrect=Math.decimals(this.summary.aCorrect/this.table.length,2),this.summary.anCorrect=Math.decimals(this.summary.anCorrect/this.table.length,2),this.summary.attempted=Math.decimals(this.summary.attempted/this.table.length,2),T=this.table;for(m=0,w=T.length;m<w;m++)h=T[m],this.summary.stdDev+=Math.pow(h.pCorrect-this.summary.aCorrect,2);this.summary.stdDev=Math.decimals(Math.pow(this.summary.stdDev/this.table.length,.5),2),N=this.table;for(s=g=0,E=N.length;g<E;s=++g)h=N[s],r=(h.pCorrect-this.summary.aCorrect)/this.summary.stdDev,i=Math.round(r*100),c=i>409||i<-409?0:i>0?100*Math.round(50+100*this.normalCurve[i])/100:i<0?100*Math.round(50-100*this.normalCurve[i*-1])/100:50,l=h.pCorrect,o=l>=80?o=3:l>=60&&l<=79?o=2:l>=30&&l<=59?o=1:o=0,this.table[s].deviation=i/100,this.table[s].percentile=c,this.table[s].index=o,this.table[s].status=this.status[o],o===0&&!~this.summary.watchList.indexOf(h.name)&&this.summary.watchList.push(h.name);this.table.sort(function(e,t){return t.pCorrect-e.pCorrect}),a=0,C=this.table;for(y=0,S=C.length;y<S;y++)h=C[y],h.pCorrect<75&&a++;return f=a/this.table.length*100,u=f<20,d="<img src='images/icon_warn.png'>",this.readyPercentage="<p>"+f+"% of your students are not ready to move on to the next lessons.</p>",n="It is ok to move on in the lesson sequence. Make sure that those children performing in the “poor” or “concerning” category get extra attention and practice and don’t fall behind. This can be done during practice lessons on Tuesday and Thursdays, or during another subject on the timetable.",t="Your class needs extra practice. Consider re-teaching Monday and Wednesday lessons introducing the new curriculum items or organize intense practice activities for the entire class. To find out which items students are particularly struggling with, select the name of a few students in the “poor” or “concerning” category and review their performance item by item. Take note of items that seem particularly troublesome.",this.readinessWarning=u?n:t},n.prototype.render=function(){var e,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E;~this.subtests.pluck("reportType").indexOf("progress")||(h="      <section>        "+this.readyPercentage+"        "+this.readinessWarning+"      </section>      ",h+="      <section>        <p>Refer to the file “Kiswahili Wordlists” on your tablet for a list of additional words that may be useful for such group-based activities or practice for students performing in the “poor” or “concerning” category.</p>        <p>For the students to watch – consider also communicating with parents for extra practice at home.</p>        <p>Identify items these students need further practice on by selecting their name in the grouping report to see their performance on each item.</p>        <p>Give parents some help: Write out on a piece of paper the letters for them to practice with their child; or copy applicable words from the “Kiswahili Wordlists” that contain the letters for the child to practice.</p>      </section>      "),i="      <h1>"+t("student grouping report")+"</h1>      <p>No students tested for "+this.subtests.get(this.selected.subtestId).get("name")+" on assessment #"+this.subtests.models[0].get("part")+" yet. Return to the <a href='#class'>class menu</a> and click the <img src='images/icon_run.png'> icon to collect data.</p>    ",a="<div id='selector_container' class='buttonset'>",b=this.subtests.models;for(p=0,m=b.length;p<m;p++)l=b[p],e=l.id===this.selected.subtestId?"checked='checked'":"",a+="        <label for='"+l.id+"'>"+l.get("name")+"</label>        <input type='radio' class='selector' name='selector' id='"+l.id+"' data-subtestId='"+l.id+"' "+e+">      ";a+="</div>",c="<h1>Summary</h1>    <table class='summary'>      <tr><th>Subtest Name</th>          <td>"+this.summary.name+"</td></tr>      <tr><th>Class Size</th>            <td>"+this.summary.classSize+"</td></tr>      <tr><th>Students Assessed</th>     <td>"+this.summary.resultCount+"</td></tr>      <tr><th>Average Correct (%)</th>   <td>"+this.summary.aCorrect+"%</td></tr>      <tr><th>Average Correct</th>       <td>"+this.summary.anCorrect+" / "+this.summary.attempted+"</td></tr>      <tr><th>Students to watch</th>     <td>"+this.summary.watchList.join(", ")+"</td></tr>    </table>",r="      <h1>Student grouping</h1>      <table class='details'>      <tr>        <th>Name</th>        <th>% correct</th>        <th>Status</th>      </tr>    ",u="",w=this.table;for(d=0,g=w.length;d<g;d++){f=w[d],r+="        <tr class='"+this.colorClass[f.index]+"'>          <td class='student_name icon' data-studentId='"+f.studentId+"'>"+f.name+"</td>          <td>"+f.pCorrect+"</td>          <td>"+f.status+"</td>        </tr>        ",u+="        <table class='itemized_results confirmation student_"+f.studentId+"'>          <tbody><tr><th>Item</th><th>Result</th></tr>      ",E=f.items;for(o=v=0,y=E.length;v<y;o=++v)n=E[o],u+="<tr><td>"+n.itemLabel+"</td><td>"+t(n.itemResult)+"</td></tr>";u+="</tbody></table>"}return r+="</table>",this.selected.results.length!==0?s="        "+a+"        "+c+"        "+r+"        "+u+"        "+(h||"")+"        <button class='navigation back'>Back</button>      ":s="        "+a+"        "+i+"        <button class='navigation back'>Back</button>      ",this.$el.html(s),this.trigger("rendered")},n.prototype.getQuartile=function(e){return Math.round(e/100*3)},n}(Backbone.View);var KlassGroupingMenuView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};KlassGroupingMenuView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="KlassGroupingMenuView",t.prototype.events={"change .part_selector":"gotoKlassGroupingReport"},t.prototype.gotoKlassGroupingReport=function(e){return Tangerine.router.navigate("report/klassGrouping/"+this.klass.id+"/"+this.$el.find(e.target).find(":selected").attr("data-part"),!0)},t.prototype.initialize=function(e){var t=this;return this.parent=e.parent,this.klass=this.parent.options.klass,this.curricula=this.parent.options.curricula,this.currentPart=this.klass.calcCurrentPart(),this.students=new Students,this.students.fetch({klassId:this.klass.id,success:function(){var e;return e=new Subtests,e.fetch({success:function(e){var n,r,i,s,o;i=e.where({curriculaId:t.curricula.id}),t.parts=[];for(s=0,o=i.length;s<o;s++)r=i[s],n=r.get("part"),t.parts[n]==null&&(t.parts[n]={}),t.parts[n].id=r.id,t.parts[n]["name"]!=null?t.parts[n].name+=" "+r.get("name"):t.parts[n].name=r.get("name"),t.parts[n].reportType=r.get("reportType");return t.ready=!0,t.render()}})}})},t.prototype.render=function(){var e,t,n,r,i,s,o;if(this.ready){if(this.students==null||this.students.length===0){this.$el.html("Please add students to this class.");return}t="        <select class='part_selector'>          <option disabled='disabled' selected='selected'>Select an assessment</option>          ",o=this.parts;for(n=i=0,s=o.length;i<s;n=++i)r=o[n],(r!=null?r.id:void 0)!=null&&(e=this.currentPart===n?"**":"",t+="<option data-part='"+n+"' data-subtestId='"+r.id+"'>"+e+" "+n+" "+r.name+"</option>");return t+="</select>",this.$el.html(t)}return this.$el.html("<img src='images/loading.gif' class='loading'>")},t}(Backbone.View);var MasteryCheckView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};MasteryCheckView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="MasteryCheckView",n.prototype.events={"click .back":"goBack"},n.prototype.goBack=function(){return history.back()},n.prototype.initialize=function(e){this.subtests=e.subtests,this.results=e.results,this.student=e.student,this.klass=e.klass,this.resultsByPart=this.results.indexBy("part"),this.lastPart=Math.max.apply(this,this.results.pluck("part"));if(!isFinite(this.lastPart))return this.lastPart=0},n.prototype.render=function(){var e,n,r,i,s,o,u,a,f,l;e="      <h1>Mastery check report</h1>      <h2>Student "+this.student.get("name")+"</h2>    ",n="<p>No test data for this type of report. Return to the <a href='#class'>class menu</a> and click the <img src='images/icon_run.png'> icon to collect data.</p>";if(this.results.length===0){this.$el.html("        "+e+"        "+n+"      "),this.trigger("rendered");return}e+="<table>";for(r=o=1,f=this.lastPart;1<=f?o<=f:o>=f;r=1<=f?++o:--o){if(this.resultsByPart[r]==null)continue;e+="        <tr><th>Assessment "+r+"</th></tr>        <tr>",l=this.resultsByPart[r];for(u=0,a=l.length;u<a;u++)i=l[u],s=this.subtests.get(i.get("subtestId")).get("name"),e+="          <td>            "+i.get("itemType").titleize()+" correct<br>            "+s+"          </td>          <td>"+i.get("correct")+"/"+i.get("total")+"</td>"}return e+="    </table>    <button class='navigation back'>"+t("back")+"</button>    ",this.$el.html(e),this.trigger("rendered")},n}(Backbone.View);var MasteryCheckMenuView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};MasteryCheckMenuView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="MasteryCheckMenuView",n.prototype.events={"change .student_selector":"gotoMasteryCheckReport"},n.prototype.gotoMasteryCheckReport=function(e){return Tangerine.router.navigate("report/masteryCheck/"+this.$el.find(e.target).find(":selected").attr("data-studentId"),!0)},n.prototype.initialize=function(e){var t,n=this;return this.parent=e.parent,this.klass=this.parent.options.klass,this.curricula=this.parent.options.curricula,t=new Students,t.fetch({success:function(e){return n.students=e.where({klassId:n.klass.id}),n.ready=!0,n.render()}})},n.prototype.render=function(){var e,n,r,i,s;if(this.ready){if(this.students.length===0){this.$el.html("Please add students to this class.");return}e="        <select class='student_selector'>          <option disabled='disabled' selected='selected'>"+t("select a student")+"</option>          ",s=this.students;for(r=0,i=s.length;r<i;r++)n=s[r],e+="<option data-studentId='"+n.id+"'>"+n.get("name")+"</option>";return e+="</select>",this.$el.html(e)}return this.$el.html("<img src='images/loading.gif' class='loading'>")},n}(Backbone.View);var ProgressView,SortedCollection,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ProgressView=function(e){function n(){return this.updateFlot=__bind(this.updateFlot,this),this.afterRender=__bind(this.afterRender,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="ProgressView",n.prototype.INDIVIDUAL=1,n.prototype.AGGREGATE=2,n.prototype.events={"click .back":"goBack","click .select_itemType":"selectItemType","click .xtick":"selectAssessment"},n.prototype.selectAssessment=function(e){return this.selected.week=parseInt($(e.target).attr("data-index")),this.updateTable(),this.updateFlot()},n.prototype.selectItemType=function(e){var t;return t=$(e.target),this.selected.itemType=t.attr("data-itemType"),this.$el.find(".select_itemType").removeClass("selected"),t.addClass("selected"),this.updateTable(),this.updateFlot()},n.prototype.goBack=function(){return history.go(-1)},n.prototype.initialize=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,D,P,H,B,j,F,I,q,R,U,z;this.results=e.results,this.student=e.student,this.subtests=e.subtests,this.klass=e.klass,this.klass==null&&Utils.log(this,"No klass."),this.subtests==null&&Utils.log(this,"No progress type subtests.");if(this.results.length===0){this.renderReady=!0,this.render();return}this.mode=this.student!=null?this.INDIVIDUAL:this.AGGREGATE,this.subtestNames={},this.benchmarkScore={},this.rows=[],this.partCount=0,this.flot=null,this.lastPart=Math.max.apply(this,_.compact(this.subtests.pluck("part"))),this.resultsByPart=[],this.itemTypeList={},this.selected={itemType:null,week:0},c=[],B=this.subtests.models;for(y=0,S=B.length;y<S;y++)v=B[y],~c.indexOf(v.get("part"))||c.push(v.get("part")),i=c.indexOf(v.get("part")),this.subtestNames[i]==null&&(this.subtestNames[i]={}),this.subtestNames[i][v.get("itemType")]=v.get("name");this.partCount=c.length,g=this.subtests.indexBy("part"),l=_.keys(g),this.indexByPart=[];for(i=b=0,x=l.length;b<x;i=++b)f=l[i],this.indexByPart[f]=i;this.resultsByPart=this.results.indexBy("part"),j=this.results.models;for(w=0,T=j.length;w<T;w++)p=j[w],this.itemTypeList[p.get("itemType").toLowerCase()]=!0;this.itemTypeList=_.keys(this.itemTypeList);for(f=E=1,F=this.lastPart;1<=F?E<=F:E>=F;f=1<=F?++E:--E){if(this.resultsByPart[f]===void 0)continue;o={},I=this.resultsByPart[f];for(i=O=0,N=I.length;O<N;i=++O){p=I[i];if(this.mode===this.INDIVIDUAL&&p.get("studentId")!==this.student.id)continue;s=p.get("itemType"),this.selected.itemType==null&&(this.selected.itemType=s),o[s]==null&&(o[s]=[]),o[s].push({name:s.titleize(),key:s,part:p.get("part"),correct:p.get("correct"),attempted:p.get("attempted"),itemsPerMinute:p.getCorrectPerSeconds(60)}),this.benchmarkScore[s]=this.subtests.get(p.get("subtestId")).getNumber("scoreTarget")}this.rows.push({part:f,itemTypes:_.values(o)})}this.rows=this.aggregate(this.rows),this.rows.length!==0&&(this.selected={week:this.indexByPart[_.last(this.rows).part],itemType:_.last(this.rows).itemTypes[0].key}),h={},q=this.rows;for(i=M=0,C=q.length;M<C;i=++M){d=q[i],R=d.itemTypes;for(D=0,k=R.length;D<k;D++)s=R[D],r=this.indexByPart[d.part]+1,h[s.key]==null&&(h[s.key]=[]),h[s.key].push([r,s.itemsPerMinute])}this.flotData=[],this.benchmarkData=[],i=0;for(a in h)t=h[a],u=a.toLowerCase(),this.flotData[u]={data:t,label:a.titleize(),key:u,lines:{show:!0},points:{show:!0}};this.flotBenchmark=[],U=this.subtests.indexBy("itemType");for(s in U){m=U[s],n=[];for(i=P=0,L=m.length;P<L;i=++P)v=m[i],r=this.indexByPart[v.get("part")]+1,n.push([r,v.getNumber("scoreTarget")]);this.flotBenchmark[s.toLowerCase()]={label:"Progress benchmark",data:n,color:"#aaa",lines:{show:!0}}}this.warningThresholds={},z=this.subtests.indexBy("itemType");for(s in z){m=z[s],this.warningThresholds[s]=[];for(i=H=0,A=m.length;H<A;i=++H)v=m[i],this.warningThresholds[s.toLowerCase()][this.indexByPart[v.get("part")]]={target:v.getNumber("scoreTarget"),spread:v.getNumber("scoreSpread"),seconds:v.getNumber("timer")}}return this.renderReady=!0,this.render()},n.prototype.render=function(){var e,n,r,i,s,o,u,a,f,l,c;if(!this.renderReady)return;e=$(window),a={h:e.height(),w:e.width()},this.mode===this.INDIVIDUAL&&(u="      <h2>"+this.student.get("name")+"</h2>    "),n="      <h1>Progress table</h1>      "+(u||"")+"    ",r="<p>No test data for this type of report. Return to the <a href='#class'>class menu</a> and click the <img src='images/icon_run.png'> icon to collect data.</p>";if(this.results.length===0){this.$el.html("        "+n+"        "+r+"      "),this.trigger("rendered");return}n+="      <div id='flot-menu'>      ",c=_.uniq(this.subtests.pluck("itemType"));for(f=0,l=c.length;f<l;f++)i=c[f],s=i.replace(/[_-]/g," ").capitalize(),o=i===this.selected.itemType?"selected":"",n+="<button class='command select_itemType "+o+"' data-itemType='"+i+"'>"+s+"</button>";return n+="      </div>      <div id='flot-container' style='width: "+window.w*.8+"px; height:300px;'></div>    ",n+="    <div id='table_container'></div>    <button class='navigation back'>"+t("back")+"</button>    ",this.$el.html(n),this.updateTable(),this.trigger("rendered")},n.prototype.afterRender=function(){return this.updateFlot()},n.prototype.updateTable=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T;p=this.selected.itemType,v=this.selected.week,s="<table class='tabular'>",S=this.rows;for(o=m=0,b=S.length;m<b;o=++m){l=S[o];if(!~_.pluck(l.itemTypes,"key").indexOf(p))continue;s+="<tr><th>"+this.subtestNames[o][p]+"</th></tr><tr>",x=l.itemTypes;for(g=0,w=x.length;g<w;g++){u=x[g];if(u.key!==p)continue;s+="          <tr>            <td>"+u.name+" correct</td><td>"+u.correct+"/"+u.attempted+"</td>          </tr>          <tr>            <td>"+u.name+" correct per minute</td><td>"+u.itemsPerMinute+"</td>          </tr>         "}}s+="</table>",e=_.pluck((T=this.rows[v])!=null?T.itemTypes:void 0,"key");if(v>=this.rows.length||!~e.indexOf(p))s+="<section>No data for this assessment.</section>";else if(this.mode===this.AGGREGATE){c=0,t=this.flotData[p]!=null?this.flotData[p].data:[];for(y=0,E=t.length;y<E;y++)n=t[y],n[0]===v+1&&(c=n[1]);h=this.warningThresholds[p][v],i=h.target+h.spread,a=h.target-h.spread,r=c-h.target,c>i?(f="("+c+"), "+r+" correct items per minute above the benchmark",d="Your class is doing well, "+f+", continue with the reading program. Share your and your class’ great work with parents. Reward your class with some fun reading activities such as reading marathons or competitions. However, look at a student grouping report for this assessment and make sure that those children performing below average get extra attention and practice and don’t fall behind."):c<a?(f="("+c+"), "+Math.abs(r)+" correct items per minute below the benchmark",d="Your class is performing below the grade-level target, "+f+". Plan for additional lesson time focusing on reading in consultation with your principal. Encourage parents to spend more time with reading materials at home – remind them that you are a team working together to help their children learning to read. Think about organizing other events and opportunities for practice, e.g., reading marathons or competitions to motivate students to read more."):(r!==0&&r*-1===Math.abs(r)?f=c-h.target+" correct items per minute above the bench mark":r===0?f=""+c+" correct items per minute":f="("+c+"), "+Math.abs(c-h.target)+" correct items per minute below the bench mark",d="Your class is in line with expectations, "+f+". Continue with the reading program and keep up the good work! Look at a student grouping report for this assessment and make sure that those children performing below average get extra attention and practice and don’t fall behind."),s+="        <section>          "+d+"        </section>      "}return this.$el.find("#table_container").html(s)},n.prototype.updateFlot=function(){var e,t,n=this;return this.flotOptions={xaxis:{min:.5,max:this.partCount+.5,ticks:function(){var e,n,r;r=[];for(t=e=1,n=this.partCount;1<=n?e<=n:e>=n;t=1<=n?++e:--e)r.push(String(t));return r}.call(this),tickDecimals:0,tickFormatter:function(e){return n.subtestNames[e-1][n.selected.itemType]!=null?"<button class='xtick "+(e-1===n.selected.week?"selected":"")+"' data-index='"+(e-1)+"'>"+n.subtestNames[e-1][n.selected.itemType]+"</button>":""}},grid:{markings:{color:"#ffc",xaxis:{to:this.selected.week+.5,from:this.selected.week-.5}}}},e=[],this.flotData[this.selected.itemType]&&e.push(this.flotData[this.selected.itemType]),this.flotBenchmark[this.selected.itemType]&&e.push(this.flotBenchmark[this.selected.itemType]),this.flot=$.plot(this.$el.find("#flot-container"),e,this.flotOptions)},n.prototype.aggregate=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;r=[];for(t=u=0,l=e.length;u<l;t=++u){o=e[t],r[t]={part:o.part,itemTypes:[]},p=o.itemTypes;for(a=0,c=p.length;a<c;a++){s=p[a],n={name:"",key:"",correct:0,attempted:0,itemsPerMinute:0};for(f=0,h=s.length;f<h;f++)i=s[f],n.name=i.name,n.key=i.key,n.correct+=i.correct,n.attempted+=i.attempted,n.itemsPerMinute+=i.itemsPerMinute;n.correct/=s.length,n.attempted/=s.length,n.itemsPerMinute/=s.length,n.correct=Math.round(n.correct),n.attempted=Math.round(n.attempted),n.itemsPerMinute=Math.round(n.itemsPerMinute),r[t].itemTypes.push(n)}}return r},n}(Backbone.View),SortedCollection=function(){function e(e){this.sorted=[],this.models=e.models,this.attribute=e.attribute}return e}();var ProgressMenuView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ProgressMenuView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="ProgressMenuView",n.prototype.events={"change .student_selector":"gotoProgressTable"},n.prototype.gotoProgressTable=function(e){return Tangerine.router.navigate("report/progress/"+this.$el.find(e.target).find(":selected").attr("data-studentId")+("/"+this.klass.id),!0)},n.prototype.initialize=function(e){var t,n=this;return this.parent=e.parent,this.klass=this.parent.options.klass,this.curricula=this.parent.options.curricula,t=new Students,t.fetch({success:function(e){return n.students=e.where({klassId:n.klass.id}),n.ready=!0,n.render()}})},n.prototype.render=function(){var e,n,r,i,s;if(this.ready){if(this.students.length===0){this.$el.html("Please add students to this class.");return}e="        <select class='student_selector'>          <option disabled='disabled' selected='selected'>"+t("select a student")+"</option>          <option data-studentId='all'>"+t("all students")+"</option>      ",s=this.students;for(r=0,i=s.length;r<i;r++)n=s[r],e+="<option data-studentId='"+n.id+"'>"+n.get("name")+"</option>";return e+="</select>",this.$el.html(e)}return this.$el.html("<img src='images/loading.gif' class='loading'>")},n}(Backbone.View);var Curriculum,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Curriculum=function(e){function t(){return this.updateFromServer=__bind(this.updateFromServer,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="curriculum",t.prototype.isArchived=function(){return!1},t.prototype.updateFromServer=function(e){var t,n=this;return e==null&&(e=this.id.substr(-5,5)),t=JSON.stringify(e.replace(/[^a-f0-9]/g," ").split(/\s+/)),this.trigger("status","import lookup"),$.ajax(Tangerine.settings.urlView("group","byDKey"),{type:"POST",dataType:"jsonp",data:{keys:t},success:function(e){var t,r,i,s,o;r=[],o=e.rows;for(i=0,s=o.length;i<s;i++)t=o[i],r.push(t.id);return $.couch.replicate(Tangerine.settings.urlDB("group"),Tangerine.settings.urlDB("local"),{success:function(){return n.trigger("status","import success")},error:function(e,t){return n.trigger("status","import error",""+e+" "+t)}},{doc_ids:r})}}),!1},t.prototype.destroy=function(e){var n,r;return n=this.id,r=new Subtests,r.fetch({key:n,success:function(e){var t;t=[];while(e.length!==0)t.push(e.pop().destroy());return t}}),t.__super__.destroy.call(this,{success:function(){return e()}})},t}(Backbone.Model);var CurriculumView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};CurriculumView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="CurriculumView",n.prototype.events={"click .back":"goBack","click .delete":"deleteCurriculum","click .delete_subtest":"deleteSubtest","click .edit_in_place":"editInPlace","click .new_subtest":"newSubtest","focusout .editing":"editing","keyup    .editing":"editing","keydown  .editing":"editing"},n.prototype.initialize=function(e){return this.curriculum=e.curriculum,this.subtests=e.subtests,this.totalAssessments=Math.max.apply(Math,this.subtests.pluck("part")),this.subtestsByPart=this.subtests.indexArrayBy("part"),this.subtestProperties={grid:[{key:"part",label:"Assessment",editable:!0},{key:"name",label:"Name",editable:!0,escaped:!0},{key:"items",label:"Items",count:!0,editable:!0},{key:"timer",label:"Time<br>allowed",editable:!0},{key:"reportType",label:"Report",editable:!0}],survey:[{key:"part",label:"assessment",editable:!0},{key:"name",label:"Name",editable:!0},{key:"reportType",label:"Report",editable:!0}]}},n.prototype.render=function(){var e,n,r;return r=this.getSubtestTable(),e=Tangerine.settings.get("context")==="server"?"<button class='command_red delete'>Delete</button>":"",n="      <button class='navigation back'>"+t("back")+"</button>      <h1>"+this.options.curriculum.get("name")+"</h1>      <div class='small_grey'>Download key <b>"+this.curriculum.id.substr(-5,5)+"</b></div>            <div id='subtest_table_container'>        "+r+"      </div>      <button class='command new_subtest' data-prototype='grid'>New Grid Subtest</button><br>      <button class='command new_subtest' data-prototype='survey'>New Survey Subtest</button>      <br><br>      "+e+"    ",this.$el.html(n),this.trigger("rendered")},n.prototype.updateTable=function(){return this.$el.find("#subtest_table_container").html(this.getSubtestTable())},n.prototype.getSubtestTable=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m;t="<table class='subtests'>",t+="      <thead class='auto_fixed'>        <tr>    ",d=this.subtestProperties;for(a=0,c=d.length;a<c;a++)i=d[a],t+="<th>"+i.label+"</th>";t+="        </tr>      </thead>    ",t+="      <tbody>    ",this.subtestsByPart=this.subtests.indexArrayBy("part"),v=this.subtestsByPart;for(r in v){o=v[r],t+="<tr><td>&nbsp;</td></tr>";for(f=0,h=o.length;f<h;f++){s=o[f],t+="<tr>",m=this.subtestProperties[s.get("prototype")];for(l=0,p=m.length;l<p;l++)i=m[l],u=i.key!=null?s.get(i.key):"&nbsp;",u=i.escape?s.escape(i.key):u,i.count!=null&&(u=u.length),u==null&&(u=""),e=i.editable&&Tangerine.settings.get("context")==="server"?"class='edit_in_place'":"",n=_.isNumber(u)?"data-isNumber='true'":"data-isNumber='false'",t+="<td class='edit_in_place'><span data-subtestId='"+s.id+"' data-key='"+i.key+"' data-value='"+u+"' "+e+" "+n+">"+u+"</div></td>";Tangerine.settings.get("context")==="server"&&(t+="            <td>              <a href='#class/subtest/"+s.id+"'><img class='link_icon edit' title='Edit' src='images/icon_edit.png'></a>              <img class='link_icon delete_subtest' title='Delete' data-subtestId='"+s.id+"' src='images/icon_delete.png'>            </td>"),t+="</tr>"}}return t+="      </tbody>    </table>    "
,t},n.prototype.editInPlace=function(e){var t,n,r,i,s,o,u,a,f,l;if(this.alreadyEditing)return;this.alreadyEditing=!0,t=$(e.target);if(t.prop("tagName")==="TD"){t=t.find("span");if(t.length===0)return}n=t.parent(),this.$oldSpan=t.clone();if(t.prop("tagName")==="TEXTAREA")return;return i=Utils.guid(),o=t.attr("data-key"),s=t.attr("data-isNumber")==="true",f=t.attr("data-subtestId"),a=this.subtests.get(f),u=a.get(o),o==="items"&&(u=u.join(" ")),l="data-isNumber='' data-key='"+o+"' data-subtestId='"+f+"' ",n.html("<textarea id='"+i+"' "+l+" class='editing'>"+u+"</textarea>"),r=$("#"+i),r.focus()},n.prototype.editing=function(e){var t,n,r,i,s,o,u,a,f,l=this;t=$(e.target),n=t.parent();if(e.which===27||e.type==="focusout"){t.remove(),n.html(this.$oldSpan),this.alreadyEditing=!1;return}return e.which!==13||e.type!=="keydown"?!0:(this.alreadyEditing=!1,s=t.attr("data-key"),i=t.attr("data-isNumber")==="true",f=t.attr("data-subtestId"),a=this.subtests.get(f),u=a.get(s),o=t.val(),o=i?parseInt(o):o,s==="items"&&(o=o.replace(/\s+/g," "),/\t|,/.test(o)&&alert('Please remember\n\nGrid items are space " " delimited'),o=_.compact(o.split(" "))),String(o)!==String(u)&&(r={},r[s]=o,a.save(r,{success:function(){return Utils.midAlert("Subtest saved"),a.fetch({success:function(){return l.updateTable()}})},error:function(){return a.fetch({success:function(){return l.updateTable(),alert("Please try to save again, it didn't work that time.")}})}})),!1)},n.prototype.goBack=function(){if(Tangerine.settings.get("context")==="server")return Tangerine.router.navigate("assessments",!0);if(Tangerine.settings.get("context")==="class")return Tangerine.router.navigate("class",!0)},n.prototype.deleteCurriculum=function(){var e=this;if(confirm("Delete curriculum\n"+this.curriculum.get("name")+"?"))return this.curriculum.destroy(function(){return Tangerine.router.navigate("assessments",!0)})},n.prototype.newSubtest=function(e){var t,n,r,i,s;return r=$(e.target).attr("data-prototype"),t=Utils.guid(),s={_id:t,curriculumId:this.curriculum.id,prototype:r,captureLastAttempted:!1,endOfLine:!1},n=Tangerine.templates.get("prototypes"),s=$.extend(n[r],s),i=new Subtest(s),i.save(null,{success:function(){return Tangerine.router.navigate("class/subtest/"+t,!0)},error:function(){return alert("Please try again. There was a problem creating the new subtest.")}})},n.prototype.deleteSubtest=function(e){var t,n,r=this;n=$(e.target).attr("data-subtestId"),t=this.subtests.get(n);if(confirm("Delete subtest\n"+t.get("name")+"?"))return t.destroy({success:function(){return r.subtests.remove(n),r.updateTable()},error:function(){return alert("Please try again, could not delete subtest.")}})},n}(Backbone.View);var Curricula,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Curricula=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="curriculum",t.prototype.model=Curriculum,t}(Backbone.Collection);var CurriculaView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};CurriculaView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="CurriculaView",n.prototype.events={"click .import":"gotoImport","click .back":"goBack"},n.prototype.goBack=function(){return history.back()},n.prototype.gotoImport=function(){return Tangerine.router.navigate("curriculumImport",!0)},n.prototype.initialize=function(e){return this.subView=new CurriculaListView({curricula:e.curricula})},n.prototype.render=function(){return this.$el.html("      <button class='back navigation'>"+t("back")+"</button><br>      <button class='command import'>"+t("import")+"</button>      <br>      <div id='curricula_list'></div>    "),this.subView.setElement(this.$el.find("#curricula_list")),this.subView.render(),this.trigger("rendered")},n.prototype.onClose=function(){var e;return(e=this.subView)!=null?e.close():void 0},n}(Backbone.View);var CurriculaListView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};CurriculaListView=function(e){function t(){return this.render=__bind(this.render,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="CurriculaListView",t.prototype.tagName="ul",t.prototype.initialize=function(e){var t;return this.views=[],this.curricula=e.curricula,typeof (t=this.curricula).on=="function"?t.on("all",this.render):void 0},t.prototype.render=function(){var e=this;if(this.curricula.length===0)return;return this.$el.html("<h2>Curricula</h2>"),this.closeViews,this.curricula.each(function(t){var n;return n=new CurriculumListElementView({curriculum:t}),n.render(),e.$el.append(n.el),e.views.push(n)}),this.trigger("rendered")},t.prototype.onClose=function(){return this.closeViews()},t.prototype.closeViews=function(){var e,t,n,r,i;r=this.views,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(typeof e.close=="function"?e.close():void 0);return i},t}(Backbone.View);var CurriculumListElementView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};CurriculumListElementView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="CurriculumListElementView",t.prototype.tagName="li",t.prototype.events={"click div":"gotoDetails"},t.prototype.gotoDetails=function(){return Tangerine.router.navigate("curriculum/"+this.curriculum.id,!0)},t.prototype.initialize=function(e){return this.curriculum=e.curriculum,this.subtests=e.subtests,window.te=this.$el},t.prototype.render=function(){var e;return e=this.curriculum.escape("name"),this.$el.html("<div><span class='icon_ryte'> </span> "+e+"</div>"),this.trigger("rendered")},t}(Backbone.View);var CurriculaView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};CurriculaView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="CurriculaView",n.prototype.events={"click .import":"gotoImport","click .back":"goBack"},n.prototype.goBack=function(){return history.back()},n.prototype.gotoImport=function(){return Tangerine.router.navigate("curriculumImport",!0)},n.prototype.initialize=function(e){return this.subView=new CurriculaListView({curricula:e.curricula})},n.prototype.render=function(){return this.$el.html("      <button class='back navigation'>"+t("back")+"</button><br>      <button class='command import'>"+t("import")+"</button>      <br>      <div id='curricula_list'></div>    "),this.subView.setElement(this.$el.find("#curricula_list")),this.subView.render(),this.trigger("rendered")},n.prototype.onClose=function(){var e;return(e=this.subView)!=null?e.close():void 0},n}(Backbone.View);var Teacher,Teachers,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Teacher=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="teacher",t}(Backbone.Model),Teachers=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.model=Teacher,t.prototype.url="teacher",t}(Backbone.Collection);var Student,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Student=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="student",t.prototype.defaults={gender:"Not entered",age:"Not entered",name:"Not entered",klassId:null},t.prototype.initialize=function(){},t}(Backbone.Model);var Students,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Students=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.model=Student,t.prototype.url="student",t.prototype.comparator=function(e){return e.get("name").toLowerCase()},t}(Backbone.Collection);var StudentListElementView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};StudentListElementView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="student_list_element",n.prototype.tagName="li",n.prototype.events={"click .edit":"edit","click .remove":"toggleRemove","click .remove_cancel":"toggleRemove","click .remove_delete":"removeStudent"},n.prototype.initialize=function(e){return this.student=e.student,this.students=e.students},n.prototype.edit=function(){return Tangerine.router.navigate("class/student/"+this.student.id,!0)},n.prototype.toggleRemove=function(){return this.$el.find(".remove_confirm, .remove").toggle()},n.prototype.removeStudent=function(){return this.student.set({klassId:null}).save(),this.students.remove(this.student)},n.prototype.render=function(){return this.$el.html("      "+this.student.get("name")+"      "+this.student.get("gender")+"      "+this.student.get("age")+"      <img src='images/icon_edit.png' class='edit' title='Edit'>      <img src='images/icon_delete.png' class='remove' title='Remove'>      <div class='remove_confirm confirmation'>        <div class='menu_box'>          "+t("remove student")+"<br>          <button class='remove_delete command_red'>"+t("remove")+"</button>          <button class='remove_cancel command'>"+t("cancel")+"</button>        </div>      </div>    "),this.trigger("rendered")},n}(Backbone.View);var StudentEditView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};StudentEditView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="StudentEditView",n.prototype.events={"click .done":"done","click .back":"back"},n.prototype.initialize=function(e){return this.student=e.student,this.klasses=e.klasses},n.prototype.done=function(){var e;return e=this.$el.find("#klass_select option:selected").attr("data-id"),e==="null"&&(e=null),this.student.set({name:this.$el.find("#name").val(),gender:this.$el.find("#gender").val(),age:this.$el.find("#age").val(),klassId:e}),this.student.save(),this.back()},n.prototype.back=function(){return window.history.back()},n.prototype.render=function(){var e,n,r,i,s,o,u,a,f;o=this.student.get("name")||"",n=this.student.get("gender")||"",e=this.student.get("age")||"",s=this.student.get("klassId"),r="    <h1>"+t("edit student")+"</h1>    <button class='back navigation'>"+t("back")+"</button><br>    <div class='info_box'>      <div class='label_value'>        <label for='name'>Full name</label>        <input id='name' value='"+o+"'>      </div>      <div class='label_value'>        <label for='gender'>"+t("gender")+"</label>        <input id='gender' value='"+n+"'>      </div>      <div class='label_value'>        <label for='age'>"+t("age")+"</label>        <input id='age' value='"+e+"'>      </div>      <div class='label_value'>        <label for='klass_select'>"+t("class")+"</label>        <select id='klass_select'>",r+="<option data-id='null' "+(s===null?"selected='selected'":void 0)+">"+t("none")+"</option>",f=this.klasses.models;for(u=0,a=f.length;u<a;u++)i=f[u],r+="<option data-id='"+i.id+"' "+(i.id===s?"selected='selected'":void 0)+">"+i.get("year")+" - "+i.get("grade")+" - "+i.get("stream")+"</option>";return r+="        </select>      </div>      <button class='done command'>"+t("done")+"</button>    </div>    ",this.$el.html(r),this.trigger("rendered")},n}(Backbone.View);var User,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};User=function(e){function n(){return this.fetch=__bind(this.fetch,this),this.sessionRefresh=__bind(this.sessionRefresh,this),this.login=__bind(this.login,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.url="user",n.prototype.initialize=function(e){return this.roles=[],this.dbAdmins=[],this.name=null},n.prototype.signup=function(e,n){var r=this;return Tangerine.log.app("User-signup",e),Tangerine.settings.get("context")==="server"?$.ajax({url:Tangerine.config.get("robbert"),type:"POST",dataType:"json",data:{action:"new_user",auth_u:e,auth_p:n},success:function(t){if(r.intent==="login")return r.intent="retry_login",r.login(e,n)}}):$.couch.signup({name:e},n,{success:function(t){if(r.intent==="login"&&Tangerine.settings.get("context")==="class"&&e!=="admin")return $.couch.login({name:e,password:n,success:function(t){var i;return r.intent="",r.name=e,r.roles=t.roles,i=new RegisterTeacherView({name:e,pass:n}),vm.show(i),Tangerine.log.app("User-teacher-register",e)}});if(r.intent==="login")return r.intent="retry_login",r.login(e,n)},error:function(){return r.intent="",r.trigger("pass-error",t("LoginView.message.error_password_incorrect"))}})},n.prototype.login=function(e,t,n){var r=this;return n==null&&(n={}),Tangerine.log.app("User-login-attempt",e),$.couch.login({name:e,password:t,success:function(t){return r.intent="",r.name=e,r.roles=t.roles,Tangerine.log.app("User-login-success",e),r.fetch({success:function(){return typeof n.success=="function"&&n.success(),r.trigger("login")}})},error:function(n,i,s){return r.intent==="retry_login"?(r.intent="",r.trigger("password-error",s),Tangerine.log.app("User-login-fail",e+" password incorrect")):(r.intent="login",r.signup(e,t))}})},n.prototype.sessionRefresh=function(e){var t=this;return $.couch.session({success:function(n){return n.userCtx.name!=null?(t.name=n.userCtx.name,t.roles=n.userCtx.roles,t.fetch({success:function(){return t.trigger("login"),e.success.apply(t,arguments),Tangerine.log.app("User-login","Resumed session")}})):e.success.apply(t,arguments)},error:function(){return alert("Couch session error.\n\n"+arguments.join("\n"))}})},n.prototype.verify=function(e){return this.name===null?(e!=null?e.isUnregistered:void 0)!=null?e.isUnregistered():Tangerine.router.navigate("login",!0):(e!=null&&typeof e.isRegistered=="function"&&e.isRegistered(),this.isAdmin()?e!=null?typeof e.isAdmin=="function"?e.isAdmin():void 0:void 0:e!=null?typeof e.isUser=="function"?e.isUser():void 0:void 0)},n.prototype.isAdmin=function(){var e;return(e=this.name,__indexOf.call(this.dbAdmins,e)>=0)||__indexOf.call(this.roles,"_admin")>=0},n.prototype.logout=function(){var e=this;return $.couch.logout({success:function(){return $.cookie("AuthSession",null),e.name=null,e.roles=[],e.clear(),e.trigger("logout"),Tangerine.settings.get("context")==="server"?window.location=Tangerine.settings.urlIndex("trunk"):Tangerine.router.navigate("login",!0),Tangerine.log.app("User-logout","logout")}})},n.prototype.save=function(e,t,n){var r,i=this;return r={},_.isObject(e)?(r=$.extend(r,e),n=t):r[e]=value,$.couch.userDb(function(e){return e.saveDoc($.extend(i.attributes,r),{success:function(){var e;return(e=n.success)!=null?e.apply(i,arguments):void 0}})})},n.prototype.fetch=function(e){var t=this;return e==null&&(e={}),$.couch.userDb(function(n){return n.openDoc("org.couchdb.user:"+t.name,{success:function(n){return Tangerine.$db.openDoc("_security",{success:function(r){var i,s,o;return t.dbAdmins=(r!=null?(i=r.admins)!=null?i.names:void 0:void 0)||[],t.dbReaders=(r!=null?(s=r.members)!=null?s.names:void 0:void 0)||[],t.dbReaders=_.filter(t.dbReaders,function(e){return e.substr(0,8)!=="uploader"}),t.set(n),(o=e.success)!=null&&o.apply(t,arguments),t.trigger("group-refresh")}})},error:function(){var n;return(n=e.error)!=null?n.apply(t,arguments):void 0}})})},n.prototype.joinGroup=function(e,t){var n=this;return t==null&&(t={}),Utils.working(!0),Utils.passwordPrompt(function(r){return Robbert.request({action:"new_group",group:e,auth_u:Tangerine.user.get("name"),auth_p:r,success:function(e){return Utils.working(!1),e.status==="success"&&(n.login(n.get("name"),r,{success:t}),n.trigger("group-join")),Utils.midAlert(e.message)},error:function(e){return Utils.working(!1),Utils.midAlert("Error creating group\n\n"+e[1]+"\n"+e[2]),n.fetch({success:t})}})})},n.prototype.leaveGroup=function(e,t){var n=this;return t==null&&(t={}),Utils.working(!0),Utils.passwordPrompt(function(r){return Robbert.request({action:"leave_group",user:n.get("name"),group:e,auth_u:Tangerine.user.get("name"),auth_p:r,success:function(e){return Utils.working(!1),n.login(n.get("name"),r,{success:t}),e.status==="success"&&n.trigger("group-leave"),Utils.midAlert(e.message)},error:function(e){return Utils.working(!1),Utils.midAlert(e.message),typeof t.error=="function"?t.error(e):void 0}})})},n.prototype.ghostLogin=function(e,t){return Tangerine.log.db("User","ghostLogin"),document.location="http://tangerine.iriscouch.com:5984/uploader/_design/uploader/uploader.html?name="+e+"&pass="+t},n}(Backbone.Model);var LoginView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};LoginView=function(e){function n(){return this.render=__bind(this.render,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="login_view",n.prototype.events={"click button.login":"login","keypress input":"keyHandler"},n.prototype.initialize=function(e){var t=this;return this.i18n(),this.user=Tangerine.user,this.user.on("login",this.goOn),this.user.on("pass-error",function(e){return t.passError(e)}),this.user.on("name-error",function(e){return t.nameError(e)}),$("#watermark").hide()},n.prototype.i18n=function(){return this.text={login:t("LoginView.button.login"),user:t("LoginView.label.user"),teacher:t("LoginView.label.teacher"),enumerator:t("LoginView.label.enumerator"),password:t("LoginView.label.password"),error_name:t("LoginView.message.error_name_empty"),error_pass:t("LoginView.message.error_password_empty")}},n.prototype.goOn=function(){return Tangerine.router.navigate("",!0)},n.prototype.render=function(){var e,t,n;return e=Tangerine.settings.contextualize({server:this.text.user,mobile:this.text.enumerator,klass:this.text.teacher}),n=$("#content").width(),t=$("#content").offsetParent().width(),this.oldWidth=100*n/t,$("#content").css("width","100%"),this.$el.html("      <img src='images/tangerine_logo.png' id='login_logo'>      <label for='name'>"+e+"</label>      <div id='name_message' class='messages'></div>      <input type='text' id='name'>      <label for='pass'>"+this.text.password+"</label>      <div id='pass_message' class='messages'></div>      <input id='pass' type='password'>      <button class='login'>"+this.text.login+"</button>    "),this.nameMsg=this.$el.find("#name_message"),this.passMsg=this.$el.find("#pass_message"),this.trigger("rendered")},n.prototype.onClose=function(){return $("#content").css("width",this.oldWidth+"%"),$("#watermark").show()},n.prototype.keyHandler=function(e){return e.which?e.which!==13?!0:this.login():!0},n.prototype.login=function(e){var t,n;t=this.$el.find("#name"),n=this.$el.find("#pass"),this.clearErrors(),t.val()===""&&this.nameError(this.text.error_name),n.val()===""&&this.passError(this.text.error_pass);if(this.errors===0)return this.user.login(t.val(),n.val())},n.prototype.passError=function(e){return this.errors++,this.passMsg.html(e),this.$el.find("#pass").focus()},n.prototype.nameError=function(e){return this.errors++,this.nameMsg.html(e),this.$el.find("#name").focus()},n.prototype.clearErrors=function(){return this.nameMsg.html(""),this.passMsg.html(""),this.errors=0},n}(Backbone.View);var AccountView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};AccountView=function(e){function t(){return this.renderGroups=__bind(this.renderGroups,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="AccountView",t.prototype.events={"click .leave":"leaveGroup","click .join_cancel":"joinToggle","click .join":"joinToggle","click .join_group":"join","click .back":"goBack","click #mode_buttons input":"changeMode","click .update":"update"},t.prototype.update=function(){return Utils.updateTangerine()},t.prototype.changeMode=function(e){var t,n=this;return t=new Settings({_id:"TangerineSettings"}),t.fetch({success:function(t){return t.set({context:$(e.target).val()}),t.save()}})},t.prototype.goBack=function(){return Tangerine.settings.get("context")==="server"?Tangerine.router.navigate("groups",!0):window.history.back()},t.prototype.joinToggle=function(){return this.$el.find(".join, .join_confirmation").fadeToggle(0),this.$el.find("#group_name").val("")},t.prototype.join=function(){var e,t=this;e=this.$el.find("#group_name").val().databaseSafetyDance();if(e.length===0)return;return this.user.joinGroup(e,function(){return t.joinToggle()})},t.prototype.leaveGroup=function(e){var t;return t=$(e.target).parent().attr("data-group"),this.user.leaveGroup(t)},t.prototype.initialize=function(e){return this.user=e.user,this.user.on("group-join group-leave group-refresh",this.renderGroups)},t.prototype.renderGroups=function(){var e,t,n,r,i;t="<ul>",i=this.user.get("groups")||[];for(n=0,r=i.length;n<r;n++)e=i[n],t+="<li data-group='"+_.escape(e)+"'>"+e+" <button class='command leave'>Leave</button></li>";return t+="</ul>",this.$el.find("#group_wrapper").html(t)},t.prototype.render=function(){var e,t,n,r,i;return Tangerine.settings.get("context")==="server"&&(e="      <section>        <div class='label_value'>          <label>Groups</label>          <div id='group_wrapper'></div>          <button class='command join'>Join or create a group</button>          <div class='confirmation join_confirmation'>            <div class='menu_box'>              <input id='group_name' placeholder='Group name'>              <div class='small_grey'>Please be specific.<br>              Good examples: malawi_jun_2012, mike_test_group_2012, egra_group_aug-2012<br>              Bad examples: group, test, mine</div><br>              <button class='command join_group'>Join Group</button>              <button class='command join_cancel'>Cancel</button>            </div>          </div>        </section>    "),Tangerine.settings.get("context")!=="server"&&(r="<a href='#settings' class='navigation'><button class='navigation'>Settings</button></a>",n="<a href='#logs' class='navigation'><button class='navigation'>Logs</button></a>"),Tangerine.user.isAdmin()&&Tangerine.settings.get("context")!=="server"&&(i="      <button class='command update'>Update Tangerine</button>    "),t="      <button class='back navigation'>Back</button>      <h1>Account</h1>      "+(r||"")+"      "+(n||"")+"<br>      "+(i||"")+"      <section>        <div class='label_value'>          <label>Name</label>          <div>"+this.user.name+"</div>        </div>      </section>      "+(e||"")+"      </div>    ",this.$el.html(t),Tangerine.settings.get("context")==="server"&&this.renderGroups(),this.trigger("rendered")},t}(Backbone.View);var GroupsView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};GroupsView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="GroupsView",t.prototype.events={"click .account":"gotoAccount","click .goto":"gotoGroup"},t.prototype.gotoAccount=function(){return Tangerine.router.navigate("account",!0)},t.prototype.gotoGroup=function(e){var t;return t=$(e.target).attr("data-group"),window.location=Tangerine.settings.urlIndex(t,"assessments")},t.prototype.render=function(){var e,t,n,r,i,s;t=Tangerine.user.get("groups")||[],n="      <button class='account navigation'>Account</button>      <h1>Groups</h1>    ";if(t.length===0)n+="You are not yet a member of a group. Go to Account to join a group.";else for(r=i=0,s=t.length;i<s;r=++i)e=t[r],n+="<button class='command goto' data-group='"+_.escape(e)+"'>"+e+"</button>";return this.$el.html(n),this.trigger("rendered")},t}(Backbone.View);var UsersMenuView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};UsersMenuView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="UsersMenuView",t.prototype.events={"click .admin":"selectAdmin","click .reader":"selectReader","click #add_admin":"addAdmin","click #remove_admin":"removeAdmin","click #add_reader":"addReader","click #remove_reader":"removeReader"},t.prototype.selectAdmin=function(e){return console.log($(e.target).attr("data-name")),this.$el.find("#selected_admin").val($(e.target).attr("data-name"))},t.prototype.selectReader=function(e){return this.$el.find("#selected_reader").val($(e.target).attr("data-name"))},t.prototype.addAdmin=function(){var e;return e=this.$el.find("#selected_admin").val(),this.useRobbert("add_admin",e)},t.prototype.removeAdmin=function(){var e;return e=this.$el.find("#selected_admin").val(),this.useRobbert("remove_admin",e)},t.prototype.addReader=function(){var e;return e=this.$el.find("#selected_reader").val(),this.useRobbert("add_reader",e)},t.prototype.removeReader=function(){var e;return e=this.$el.find("#selected_reader").val(),this.useRobbert("remove_reader",e)},t.prototype.useRobbert=function(e,t){var n=this;return Utils.passwordPrompt(function(r){return Robbert.request({action:e,user:t,group:Tangerine.settings.get("groupName"),auth_u:Tangerine.user.get("name"),auth_p:r,success:function(e){return console.log(e),Utils.midAlert(e.message),Tangerine.user.fetch({success:function(){return n.render()}})},error:function(e){return Utils.midAlert("Server error\n\n"+e[1]+"\n"+e[2]),console.log(arguments)}})})},t.prototype.initialize=function(){},t.prototype.render=function(){var e,t,n,r,i,s,o;return n=Tangerine.user.dbAdmins,o=Tangerine.user.dbReaders,t=function(){var t,r,i;i=[];for(t=0,r=n.length;t<r;t++)e=n[t],i.push("<li data-name='"+_.escape(e)+"' class='admin icon'>"+_.escape(e)+"</li>");return i}().join(""),s=o.length>0?function(){var e,t,n;n=[];for(e=0,t=o.length;e<t;e++)i=o[e],n.push("<li data-name='"+_.escape(i)+"' class='reader icon'>"+_.escape(i)+"</li>");return n}().join(""):"<span class='grey'>No readers yet.</span>",r="      <h1>Users</h1>      <table>      <tr>        <th>Admins</th>        <th>Members</th>      </tr>      <tr>        <td>          <input id='selected_admin'  value=''>          <button id='add_admin' class='command'>+</button>          <button id='remove_admin' class='command'>-</button>        </td>        <td>          <input id='selected_reader' value=''>          <button id='add_reader' class='command'>+</button>          <button id='remove_reader' class='command'>-</button>        </td>      </tr>      <tr>        <td>          <ul id='member_select' multiple='multiple' size='5'>            "+t+"          </ul>        </td>        <td>          <ul id='reader_select' multiple='multiple' size='5'>            "+s+"          </ul>        </td>      </tr>    ",this.$el.html(r)},t}(Backbone.View);var ErrorView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ErrorView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="ErrorView",t.prototype.initialize=function(e){return this.message=e.message,this.details=e.details},t.prototype.render=function(){return this.$el.html("    <h2>Oops</h2>    <p>"+this.message+"</p>    <p>Sorry about that.</p>    <p>"+this.details+"</p>    "),this.trigger("rendered")},t}(Backbone.View);var Breadcrumb,__bind=function(e,t){return function(){return e.apply(t,arguments)}};Breadcrumb=function(){function e(e){this.update=__bind(this.update,this),this.locations=[],this.limit=10,this.router=e,this.router.on("all",this.update)}return e.prototype.update=function(e){var t;t=e.split(":"),this.locations.push(t[Math.min(0,t.length-1)]);if(this.locations.length>10)return this.locations.shift()},e}();var AssessmentPrintView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};AssessmentPrintView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="AssessmentPrintView",t.prototype.initialize=function(e){var t=this;return this.abortAssessment=!1,this.index=0,this.model=e.model,this.format=e.format,Tangerine.activity="assessment print",this.subtestViews=[],this.model.subtests.sort(),this.model.subtests.each(function(e){var n;return n=new SubtestPrintView({model:e,parent:t,format:t.format}),n.on("rendered",function(e){return e!=null?typeof e.afterRender=="function"?e.afterRender():void 0:void 0}),t.subtestViews.push(n)})},t.prototype.render=function(){var e=this;return this.model.subtests.length===0?this.$el.append("<h1>Oops...</h1><p>This assessment is blank. Perhaps you meant to add some subtests.</p>"):(this.$el.addClass("format-"+this.format).append("        <style>          body{            font-size: 100%;          }          #prototype_wrapper .print-page{            size: 11in 8.5in;             height: 11in;            width: 8.5in;            margin: 0;            page-break-after: always;            overflow: hidden;          }          #prototype_wrapper .print-page table{            table-layout: fixed;          }          .format-stimuli table td{            overflow: hidden;            text-align: center;            padding: 1%;            font-family: Andika;          }          .format-stimuli{            font-family: Andika;          }        </style>      "),_.each(this.subtestViews,function(t){return t.render(),e.$el.append(t.el)})),this.trigger("rendered")},t}(Backbone.View);var QuestionPrintView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};QuestionPrintView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.initialize=function(e){this.model=e.model,this.answer={},this.name=this.model.escape("name").replace(/[^A-Za-z0-9_]/g,"-"),this.type=this.model.get("type"),this.options=this.model.get("options"),this.notAsked=e.notAsked,this.isObservation=e.isObservation,this.parent=e.parent,this.model.get("skippable")==="true"||this.model.get("skippable")===!0?(this.isValid=!0,this.skipped=!0):(this.isValid=!1,this.skipped=!1);if(this.notAsked===!0)return this.isValid=!0,this.updateResult()},t.prototype
.update=function(e){return this.updateResult(),this.updateValidity(),this.trigger("answer",e,this.model.get("order"))},t.prototype.render=function(){return this.$el.attr("id","question-"+this.name),this.notAsked?this.$el.hide():(this.parent.format==="stimuli"&&this.$el.html("          <div class='stimuli-question'>"+this.model.get("prompt")+"</div>        "),this.parent.format==="content"&&this.$el.html("          Prompt: "+this.model.get("prompt")+"<br/>          Variable Name: "+this.model.get("name")+"<br/>          Hint: "+this.model.get("hint")+"<br/>          Type: "+this.model.get("type")+"<br/>          Options:<br/>          "+_.map(this.model.get("options"),function(e){return"Label: "+e.label+", Value: "+e.value}).join("<br/>")+"<br/><br/>        ")),this.trigger("rendered")},t}(Backbone.View);var GridPrintView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};GridPrintView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="grid_prototype",t.prototype.initialize=function(e){return this.model=this.options.model,this.parent=this.options.parent},t.prototype.render=function(){switch(this.format){case"content":this.renderContent();break;case"stimuli":this.renderStimuli();break;case"backup":this.renderBackup()}return this.parent.trigger("rendered",this)},t.prototype.renderStimuli=function(){var e,t=this;return this.$el.html("      <div id='"+this.model.get("_id")+"' class='print-page'>        <table>          <caption style='text-align:left;font-style:italic;padding-bottom:10px;color:gray;'>"+this.model.get("name")+"</caption>          <tr>            "+(e=0,_.map(this.model.get("items"),function(n){var r;return e+=1,r="<td class='item'>"+n+"</td>",e%t.model.get("columns")===0&&e!==t.model.get("items").length?r+="</tr><tr>":"",r}).join(""))+"          </tr>        </table>      </div>    "),_.delay(function(){var e,n,r;r=100,n=3;while($("#"+t.model.get("_id"))[0].scrollWidth>$("#"+t.model.get("_id")+" table").innerWidth()&&$("#"+t.model.get("_id"))[0].scrollHeight>$("#"+t.model.get("_id")+" table").innerHeight()){if((r-=1)===0)break;e=$("#"+t.model.get("_id")+" td").css("font-size"),$("#"+t.model.get("_id")+" td").css("font-size",""+(parseInt(e)+n)+"px"),$("#navigation").hide(),$("#footer").hide()}return e=$("#"+t.model.get("_id")+" td").css("font-size"),$("#"+t.model.get("_id")+" td").css("font-size",""+(parseInt(e)-2*n)+"px")},1e3)},t.prototype.renderContent=function(){var e,t=this;return e="autostop    captureAfterSeconds    captureItemAtTime    columns    endOfLine    fontSize    layoutMode    order    randomize    timer    variableName",e=e.split(/\ +/),this.$el.html("      Properties:<br/>      <table>      "+_.map(e,function(e){return"<tr><td>"+e+"</td><td>"+t.model.get(e)+"</td></tr>"}).join("")+"      </table>      Items:<br/>      "+_.map(this.model.get("items"),function(e){return e}).join(", ")+"    ")},t.prototype.renderBackup=function(){var e,t=this;return this.$el.html("      <div id='"+this.model.get("_id")+"' class='print-page'>        <table>          <caption style='text-align:left;font-style:italic;padding-bottom:10px;color:gray;'>"+this.model.get("name")+"</caption>          <tr>            "+(e=0,_.map(this.model.get("items"),function(n){var r;return e+=1,r="<td class='item'>"+n+"</td>",e%t.model.get("columns")===0&&e!==t.model.get("items").length?r+="</tr><tr>":"",r}).join(""))+"          </tr>        </table>      </div>    ")},t}(Backbone.View);var ConsentPrintView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ConsentPrintView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="ConsentPrintView",t.prototype.initialize=function(e){return this.confirmedNonConsent=!1,this.model=this.options.model,this.parent=this.options.parent},t.prototype.render=function(){if(this.format==="stimuli")return;return this.$el.html("    <form>      <div class='question'>        <label>"+(this.model.get("prompt")||"Does the child consent?")+"</label>        <div class='messages'></div>        <div class='non_consent_form confirmation'>          <div>Click to confirm consent not obtained.</div>          <button id='non_consent_confirm'>Confirm</button>        </div>        <div id='consent_options' class='buttonset'>          <label for='consent_yes'>Yes, continue</label>          <input id='consent_yes' type='radio' name='participant_consents' value='yes'>          <label for='consent_no'>No, stop</label>          <input id='consent_no' type='radio' name='participant_consents' value='no'>        </div>      </div>    </form>    "),this.trigger("rendered")},t}(Backbone.View);var DatetimePrintView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};DatetimePrintView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="datetime",t.prototype.initialize=function(e){return this.model=this.options.model,this.parent=this.options.parent},t.prototype.render=function(){if(this.format==="stimuli")return;return this.$el.html("        DateTime      "),this.trigger("rendered")},t}(Backbone.View);var IdPrintView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};IdPrintView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="id",t.prototype.initialize=function(e){},t.prototype.render=function(){if(this.format==="stimuli")return;return this.$el.html("      ID    "),this.trigger("rendered")},t}(Backbone.View);var LocationPrintView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};LocationPrintView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="LocationPrintView",t.prototype.initialize=function(e){this.model=this.options.model,this.parent=this.options.parent,this.levels=this.model.get("levels")||[],this.locations=this.model.get("locations")||[],this.levels.length===1&&this.levels[0]===""&&(this.levels=[]);if(this.locations.length===1&&this.locations[0]==="")return this.locations=[]},t.prototype.render=function(){var e;if(this.format==="stimuli")return;return e="",this.$el.html("      School Locations<br/>      Levels: "+this.levels+"<br/>      Available Locations:<br/>      "+this.locations.join("<br/>")+"<br/>    "),this.trigger("rendered")},t}(Backbone.View);var SurveyPrintView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};SurveyPrintView=function(e){function t(){return this.onQuestionRendered=__bind(this.onQuestionRendered,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="SurveyPrintView",t.prototype.initialize=function(e){var t=this;return this.model=this.options.model,this.parent=this.options.parent,this.isObservation=this.options.isObservation,this.questionViews=[],this.answered=[],this.questions=new Questions,this.questions.fetch({key:this.model.get("assessmentId"),success:function(e){return t.questions=new Questions(t.questions.where({subtestId:t.model.id})),t.questions.sort(),t.render()}})},t.prototype.render=function(){var e,t,n,r,i,s,o,u,a=this;this.$el.html("      <div id='"+this.model.get("_id")+"' class='print-page'>        <div style='font-style:italic;padding-bottom:20px;color:gray;'>"+this.model.get("name")+"</div>        <div class='survey-questions'></div>      </div>      <style>        .survey-questions .stimuli-question{          padding-bottom: 3%;        }      </style>    "),t=0,this.questions.sort();if(this.questions.models!=null){u=this.questions.models;for(e=s=0,o=u.length;s<o;e=++s)r=u[e],n=new QuestionPrintView({model:r,parent:this,isObservation:this.isObservation}),n.on("rendered",this.onQuestionRendered),n.render(),this.questionViews[e]=n,this.$el.find(".survey-questions").append(n.el)}return this.questions.length===t&&typeof (i=this.parent).next=="function"&&i.next(),this.format==="stimuli"&&_.delay(function(){return a.increaseFontUntilOverflow($("#"+a.model.get("_id"))[0],$("#"+a.model.get("_id")+" .survey-questions"))},1e3),this.trigger("rendered")},t.prototype.increaseFontUntilOverflow=function(e,t){var n,r,i;i=100,r=3,n=100;while(e.scrollWidth-1<=$(e).innerWidth()&&e.scrollHeight-1<=$(e).innerHeight()){if((i-=1)===0)break;n+=r,t.css("font-size",n+"%")}return t.css("font-size",n-2*r+"%")},t.prototype.onQuestionRendered=function(){return this.trigger("subRendered")},t}(Backbone.View);var ObservationPrintView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ObservationPrintView=function(e){function t(){return this.saveCurrentSurvey=__bind(this.saveCurrentSurvey,this),this.updateObservationIndex=__bind(this.updateObservationIndex,this),this.checkSurveyDisplay=__bind(this.checkSurveyDisplay,this),this.checkIfOver=__bind(this.checkIfOver,this),this.checkWarning=__bind(this.checkWarning,this),this.checkObservationPace=__bind(this.checkObservationPace,this),this.tick=__bind(this.tick,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="ObservationPrintView",t.prototype.events={"click .start_time":"startObservations","click .stop_time":"stopObservations","click .done":"completeObservation"},t.prototype.initialize=function(e){return this.model=this.options.model,this.parent=this.options.parent},t.prototype.initializeSurvey=function(){var e,t,n;return this.survey!=null&&this.onClose(),e=$.extend(this.model.get("surveyAttributes"),{_id:this.model.id}),n=function(){var n,r,s;s=[];for(t=n=1,r=parseInt(this.model.get("totalSeconds")/this.model.get("intervalLength"));1<=r?n<=r:n>=r;t=1<=r?++n:--n)s.push(new Backbone.Model(e));return s}.call(this),n.unshift(""),this.skippableView=new SurveyRunView({model:n[1],parent:this,isObservation:!0}),this.survey={models:n,results:[]}},t.prototype.initializeFlags=function(){return this.iAm={counting:!1,recording:!1},this.iHavent={warned:!0},this.iHave={runOnce:!1,finished:!1},this.my={time:{start:0,elapsed:0},observation:{index:0,oldIndex:0,completed:0,total:parseInt(this.model.get("totalSeconds")/this.model.get("intervalLength"))}}},t.prototype.startObservations=function(){if(this.iAm.counting||this.iHave.runOnce)return;return this.$el.find(".stop_button_wrapper, .next_display, .completed_display").removeClass("confirmation"),this.$el.find(".start_button_wrapper").addClass("confirmation"),this.timerInterval=setInterval(this.tick,1e3),this.iAm.counting=!0,this.my.time.start=this.getTime(),this.my.time.elapsed=0},t.prototype.stopObservations=function(e){var t,n;return clearInterval(this.timerInterval),t=e!=null,n=e==null,e!=null&&this.trigger("showNext"),n&&!this.iHave.finished?(this.iAm.recording&&(this.resetObservationFlags(),this.saveCurrentSurvey()),this.my.observation.index++,this.renderSurvey()):(this.$el.find(".stop_button_wrapper").addClass("confirmation"),Utils.midAlert("Observations finished")),this.$el.find(".next_display").addClass("confirmation"),this.iHave.finished=!0,this.iHave.runOnce=!0},t.prototype.tick=function(){return this.my.time.elapsed=this.getTime()-this.my.time.start,this.checkIfOver(),this.updateObservationIndex(),this.updateProgressDisplay(),this.checkSurveyDisplay(),this.checkObservationPace(),this.checkWarning()},t.prototype.checkObservationPace=function(){if(this.iAm.recording&&this.my.observation.completed<this.my.observation.index-1&&this.my.observation.index!==0)return this.iHave.forcedProgression=!0,this.resetObservationFlags(),this.saveCurrentSurvey(),this.renderSurvey()},t.prototype.checkWarning=function(){var e,t;t=Math.floor((this.my.time.elapsed+this.warningSeconds)/this.model.get("intervalLength")),e=this.my.observation.index<t&&!this.iHave.finished;if(this.iAm.recording&&this.iHavent.warned&&e&&this.my.observation.index!==0)return Utils.midAlert("Observation ending soon"),this.iHavent.warned=!1},t.prototype.gridWasAutostopped=function(){return!1},t.prototype.checkIfOver=function(){if(this.my.time.elapsed>=this.model.get("totalSeconds"))return this.stopObservations()},t.prototype.checkSurveyDisplay=function(){if(this.my.observation.oldIndex!==this.my.observation.index&&!this.iHave.finished&&!this.iAm.recording)return this.renderSurvey(),this.my.observation.oldIndex=this.my.observation.index},t.prototype.updateObservationIndex=function(){this.my.observation.index=Math.floor(this.my.time.elapsed/this.model.get("intervalLength"));if(this.my.observation.index>this.survey.models.length-1)return this.my.observation.index=this.survey.models.length-1},t.prototype.updateProgressDisplay=function(){var e;this.$el.find(".current_observation").html(this.my.observation.index),this.$el.find(".completed_count").html(this.my.observation.completed),e=Math.max((this.my.observation.index+1)*this.model.get("intervalLength")-this.my.time.elapsed,0),this.$el.find(".time_till_next").html(e);if(!this.iAm.recording&&!this.iHave.finished)return this.$el.find(".next_display, .completed_display").removeClass("confirmation")},t.prototype.resetObservationFlags=function(){return this.iAm.recording=!1,this.iHavent.warned=!0},t.prototype.getTime=function(){return parseInt((new Date).getTime()/1e3)},t.prototype.completeObservation=function(e){return this.survey.view.isValid()?(this.saveCurrentSurvey(),this.iHave.finished&&this.trigger("showNext")):this.survey.view.showErrors(),this.tick()},t.prototype.saveCurrentSurvey=function(){return this.resetObservationFlags(),this.my.observation.completed++,this.survey.results.push({observationNumber:this.survey.view.index,data:this.survey.view.getResult(),saveTime:this.my.time.elapsed}),this.survey.view.close(),this.$el.find(".done").remove()},t.prototype.render=function(){var e;if(this.format==="stimuli")return;return this.trigger("hideNext"),e=this.model.get("totalSeconds"),this.$el.html("      <div class='timer_wrapper'>        <div class='progress clearfix'>          <span class='completed_display confirmation'>Completed <div class='info_box completed_count'>"+this.my.observation.completed+"</div></span>          <span class='next_display confirmation'>Next observation <div class='info_box time_till_next'>"+this.model.get("intervalLength")+"</div></span>        </div>        <div>          <div class='start_button_wrapper'><button class='start_time command'>Start</button></div>          <div class='stop_button_wrapper confirmation'><button class='stop_time command'>Abort <i>all</i> observations</button></div>        </div>      </div>      <div id='current_survey'></div>    "),this.trigger("rendered")},t.prototype.renderSurvey=function(e){var t=this;if(!this.iAm.counting)return;return this.iAm.recording=!0,this.survey.view=new SurveyRunView({model:this.survey.models[this.my.observation.index],parent:this,isObservation:!0}),this.survey.view.index=function(){return t.my.observation.index}(),this.survey.view.on("rendered subRendered",function(){return t.trigger("subRendered")}),this.survey.view.render(),this.$el.find("#current_survey").html("<span class='observation_display confirmation'>Observation <div class='info_box current_observation'>"+this.my.observation.index+"</div></span>"),this.$el.find("#current_survey").append(this.survey.view.el),this.$el.find("#current_survey").append("<button class='command done'>Done with <i>this</i> observation</button>"),this.$el.find("#current_survey").scrollTo(250,function(){if(t.iHave.forcedProgression)return Utils.midAlert("Please continue with the next observation."),t.iHave.forcedProgression=!1;if(t.iHave.finished)return Utils.midAlert("Please enter last observation")})},t.prototype.onClose=function(){var e;return(e=this.survey.view)!=null&&e.close(),this.skippableView.close()},t.prototype.getResult=function(){return{surveys:this.survey.results,variableName:this.model.get("variableName"),totalTime:this.model.get("totalTime"),intervalLength:this.model.get("intervalTime"),completedObservations:this.my.observation.completed}},t.prototype.getSum=function(){return{total:this.my.observation.completed}},t.prototype.getSkipped=function(){var e,t,n,r,i;n=this.skippableView.getSkipped(),t=[];for(e=r=1,i=this.survey.models.length-1;1<=i?r<=i:r>=i;e=1<=i?++r:--r)t.push({observationNumber:e,data:n,saveTime:"skipped"});return{surveys:t,variableName:"skipped",totalTime:"skipped",intervalLength:"skipped",completedObservations:"skipped"}},t.prototype.isValid=function(){return this.iHave.finished},t.prototype.showErrors=function(){return this.$el.find("messages").html(this.validator.getErrors().join(", "))},t.prototype.updateNavigation=function(){return Tangerine.nav.setStudent(this.$el.find("#participant_id").val())},t}(Backbone.View);var SubtestPrintView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};SubtestPrintView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="SubtestPrintView",t.prototype.initialize=function(e){return this.protoViews=Tangerine.config.prototypeViews,this.model=e.model,this.parent=e.parent,this.format=e.format,this.prototypeRendered=!1},t.prototype.render=function(){var e,t,n,r,i=this;return e=(this.model.get("enumeratorHelp")||"")!==""?"<div class='enumerator_help_print'>"+this.model.get("enumeratorHelp")+"</div>":"",r=(this.model.get("studentDialog")||"")!==""?"<div class='student_dialog_print'>"+this.model.get("studentDialog")+"</div>":"",t="<button class='skip navigation'>Skip</button>",n=this.model.getBoolean("skippable"),this.format==="content"?this.$el.html("        <h2>"+this.model.get("name")+"</h2>        Enumerator Help:<br/>        "+e+"        Student Dialog:<br/>        "+r+"        <div class='format-"+this.format+"' id='prototype_wrapper'></div>        <hr/>      "):this.$el.append("        <div id='prototype_wrapper'></div>      "),this.prototypeView=new(window[this.model.get("prototype").humanize()+"PrintView"])({model:this.model,parent:this}),this.prototypeView.on("rendered",function(){return i.trigger("rendered")}),this.prototypeView.on("subRendered",function(){return i.trigger("subRendered")}),this.prototypeView.setElement(this.$el.find("#prototype_wrapper")),this.prototypeView.format=this.format,this.prototypeView.render(),this.prototypeRendered=!0,this.trigger("rendered")},t}(Backbone.View);var Log,LogView,Logs,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__bind=function(e,t){return function(){return e.apply(t,arguments)}};Log=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="log",t.prototype.app=function(e,t){e==null&&(e=""),t==null&&(t="");if(Tangerine.settings.get("context")==="server")return;if(!~Tangerine.settings.get("log").indexOf("app"))return;return this.add({type:"app",code:e,details:t,timestamp:(new Date).getTime()})},t.prototype.db=function(e,t){e==null&&(e=""),t==null&&(t="");if(Tangerine.settings.get("context")==="server")return;if(!~Tangerine.settings.get("log").indexOf("db"))return;return this.add({type:"db",code:e,details:t,timestamp:(new Date).getTime()})},t.prototype.ui=function(e,t){e==null&&(e=""),t==null&&(t="");if(Tangerine.settings.get("context")==="server")return;if(!~Tangerine.settings.get("log").indexOf("ui"))return;return this.add({type:"ui",code:e,details:t,timestamp:(new Date).getTime()})},t.prototype.err=function(e,t){e==null&&(e=""),t==null&&(t="");if(Tangerine.settings.get("context")==="server")return;return!~Tangerine.settings.get("log").indexOf("err")},t.prototype.add=function(e){var t,n;return t=new Date,n="not-signed-in",Tangerine.user.name!=null&&(n=Tangerine.user.name),this.unset("_rev"),this.save({_id:this.calcName(),year:t.getFullYear(),month:t.getMonth(),date:t.getDate(),timestamp:t.getTime(),user:n,event:e})},t.prototype.calcName=function(){var e,t;return e=new Date,t="not-signed-in",Tangerine.user.name!=null&&(t=Tangerine.user.name),hex_sha1(""+t+"_"+e.getTime())},t}(Backbone.Model),Logs=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="log",t.prototype.model=Log,t.prototype.comparator=function(e){return e.get("timestamp")},t}(Backbone.Collection),LogView=function(e){function t(){return this.render=__bind(this.render,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.className="LogView",t.prototype.initialize=function(e){return this.logs=e.logs},t.prototype.render=function(){var e,t=this;return e="      <h1>Logs</h1>      <table><tr>        <th>User</th>        <th>Code</th>        <th>Details</th>        <th>Time</th>      </tr>      ",this.logs.each(function(t){var n,r,i,s,o;if(t.get("event")==null)return;return i=t.get("event"),s=t.get("user"),n=i.code,r=i.details,o=(new Date(parseInt(i.timestamp))).toString(),e+="      <tr>        <td>"+s+"</td>        <td>"+n+"</td>        <td>"+r+"</td>        <td>"+o+"</td>      </tr>      "}),this.$el.html(e),this.trigger("rendered")},t}(Backbone.View);var Template,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Template=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="template",t}(Backbone.Model);var Config,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Config=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="config",t.prototype.save=null,t.prototype.getDefault=function(e){return this.get("defaults")[e]},t}(Backbone.Model);var Settings,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Settings=function(e){function t(){return this.update=__bind(this.update,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url="settings",t.prototype.initialize=function(){var e=this;return this.config=Tangerine.config,this.on("all",function(){return e.update()})},t.prototype.contextualize=function(e){e==null&&(e={});if(this.get("context")==="server"){if(_.isFunction(e.server))return e.server();if(e.server!=null)return e.server}else if(this.get("context")==="mobile"){if(_.isFunction(e.mobile))return e.mobile();if(e.mobile!=null)return e.mobile}else if(this.get("context")==="class"){if(_.isFunction(e.klass))return e.klass();if(e.klass!=null)return e.klass}},t.prototype.update=function(){var e,t,n,r,i,s,o,u,a,f,l,c;return n=this.get("groupHost"),r=this.get("groupName"),t=this.get("groupDDoc"),this.upUser="uploader-"+r,this.upPass=this.get("upPass"),l=this.config.get("update"),f=this.config.get("trunk"),i=this.config.get("local"),s=this.config.get("port"),e=Tangerine.design_doc,o=this.config.get("groupDBPrefix"),this.groupDB=""+o+r,this.trunkDB=f.dbName,a=this.config.get("subnet").base,Tangerine.settings.get("context")!=="server"&&(u=n.split("://"),n=""+u[0]+"://"+this.upUser+":"+this.upPass+"@"+u[1]),this.location={local:{url:""+i.host+":"+s+"/",db:"/"+i.dbName+"/"},trunk:{url:"http://"+f.host+"/",db:"http://"+f.host+"/"+f.dbName+"/"},group:{url:""+n+"/",db:""+n+"/"+o+r+"/"},update:{url:"http://"+l.host+"/",db:"http://"+l.host+"/"+l.dbName+"/",target:l.target},subnet:{url:function(){var e,t;t=[];for(c=e=0;e<=255;c=++e)t.push("http://"+a+c+":"+s+"/");return t}(),db:function(){var e,t;t=[];for(c=e=0;e<=255;c=++e)t.push("http://"+a+c+":"+s+"/"+i.dbName+"/");return t}()},satellite:{url:function(){var e,t;t=[];for(c=e=0;e<=255;c=++e)t.push(""+a+c+":"+s+"/");return t}(),db:function(){var e,t;t=[];for(c=e=0;e<=255;c=++e)t.push(""+a+c+":"+s+"/"+o+r+"/");return t}()}},this.couch={view:"_design/"+e+"/_view/",show:"_design/"+e+"/_show/",list:"_design/"+e+"/_list/",index:"_design/"+e+"/index.html"},this.groupCouch={view:"_design/"+t+"/_view/",show:"_design/"+t+"/_show/",list:"_design/"+t+"/_list/",index:"_design/"+t+"/index.html"}},t.prototype.urlIndex=function(e,t){var n,r;return t==null&&(t=null),n=this.get("groupHost"),r=e==="local"?":"+this.config.get("port"):"",t=t!=null?"#"+t:"",e==="trunk"?e="tangerine":e=this.config.get("groupDBPrefix")+e,""+n+r+"/"+e+"/"+this.couch.index+t},t.prototype.urlHost=function(e){return""+this.location[e].url},t.prototype.urlDB=function(e,t){var n,r;return t==null&&(t=null),e==="local"?n=(""+this.location[e].db).slice(1,-1):n=(""+this.location[e].db).slice(0,-1),r=n.split("://"),t!=null&&(n=""+r[0]+"://"+Tangerine.user.name+":"+t+"@"+r[1]),n},t.prototype.urlDDoc=function(e){var t;return t=Tangerine.designDoc,""+this.urlDB("trunk")+"/_design/"+t},t.prototype.urlView=function(e,t){return e==="group"||Tangerine.settings.get("context")==="server"?""+this.location[e].db+this.groupCouch.view+t:""+this.location[e].db+this.couch.view+t},t.prototype.urlList=function(e,t){return e==="group"||Tangerine.settings.get("context")==="server"?""+this.location[e].db+this.groupCouch.list+t:""+this.location[e].db+this.couch.list+t},t.prototype.urlShow=function(e,t){return e==="group"||Tangerine.settings.get("context")==="server"?""+this.location[e].db+this.groupCouch.show+t:""+this.location[e].db+this.couch.show+t},t.prototype.urlSubnet=function(e){var t,n;return n=this.config.get("port"),t=this.config.get("local").dbName,"http://"+e+":"+n+"/"+t},t.prototype.subnetIP=function(e){var t;return t=this.config.get("subnet").base,""+t+e},t}(Backbone.Model);var SettingsView,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};SettingsView=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="SettingsView",n.prototype.events={"click .save":"save","click .back":"goBack"},n.prototype.goBack=function(){return window.history.back()},n.prototype.initialize=function(e){return this.settings=Tangerine.settings},n.prototype.save=function(){var e=this;return this.settings.save({context:this.$el.find("#context").val(),language:this.$el.find("#language").val(),groupName:this.$el.find("#group_name").val(),groupHost:this.$el.find("#group_host").val(),upPass:this.$el.find("#up_pass").val(),log:this.$el.find("#log").val().split(/[\s,]+/)},{success:function(){return Utils.midAlert("Settings saved")},error:function(){return Utils.midAlert("Error. Settings weren't saved")}})},n.prototype.render=function(){var e,n,r,i,s,o;return e=this.settings.escape("context"),i=this.settings.escape("language"),r=this.settings.escape("groupName"),n=this.settings.escape("groupHost"),o=this.settings.escape("upPass"),s=_.escape(this.settings.getArray("log").join(", ")),this.$el.html("    <button class='back navigation'>Back</button>    <h1>"+t("settings")+"</h1>    <p><img src='images/icon_warn.png' title='Warning'>Please be careful with the following settings.</p>    <div class='menu_box'>      <div class='label_value'>        <label for='context'>Context</label><br>        <input id='context' type='text' value='"+e+"'>      </div>      <div class='label_value'>        <label for='language'>Language code</label><br>        <input id='language' type='text' value='"+i+"'>      </div>      <div class='label_value'>        <label for='group_name'>Group name</label><br>        <input id='group_name' type='text' value='"+r+"'>      </div>      <div class='label_value'>        <label for='group_host'>Group host</label><br>        <input id='group_host' type='text' value='"+n+"'>      </div>      <div class='label_value'>        <label for='up_pass'>Upload password</label><br>        <input id='up_pass' type='text' value='"+o+"'>      </div>      <div class='label_value'>        <label for='log' title='app, ui, db, err'>Log events</label><br>        <input id='log' value='"+s+"'>      </div>    </div><br>        <button class='command save'>Save</button>    "),this.trigger("rendered")},n}(Backbone.View);var ViewManager,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};ViewManager=function(e){function t(){return this.show=__bind(this.show,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.show=function(e){var t,n=this;return window.scrollTo(0,0),(t=this.currentView)!=null&&t.close(),this.currentView=e,this.className=this.currentView.className,Tangerine.log.app("show",this.className),this.currentView.on("click",function(){return console.log(arguments)}),this.currentView.on("rendered",function(){var e;return Utils.working(!1),$("#content").append(n.currentView.el),n.currentView.$el.find(".buttonset").buttonset(),typeof (e=n.currentView).afterRender=="function"?e.afterRender():void 0}),this.currentView.on("subRendered",function(){return n.currentView.$el.find(".buttonset").buttonset()}),this.currentView.on("start_work",function(){return Utils.working(!0)}),this.currentView.on("end_work",function(){return Utils.working(!1)}),this.currentView.render()},t}(Backbone.View);var NavigationView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};NavigationView=function(e){function n(){return this.handleMenu=__bind(this.handleMenu,this),this.initialize=__bind(this.initialize,this),this.calcWhoAmI=__bind(this.calcWhoAmI,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.el="#navigation",n.prototype.events=Modernizr.touch?{"touchstart div#logout_link":"logout","touchstart button":"submenuHandler","touchstart #corner_logo":"logoClick","touchstart #enumerator":"enumeratorClick"}:{"click div#logout_link":"logout","click button":"submenuHandler","click #corner_logo":"logoClick","click #enumerator":"enumeratorClick"},n.prototype.calcWhoAmI=function(){return this.whoAmI=Tangerine.settings.contextualize({server:this.text.user,mobile:this.text.enumerator,klass:this.text.teacher})},n.prototype.enumeratorClick=function(){if(this.user.isAdmin())return Tangerine.router.navigate("account",!0)},n.prototype.logoClick=function(){if(this.user.isAdmin())return Tangerine.activity="",this.router.navigate("",!0);if(Tangerine.activity!=="assessment run")return this.router.navigate("",!0);if(confirm(this.text.incomplete_main))return Tangerine.activity="",this.router.navigate("",!0)},n.prototype.logout=function(){if(this.user.isAdmin()||Tangerine.settings.get("context")==="server")return Tangerine.activity="",Tangerine.user.logout();if(Tangerine.activity==="assessment run"){if(confirm(this.text.incomplete_logout))return Tangerine.activity=""
,Tangerine.user.logout()}else if(confirm(this.text.confirm_logout))return Tangerine.activity="",Tangerine.user.logout()},n.prototype.onClose=function(){},n.prototype.initialize=function(e){return this.i18n(),this.render(),this.user=e.user,this.router=e.router,this.calcWhoAmI(),this.router.on("all",this.handleMenu),this.user.on("login logout",this.handleMenu)},n.prototype.i18n=function(){return this.text={logout:t("NavigationView.button.logout"),user:t("NavigationView.label.user"),teacher:t("NavigationView.label.teacher"),enumerator:t("NavigationView.label.enumerator"),student_id:t("NavigationView.label.student_id"),version:t("NavigationView.label.version"),account:t("NavigationView.help.account"),logo:t("NavigationView.help.logo"),incomplete_logout:t("NavigationView.message.incomplete_logout"),confirm_logout:t("NavigationView.message.logout_confirm"),incomplete_main:t("NavigationView.message.incomplete_main")}},n.prototype.submenuHandler=function(e){var t;return typeof (t=vm.currentView).submenuHandler=="function"?t.submenuHandler(e):void 0},n.prototype.closeSubmenu=function(){return this.$el.find("main_nav").empty()},n.prototype.render=function(){return this.$el.html("    <img id='corner_logo' src='images/corner_logo.png' title='"+this.text.logo+"'>    <div id='logout_link'>"+this.text.logout+"</div>    <div id='enumerator_box'>      <span id='enumerator_label' title='"+this.text.account+"'>"+this.whoAmI+"</span>      <div id='enumerator'>"+(Tangerine.user.name||"")+"</div>    </div>    <div id='current_student'>      "+this.text.student_id+"      <div id='current_student_id'></div>    </div>    <div id='version'>      "+this.text.version+" <br>      <span id='version-uuid'>"+Tangerine.version+"</span><br>    </div>    "),$("body").ajaxStart(function(){return $("#corner_logo").attr("src","images/spin_orange.gif")}),$("body").ajaxStop(function(){return $("#corner_logo").attr("src","images/corner_logo.png")})},n.prototype.setStudent=function(e){return e===""?(this.$el.find("#current_student_id").fadeOut(250,function(e){return $(e).html("")}),this.$el.find("#current_student").fadeOut(250)):this.$el.find("#current_student_id").html(e).parent().fadeIn(250)},n.prototype.handleMenu=function(e){var t=this;return this.calcWhoAmI(),$("#enumerator_label").html(this.whoAmI),$("#enumerator").html(this.user.name),~window.location.toString().indexOf("name=")?this.$el.find("#logout_link").hide():this.$el.find("#logout_link").show(),this.user.verify({isRegistered:function(){return t.render(),$("#navigation").fadeIn(250)},isUnregistered:function(){return t.render(),$("#navigation").fadeOut(250)}})},n}(Backbone.View);var Router,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Router=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.routes={login:"login",register:"register",logout:"logout",account:"account",transfer:"transfer",settings:"settings",update:"update","":"landing",logs:"logs","class":"klass","class/edit/:id":"klassEdit","class/student/:studentId":"studentEdit","class/student/report/:studentId":"studentReport","class/subtest/:id":"editKlassSubtest","class/question/:id":"editKlassQuestion","class/:id/:part":"klassPartly","class/:id":"klassPartly","class/run/:studentId/:subtestId":"runSubtest","class/result/student/subtest/:studentId/:subtestId":"studentSubtest",curricula:"curricula","curriculum/:id":"curriculum",curriculumImport:"curriculumImport","report/klassGrouping/:klassId/:part":"klassGrouping","report/masteryCheck/:studentId":"masteryCheck","report/progress/:studentId/:klassId":"progressReport",groups:"groups",assessments:"assessments","run/:id":"run","print/:id/:format":"print","resume/:assessmentId/:resultId":"resume","restart/:id":"restart","edit/:id":"edit","results/:name":"results","import":"import","subtest/:id":"editSubtest","question/:id":"editQuestion",dashboard:"dashboard","dashboard/*options":"dashboard",admin:"admin"},t.prototype.admin=function(e){return Tangerine.user.verify({isAdmin:function(){var e;return e=new AdminView,vm.show(e)}})},t.prototype.dashboard=function(e){var t,n;return e=e!=null?e.split(/\//):void 0,t={assessment:"All",groupBy:"enumerator"},_.each(e,function(n,r){if(!(r%2))return t[n]=e[r+1]}),n=new DashboardView,n.options=t,vm.show(n)},t.prototype.landing=function(){if(Tangerine.settings.get("context")==="server")return~String(window.location.href).indexOf("tangerine/_design")?Tangerine.router.navigate("groups",!0):Tangerine.router.navigate("assessments",!0);if(Tangerine.settings.get("context")==="mobile")return Tangerine.router.navigate("assessments",!0);if(Tangerine.settings.get("context")==="class")return Tangerine.router.navigate("class",!0)},t.prototype.groups=function(){return Tangerine.user.verify({isRegistered:function(){var e;return e=new GroupsView,vm.show(e)}})},t.prototype.curricula=function(){return Tangerine.user.verify({isRegistered:function(){var e;return e=new Curricula,e.fetch({success:function(e){var t;return t=new CurriculaView({curricula:e}),vm.show(t)}})}})},t.prototype.curriculum=function(e){return Tangerine.user.verify({isRegistered:function(){var t;return t=new Curriculum({_id:e}),t.fetch({success:function(){var n;return n=new Subtests,n.fetch({success:function(){var r,i;return r=new Subtests(n.where({curriculumId:e})),i=new CurriculumView({curriculum:t,subtests:r}),vm.show(i)}})}})}})},t.prototype.curriculumEdit=function(e){return Tangerine.user.verify({isRegistered:function(){var t;return t=new Curriculum({_id:e}),t.fetch({success:function(){var n;return n=new Subtests,n.fetch({success:function(){var r,i,s,o,u;return o=n.where({curriculumId:e}),r=function(){var e,t,n;n=[];for(e=0,t=o.length;e<t;e++)s=o[e],n.push(s.get("part"));return n}(),i=Math.max.apply(Math,r),u=new CurriculumView({curriculum:t,subtests:o,parts:i}),vm.show(u)}})}})}})},t.prototype.curriculumImport=function(){return Tangerine.user.verify({isRegistered:function(){var e;return e=new AssessmentImportView({noun:"curriculum"}),vm.show(e)}})},t.prototype.klass=function(){return Tangerine.user.verify({isRegistered:function(){var e;return e=new Klasses,e.fetch({success:function(e){var t;return t=new Teachers,t.fetch({success:function(){var n;return n=new Curricula,n.fetch({success:function(n){var r;return Tangerine.user.isAdmin()||(e=new Klasses(e.where({teacherId:Tangerine.user.get("teacherId")}))),r=new KlassesView({klasses:e,curricula:n,teachers:t}),vm.show(r)}})}})}})}})},t.prototype.klassEdit=function(e){return Tangerine.user.verify({isRegistered:function(){var t;return t=new Klass({_id:e}),t.fetch({success:function(t){var n;return n=new Teachers,n.fetch({success:function(){var r;return r=new Students,r.fetch({success:function(r){var i,s;return i=new Students(r.where({klassId:e})),s=new KlassEditView({klass:t,students:i,allStudents:r,teachers:n}),vm.show(s)}})}})}})}})},t.prototype.klassPartly=function(e,t){return t==null&&(t=null),Tangerine.user.verify({isRegistered:function(){var n;return n=new Klass({_id:e}),n.fetch({success:function(){var r;return r=new Curriculum({_id:n.get("curriculumId")}),r.fetch({success:function(){var i;return i=new Students,i.fetch({success:function(i){var s,o;return o=new Students(i.where({klassId:e})),s=new KlassResults,s.fetch({success:function(i){var s,u;return u=new KlassResults(i.where({klassId:e})),s=new Subtests,s.fetch({success:function(e){var i,s;return i=new Subtests(e.where({curriculumId:n.get("curriculumId")})),s=new KlassPartlyView({part:t,subtests:i,results:u,students:o,curriculum:r,klass:n}),vm.show(s)}})}})}})}})}})}})},t.prototype.studentSubtest=function(e,t){return Tangerine.user.verify({isRegistered:function(){var n;return n=new Student({_id:e}),n.fetch({success:function(){var r;return console.log(n),console.log(e),r=new Subtest({_id:t}),r.fetch({success:function(){var i=this;return Tangerine.$db.view("tangerine/resultsByStudentSubtest",{key:[e,t],success:function(i){var s;return s=new KlassResults,s.fetch({success:function(s){var o,u;return o=s.where({subtestId:t,studentId:e,klassId:n.get("klassId")}),u=new KlassSubtestResultView({results:o,subtest:r,student:n,previous:i.rows.length}),vm.show(u)}})}})}})}})}})},t.prototype.runSubtest=function(e,t){return Tangerine.user.verify({isRegistered:function(){var n;return n=new Subtest({_id:t}),n.fetch({success:function(){var r;return r=new Student({_id:e}),r.fetch({success:function(){var i,s,o=this;return i=function(e,t,n,r){var i;return n==null&&(n=null),r==null&&(r={}),i=new KlassSubtestRunView({student:e,subtest:t,questions:s,linkedResult:r}),vm.show(i)},s=null,n.get("prototype")==="survey"?Tangerine.$db.view("tangerine/resultsByStudentSubtest",{key:[e,n.get("gridLinkId")],success:function(e){var o,u;return e.rows!==0&&(o=new KlassResult((u=_.last(e.rows))!=null?u.value:void 0)),s=new Questions,s.fetch({key:n.get("curriculumId"),success:function(){return s=new Questions(s.where({subtestId:t})),i(r,n,s,o)}})}}):i(r,n)}})}})}})},t.prototype.register=function(){return Tangerine.user.verify({isUnregistered:function(){var e;return e=new RegisterTeacherView({user:new User}),vm.show(e)},isRegistered:function(){return Tangerine.router.navigate("",!0)}})},t.prototype.studentEdit=function(e){return Tangerine.user.verify({isRegistered:function(){var t;return t=new Student({_id:e}),t.fetch({success:function(e){var t;return t=new Klasses,t.fetch({success:function(t){var n;return n=new StudentEditView({student:e,klasses:t}),vm.show(n)}})}})}})},t.prototype["import"]=function(){return Tangerine.user.verify({isRegistered:function(){var e;return e=new AssessmentImportView({noun:"assessment"}),vm.show(e)}})},t.prototype.assessments=function(){return Tangerine.user.verify({isRegistered:function(){var e;return e=new Assessments,e.fetch({success:function(e){var t;return t=new Curricula,t.fetch({success:function(t){return e=new AssessmentsMenuView({assessments:e,curricula:t}),vm.show(e)}})}})}})},t.prototype.editId=function(e){return e=Utils.cleanURL(e),Tangerine.user.verify({isAdmin:function(){var t;return t=new Assessment({_id:e}),t.superFetch({success:function(e){var t;return t=new AssessmentEditView({model:e}),vm.show(t)}})},isUser:function(){return Tangerine.router.navigate("",!0)}})},t.prototype.edit=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return t=new Assessment({_id:e}),t.fetch({success:function(e){var t;return t=new AssessmentEditView({model:e}),vm.show(t)}})},isUser:function(){return Tangerine.router.navigate("",!0)}})},t.prototype.restart=function(e){return Tangerine.router.navigate("run/"+e,!0)},t.prototype.run=function(e){return Tangerine.user.verify({isRegistered:function(){var t;return t=new Assessment({_id:e}),t.fetch({success:function(e){var t;return t=new AssessmentRunView({model:e}),vm.show(t)}})}})},t.prototype.print=function(e,t){return Tangerine.user.verify({isRegistered:function(){var n;return n=new Assessment({_id:e}),n.fetch({success:function(e){var n;return n=new AssessmentPrintView({model:e,format:t}),vm.show(n)}})}})},t.prototype.resume=function(e,t){return Tangerine.user.verify({isRegistered:function(){var n;return n=new Assessment({_id:e}),n.fetch({success:function(e){var n;return n=new Result({_id:t}),n.fetch({success:function(t){var n,r,i,s,o,u;i=new AssessmentRunView({model:e}),t.has("order_map")&&(n=t.get("order_map").slice(),i.orderMap=n),u=t.get("subtestData");for(s=0,o=u.length;s<o;s++)r=u[s],r.data.participant_id!=null&&Tangerine.nav.setStudent(r.data.participant_id);return i.result=t,i.subtestViews.pop(),i.subtestViews.push(new ResultView({model:t,assessment:e,assessmentView:i})),i.index=t.get("subtestData").length,vm.show(i)}})}})}})},t.prototype.results=function(e){return Tangerine.user.verify({isRegistered:function(){var t;return t=new Assessment({_id:e}),t.fetch({success:function(){var n,r=this;return n=new Results,n.fetch({include_docs:!1,key:e,success:function(e){var n;return n=new ResultsView({assessment:t,results:e.models}),vm.show(n)}})}})}})},t.prototype.csv=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return t=new CSVView({assessmentId:e}),vm.show(t)}})},t.prototype.csv_alpha=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return t=new Assessment({_id:e}),t.fetch({success:function(){var n;return n=t.get("name")+"-"+moment().format("YYYY-MMM-DD HH:mm"),document.location="/"+Tangerine.dbName+"/_design/"+Tangerine.designDoc+('/_list/csv/csvRowByResult?key="'+e+'"&filename='+n)}})},isUser:function(){var e;return e=new ErrorView({message:"You're not an admin user",details:"How did you get here?"}),vm.show(e)}})},t.prototype.klassGrouping=function(e,t){return t=parseInt(t),Tangerine.user.verify({isRegistered:function(){var n;return n=new Subtests,n.fetch({success:function(n){var r,i;return i=new Subtests(n.where({part:t})),r=new KlassResults,r.fetch({success:function(t){var n;return t=new KlassResults(t.where({klassId:e})),n=new Students,n.fetch({success:function(){var r;return n=new Students(n.where({klassId:e})),r=new KlassGroupingView({students:n,subtests:i,results:t}),vm.show(r)}})}})}})}})},t.prototype.masteryCheck=function(e){return Tangerine.user.verify({isRegistered:function(){var t;return t=new Student({_id:e}),t.fetch({success:function(t){var n,r;return r=t.get("klassId"),n=new Klass({_id:t.get("klassId")}),n.fetch({success:function(n){var i;return i=new KlassResults,i.fetch({success:function(i){var s,o,u,a,f,l,c,h,p,d;o=new KlassResults(i.where({studentId:e,reportType:"mastery",klassId:r})),f={},d=o.models;for(l=0,h=d.length;l<h;l++)s=d[l],f[s.get("subtestId")]=!0;f=_.keys(f),u=new Subtests;for(c=0,p=f.length;c<p;c++)a=f[c],u.add(new Subtest({_id:a}));return u.fetch({success:function(){var e;return e=new MasteryCheckView({student:t,results:o,klass:n,subtests:u}),vm.show(e)}})}})}})}})}})},t.prototype.progressReport=function(e,t){return Tangerine.user.verify({isRegistered:function(){var n,r;return n=function(e){var n;return n=new Klass({_id:t}),n.fetch({success:function(n){var r;return r=new Subtests,r.fetch({success:function(r){var i,s;return s=new Subtests(r.where({curriculumId:n.get("curriculumId"),reportType:"progress"})),i=new KlassResults,i.fetch({success:function(r){var i,o;return i=new KlassResults(r.where({klassId:t,reportType:"progress"})),o=new ProgressView({subtests:s,student:e,results:i,klass:n}),vm.show(o)}})}})}})},e!=="all"?(r=new Student({_id:e}),r.fetch({success:n})):n(null)}})},t.prototype.editSubtest=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return e=Utils.cleanURL(e),t=new Subtest({_id:e}),t.fetch({success:function(e,n){var r;return r=new Assessment({_id:t.get("assessmentId")}),r.fetch({success:function(){var t;return t=new SubtestEditView({model:e,assessment:r}),vm.show(t)}})}})},isUser:function(){return Tangerine.router.navigate("",!0)}})},t.prototype.editKlassSubtest=function(e){var t;return t=function(e,t,n){var r;return n==null&&(n=null),r=new KlassSubtestEditView({model:e,curriculum:t,questions:n}),vm.show(r)},Tangerine.user.verify({isAdmin:function(){var n;return e=Utils.cleanURL(e),n=new Subtest({_id:e}),n.fetch({success:function(){var e;return e=new Curriculum({_id:n.get("curriculumId")}),e.fetch({success:function(){var r;return n.get("prototype")==="survey"?(r=new Questions,r.fetch({key:e.id,success:function(){return r=new Questions(r.where({subtestId:n.id})),t(n,e,r)}})):t(n,e)}})}})},isUser:function(){return Tangerine.router.navigate("",!0)}})},t.prototype.editQuestion=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return e=Utils.cleanURL(e),t=new Question({_id:e}),t.fetch({success:function(e,t){var n;return n=new Assessment({_id:e.get("assessmentId")}),n.fetch({success:function(){var t;return t=new Subtest({_id:e.get("subtestId")}),t.fetch({success:function(){var r;return r=new QuestionEditView({question:e,subtest:t,assessment:n}),vm.show(r)}})}})}})},isUser:function(){return Tangerine.router.navigate("",!0)}})},t.prototype.editKlassQuestion=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return e=Utils.cleanURL(e),t=new Question({_id:e}),t.fetch({success:function(e,t){var n;return n=new Curriculum({_id:e.get("curriculumId")}),n.fetch({success:function(){var t;return t=new Subtest({_id:e.get("subtestId")}),t.fetch({success:function(){var r;return r=new QuestionEditView({question:e,subtest:t,assessment:n}),vm.show(r)}})}})}})}})},t.prototype.login=function(){return Tangerine.user.verify({isRegistered:function(){return Tangerine.router.navigate("",!0)},isUnregistered:function(){var e;return e=new LoginView,vm.show(e)}})},t.prototype.logout=function(){return Tangerine.user.logout()},t.prototype.account=function(){return Tangerine.settings.get("context")==="server"&&Tangerine.db_name!=="tangerine"?window.location=Tangerine.settings.urlIndex("trunk","account"):Tangerine.user.verify({isRegistered:function(){var e;return e=new AccountView({user:Tangerine.user}),vm.show(e)}})},t.prototype.settings=function(){return Tangerine.user.verify({isRegistered:function(){var e;return e=new SettingsView,vm.show(e)}})},t.prototype.logs=function(){return Tangerine.user.verify({isRegistered:function(){var e,t=this;return e=new Logs,e.fetch({success:function(){var t;return t=new LogView({logs:e}),vm.show(t)}})}})},t.prototype.transfer=function(){var e,t,n=this;return e=Utils.$_GET(),t=e.name,$.couch.logout({success:function(){return $.cookie("AuthSession",null),$.couch.login({name:t,password:t,success:function(){return Tangerine.router.navigate(""),window.location.reload()},error:function(){return $.couch.signup({name:t,roles:["_admin"]},t,{success:function(){var e;return e=new User,e.save({name:t,id:"tangerine.user:"+t,roles:[],from:"tc"},{wait:!0,success:function(){return $.couch.login({name:t,password:t,success:function(){return Tangerine.router.navigate(""),window.location.reload()},error:function(){var e;return e=new ErrorView({message:"There was a username collision",details:""}),vm.show(e)}})}})}})}})}})},t}(Backbone.Router);var Tangerine;Tangerine={db_name:window.location.pathname.split("/")[1],design_doc:_.last(String(window.location).split("_design/")).split("/")[0]},Tangerine.$db=$.couch.db(Tangerine.db_name),Backbone.couch_connector.config.db_name=Tangerine.db_name,Backbone.couch_connector.config.ddoc_name=Tangerine.design_doc,Backbone.couch_connector.config.global_changes=!1,_.templateSettings={interpolate:/\{\{(.+?)\}\}/g},Tangerine.config=new Config({_id:"configuration"}),Tangerine.config.fetch({error:function(){return console.log("could not fetch configuration"),console.log(arguments)},success:function(){return Tangerine.settings=new Settings({_id:"settings"}),Tangerine.settings.fetch({success:function(){return Tangerine.onSettingsLoad()},error:function(){return Tangerine.settings.set(Tangerine.config.getDefault("settings")),Tangerine.settings.save(null,{error:function(){return console.log("couldn't save new settings"),console.log(arguments)},success:function(){return Tangerine.onSettingsLoad()}})}})}}),Tangerine.onSettingsLoad=function(){return Tangerine.templates=new Template({_id:"templates"}),Tangerine.templates.fetch({success:function(){return Tangerine.ensureAdmin(function(){return $(function(){return window.vm=new ViewManager,$.i18n.init({lng:Tangerine.settings.get("language"),resGetPath:"locales/__lng__/translation.json"},function(e){return window.t=e,Tangerine.settings.get("context")!=="server"&&document.addEventListener("deviceready",function(){return document.addEventListener("online",function(){return Tangerine.online=!0}),document.addEventListener("offline",function(){return Tangerine.online=!1}),document.addEventListener("backbutton",function(n){return Tangerine.activity==="assessment run"?confirm(e("NavigationView.msg.incomplete_main_screen"))?(Tangerine.activity="",window.history.back()):!1:window.history.back()},!1)},!1),Tangerine.router=new Router,Tangerine.user=new User,Tangerine.nav=new NavigationView({user:Tangerine.user,router:Tangerine.router}),Tangerine.log=new Log,Tangerine.user.sessionRefresh({success:function(){return Backbone.history.start()}})})})})}})},Tangerine.ensureAdmin=function(e){return Tangerine.settings.get("context")!=="server"&&!Tangerine.settings.has("adminEnsured")?$.couch.login({name:"admin",password:"password",success:function(){var t=this;return $.couch.userDb(function(t){return t.openDoc("org.couchdb.user:admin",{success:function(){return $.couch.logout({success:function(){return Tangerine.settings.save({adminEnsured:!0}),e()},error:function(){return console.log("error logging out admin user"),console.log(arguments)}})},error:function(){var t=this;return $.ajax({url:"/_users/org.couchdb.user:admin",type:"PUT",dataType:"json",data:JSON.stringify({name:"admin",password:null,roles:[],type:"user",_id:"org.couchdb.user:admin"}),success:function(t){return Tangerine.settings.save({adminEnsured:!0}),$.couch.logout({success:function(){return e()},error:function(){return console.log("Error logging out admin user"),console.log(arguments)}})},error:function(){return console.log("Error ensuring admin _user doc"),console.log(arguments)}})}})})}}):e()},window.Tangerine.version="b6ddfae";